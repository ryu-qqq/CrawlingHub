# ============================================================
# CrawlingHub Local Development Infrastructure
# ============================================================
#
# 이 파일은 로컬 개발 환경에서 필요한 모든 인프라를 띄웁니다.
#
# 사용법:
#   docker-compose -f docker-compose.local.yml up -d
#   docker-compose -f docker-compose.local.yml down
#
# @author Claude Code
# @since 1.0.0
# ============================================================

version: '3.8'

services:
  # ==========================================================
  # MySQL Database (8.0)
  # ==========================================================
  mysql:
    image: mysql:8.0
    container_name: crawlinghub-mysql
    restart: unless-stopped

    ports:
      - "3308:3306"

    environment:
      # Root 비밀번호
      MYSQL_ROOT_PASSWORD: root_password

      # Database 생성
      MYSQL_DATABASE: crawling_hub

      # User 생성
      MYSQL_USER: crawlinghub_user
      MYSQL_PASSWORD: crawlinghub_password

      # 인코딩 설정
      MYSQL_CHARSET: utf8mb4
      MYSQL_COLLATION: utf8mb4_unicode_ci

    volumes:
      # 데이터 영속성
      - mysql_data:/var/lib/mysql

      # 초기화 스크립트 (선택사항)
      # - ./scripts/init.sql:/docker-entrypoint-initdb.d/init.sql

    command:
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
      - --default-authentication-plugin=mysql_native_password
      - --max_connections=200
      - --innodb_buffer_pool_size=1G
      - --innodb_log_file_size=256M

    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-proot_password"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ==========================================================
  # Redis (7.0)
  # ==========================================================
  redis:
    image: redis:7.0-alpine
    container_name: crawlinghub-redis
    restart: unless-stopped

    ports:
      - "6379:6379"

    command:
      - redis-server
      - --appendonly yes
      - --requirepass redis_password
      - --maxmemory 512mb
      - --maxmemory-policy allkeys-lru

    volumes:
      # 데이터 영속성
      - redis_data:/data

    healthcheck:
      test: ["CMD", "redis-cli", "-a", "redis_password", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ==========================================================
  # LocalStack (AWS 서비스 모의: SQS, EventBridge)
  # ==========================================================
  localstack:
    image: localstack/localstack:latest
    container_name: crawlinghub-localstack
    restart: unless-stopped

    ports:
      # LocalStack Gateway (모든 서비스)
      - "4566:4566"
      # Edge Port (deprecated, 호환성용)
      - "4571:4571"

    environment:
      # 활성화할 AWS 서비스
      SERVICES: sqs,events,eventbridge

      # Debug 모드
      DEBUG: 1

      # 데이터 영속성
      PERSISTENCE: 1

      # Docker 네트워크 설정
      DOCKER_HOST: unix:///var/run/docker.sock

      # 기본 리전
      DEFAULT_REGION: ap-northeast-2

      # AWS Access Key (로컬 개발용 더미 값)
      AWS_ACCESS_KEY_ID: test
      AWS_SECRET_ACCESS_KEY: test

    volumes:
      # Docker 소켓 마운트 (Lambda 등을 위해)
      - /var/run/docker.sock:/var/run/docker.sock

      # 데이터 영속성
      - localstack_data:/var/lib/localstack

      # 초기화 스크립트 (선택사항)
      # - ./scripts/localstack-init.sh:/etc/localstack/init/ready.d/init-aws.sh

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4566/_localstack/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ==========================================================
  # Redis Commander (Redis GUI, 선택사항)
  # ==========================================================
  redis-commander:
    image: rediscommander/redis-commander:latest
    container_name: crawlinghub-redis-commander
    restart: unless-stopped

    ports:
      - "8081:8081"

    environment:
      - REDIS_HOSTS=local:redis:6379:0:redis_password

    depends_on:
      - redis

  # ==========================================================
  # Adminer (MySQL GUI, 선택사항)
  # ==========================================================
  adminer:
    image: adminer:latest
    container_name: crawlinghub-adminer
    restart: unless-stopped

    ports:
      - "8082:8080"

    environment:
      ADMINER_DEFAULT_SERVER: mysql

    depends_on:
      - mysql

# ============================================================
# Volumes (데이터 영속성)
# ============================================================
volumes:
  mysql_data:
    driver: local
    name: crawlinghub-mysql-data

  redis_data:
    driver: local
    name: crawlinghub-redis-data

  localstack_data:
    driver: local
    name: crawlinghub-localstack-data

# ============================================================
# Networks (선택사항)
# ============================================================
networks:
  default:
    name: crawlinghub-network
    driver: bridge
