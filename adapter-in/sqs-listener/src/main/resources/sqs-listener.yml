# ========================================
# SQS Listener Configuration (Default/Production)
# ========================================
# Spring Cloud AWS SQS configuration
# Environment variables are injected via ECS Task Definition
# ========================================

spring:
  cloud:
    aws:
      region:
        static: ${AWS_REGION:ap-northeast-2}
      sqs:
        # SQS 리스너 기본 설정
        listener:
          max-concurrent-messages: 10
          max-messages-per-poll: 10

aws:
  sqs:
    # ========================================
    # Queue URLs (from Terraform SSM Parameters)
    # ========================================
    # CrawlTask Queue: receives tasks from aws-sqs module
    crawl-task-queue-url: ${SQS_CRAWL_TASK_QUEUE_URL:}

    # ProductImage Queue: receives image upload tasks
    product-image-queue-url: ${SQS_PRODUCT_IMAGE_QUEUE_URL:}

    # ProductSync Queue: receives external product sync tasks
    product-sync-queue-url: ${SQS_PRODUCT_SYNC_QUEUE_URL:}

    listener:
      # ========================================
      # Queue URLs (for backward compatibility)
      # ========================================
      # CrawlTask Queue: receives tasks from aws-sqs module
      crawl-task-queue-url: ${SQS_CRAWL_TASK_QUEUE_URL:}

      # EventBridge Trigger Queue: receives scheduler triggers
      event-bridge-trigger-queue-url: ${SQS_EVENTBRIDGE_TRIGGER_QUEUE_URL:}

      # ========================================
      # DLQ URLs (Dead Letter Queues)
      # ========================================
      # CrawlTask DLQ: receives failed tasks for error handling
      crawl-task-dlq-url: ${SQS_CRAWL_TASK_DLQ_URL:}

      # ProductImage DLQ: receives failed image upload tasks
      product-image-dlq-url: ${SQS_PRODUCT_IMAGE_DLQ_URL:}

      # ProductSync DLQ: receives failed sync tasks
      product-sync-dlq-url: ${SQS_PRODUCT_SYNC_DLQ_URL:}

      # EventBridge Trigger DLQ: receives failed trigger messages
      event-bridge-trigger-dlq-url: ${SQS_EVENTBRIDGE_TRIGGER_DLQ_URL:}

      # ========================================
      # Feature Toggles
      # ========================================
      # Enable/Disable individual listeners
      crawl-task-listener-enabled: true
      event-bridge-trigger-listener-enabled: true

      # Enable/Disable DLQ listeners
      # Default: false (enable only after ECS Task Definition has DLQ URL env vars)
      crawl-task-dlq-listener-enabled: false
      product-image-dlq-listener-enabled: false
      product-sync-dlq-listener-enabled: false
      event-bridge-trigger-dlq-listener-enabled: false

# ========================================
# Scheduler Configuration (Backup for EventListener failures)
# ========================================
scheduler:
  # EventListener 발행 실패 시 백업 재처리용 (기본값: true)
  image-outbox-sqs:
    enabled: ${SCHEDULER_IMAGE_OUTBOX_SQS_ENABLED:true}
    fixed-delay: 30000
  sync-outbox-sqs:
    enabled: ${SCHEDULER_SYNC_OUTBOX_SQS_ENABLED:true}
    fixed-delay: 30000

logging:
  level:
    com.ryuqq.crawlinghub.adapter.in.sqs: INFO
    io.awspring.cloud.sqs: INFO
