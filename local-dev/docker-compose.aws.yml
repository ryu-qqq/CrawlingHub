version: '3.8'
name: crawlinghub-stage

# ===============================================
# CrawlingHub - Stage 리소스 연결용 로컬 개발 환경
# ===============================================
# 사용법:
# 1. AWS SSM Session Manager로 Stage RDS 포트 포워딩
#    ./scripts/aws-port-forward-stage.sh
# 2. docker-compose -f docker-compose.aws.yml up -d
#
# 포트 포워딩:
#   - localhost:13308 -> Stage RDS (staging-shared-mysql)
#
# Redis:
#   - 로컬 Redis 컨테이너 사용 (Stage ElastiCache 접근 불필요)
#
# SQS:
#   - Stage SQS Queue 직접 연결 (AWS 자격증명 필요)
# ===============================================

services:
  # ===============================================
  # Redis (로컬 컨테이너)
  # ===============================================
  redis:
    image: redis:7-alpine
    container_name: crawlinghub-redis-stage
    ports:
      - "6379:6379"
    networks:
      - crawlinghub-network
    restart: unless-stopped

  # ===============================================
  # Web API Service
  # ===============================================
  web-api:
    build:
      context: ..
      dockerfile: bootstrap/bootstrap-web-api/Dockerfile
    container_name: crawlinghub-web-api-stage
    env_file:
      - .env.aws
    environment:
      SPRING_PROFILES_ACTIVE: stage
      SERVER_PORT: 8080
      # Database (Stage RDS via Port Forward)
      DB_HOST: host.docker.internal
      DB_PORT: 13308
      DB_NAME: ${DB_NAME:-crawler}
      DB_USER: ${DB_USER:-crawler_user}
      DB_PASSWORD: ${DB_PASSWORD}
      # Redis (로컬 컨테이너)
      REDIS_HOST: redis
      REDIS_PORT: 6379
      # EventBridge (web-api에만 설정)
      # EVENTBRIDGE_TARGET_ARN: <필요시 Stage ARN 설정>
      # EVENTBRIDGE_ROLE_ARN: <필요시 Stage ARN 설정>
      # SQS 비활성화 (web-api는 SQS 직접 발행하지 않음)
      APP_MESSAGING_SQS_ENABLED: "false"
      # Security
      SECURITY_SERVICE_TOKEN_ENABLED: "false"
      # Sentry 비활성화 (로컬)
      SENTRY_DSN: ""
      # OTEL 비활성화 (로컬)
      OTEL_AGENT_OPTS: ""
      OTEL_TRACES_EXPORTER: "none"
      OTEL_METRICS_EXPORTER: "none"
      # Logging
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    ports:
      - "8080:8080"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      - redis
    networks:
      - crawlinghub-network
    restart: unless-stopped

  # ===============================================
  # Scheduler Service
  # ===============================================
  scheduler:
    build:
      context: ..
      dockerfile: bootstrap/bootstrap-scheduler/Dockerfile
    container_name: crawlinghub-scheduler-stage
    env_file:
      - .env.aws
    environment:
      SPRING_PROFILES_ACTIVE: stage
      # Database (Stage RDS via Port Forward)
      DB_HOST: host.docker.internal
      DB_PORT: 13308
      DB_NAME: ${DB_NAME:-crawler}
      DB_USER: ${DB_USER:-crawler_user}
      DB_PASSWORD: ${DB_PASSWORD}
      # Redis (로컬 컨테이너)
      REDIS_HOST: redis
      REDIS_PORT: 6379
      # SQS Queue URLs (Stage)
      SQS_CRAWL_TASK_QUEUE_URL: ${SQS_CRAWL_TASK_QUEUE_URL}
      SQS_PRODUCT_SYNC_QUEUE_URL: ${SQS_PRODUCT_SYNC_QUEUE_URL}
      SQS_PRODUCT_IMAGE_QUEUE_URL: ${SQS_PRODUCT_IMAGE_QUEUE_URL}
      # SQS 메시징 활성화
      APP_MESSAGING_SQS_ENABLED: "true"
      # EventBridge (scheduler에 필요)
      # EVENTBRIDGE_TARGET_ARN: <필요시 Stage ARN 설정>
      # EVENTBRIDGE_ROLE_ARN: <필요시 Stage ARN 설정>
      # Security
      SECURITY_SERVICE_TOKEN_ENABLED: "false"
      # Sentry 비활성화 (로컬)
      SENTRY_DSN: ""
      # OTEL 비활성화 (로컬)
      OTEL_AGENT_OPTS: ""
      OTEL_TRACES_EXPORTER: "none"
      OTEL_METRICS_EXPORTER: "none"
      # Logging
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    ports:
      - "8081:8081"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      - redis
    networks:
      - crawlinghub-network
    restart: unless-stopped

  # ===============================================
  # Crawl Worker Service
  # ===============================================
  worker:
    build:
      context: ..
      dockerfile: bootstrap/bootstrap-crawl-worker/Dockerfile
    container_name: crawlinghub-worker-stage
    env_file:
      - .env.aws
    environment:
      SPRING_PROFILES_ACTIVE: stage
      # Database (Stage RDS via Port Forward)
      DB_HOST: host.docker.internal
      DB_PORT: 13308
      DB_NAME: ${DB_NAME:-crawler}
      DB_USER: ${DB_USER:-crawler_user}
      DB_PASSWORD: ${DB_PASSWORD}
      # Redis (로컬 컨테이너)
      REDIS_HOST: redis
      REDIS_PORT: 6379
      # SQS Queue URLs (Stage)
      SQS_CRAWL_TASK_QUEUE_URL: ${SQS_CRAWL_TASK_QUEUE_URL}
      SQS_CRAWL_TASK_DLQ_URL: ${SQS_CRAWL_TASK_DLQ_URL}
      SQS_EVENTBRIDGE_TRIGGER_QUEUE_URL: ${SQS_EVENTBRIDGE_TRIGGER_QUEUE_URL}
      SQS_PRODUCT_SYNC_QUEUE_URL: ${SQS_PRODUCT_SYNC_QUEUE_URL}
      SQS_PRODUCT_IMAGE_QUEUE_URL: ${SQS_PRODUCT_IMAGE_QUEUE_URL}
      # EventBridge 미설정 (crawl-worker는 EventBridge 불필요)
      # Security
      SECURITY_SERVICE_TOKEN_ENABLED: "false"
      # Sentry 비활성화 (로컬)
      SENTRY_DSN: ""
      # OTEL 비활성화 (로컬)
      OTEL_AGENT_OPTS: ""
      OTEL_TRACES_EXPORTER: "none"
      OTEL_METRICS_EXPORTER: "none"
      # Logging
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    ports:
      - "8082:8082"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      - redis
    networks:
      - crawlinghub-network
    restart: unless-stopped

# ===============================================
# Networks
# ===============================================
networks:
  crawlinghub-network:
    driver: bridge
