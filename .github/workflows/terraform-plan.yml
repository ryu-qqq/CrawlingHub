# ============================================================================
# CrawlingHub - Terraform Plan (Manual)
# ============================================================================
# 수동 트리거로 Terraform Plan 확인
# Atlantis가 PR 기반 IaC 변경 담당
# ============================================================================

name: Terraform Plan

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to plan'
        required: true
        default: 'prod'
        type: choice
        options:
          - prod
          - stage

permissions:
  contents: read
  pull-requests: write
  id-token: write

jobs:
  terraform-plan:
    name: Terraform Plan (${{ inputs.environment }})
    runs-on: ubuntu-latest
    timeout-minutes: 15
    strategy:
      matrix:
        module: ${{ inputs.environment == 'prod' && fromJson('[{"name":"ecr","dir":"terraform/environments/prod/ecr"},{"name":"ecs-cluster","dir":"terraform/environments/prod/ecs-cluster"},{"name":"elasticache","dir":"terraform/environments/prod/elasticache"},{"name":"sqs","dir":"terraform/environments/prod/sqs"},{"name":"ecs-web-api","dir":"terraform/environments/prod/ecs-web-api"},{"name":"ecs-scheduler","dir":"terraform/environments/prod/ecs-scheduler"},{"name":"ecs-crawl-worker","dir":"terraform/environments/prod/ecs-crawl-worker"}]') || fromJson('[{"name":"ecr","dir":"terraform/environments/stage/ecr"},{"name":"ecs-cluster","dir":"terraform/environments/stage/ecs-cluster"},{"name":"sqs","dir":"terraform/environments/stage/sqs"},{"name":"ecs-web-api","dir":"terraform/environments/stage/ecs-web-api"},{"name":"ecs-scheduler","dir":"terraform/environments/stage/ecs-scheduler"},{"name":"ecs-crawl-worker","dir":"terraform/environments/stage/ecs-crawl-worker"}]') }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        timeout-minutes: 2
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ap-northeast-2
          role-duration-seconds: 3600
          role-session-name: GitHubActions-CrawlingHub-TerraformPlan

      - name: Terraform Format Check - ${{ matrix.module.name }}
        working-directory: ${{ matrix.module.dir }}
        run: terraform fmt -check -recursive

      - name: Terraform Init - ${{ matrix.module.name }}
        working-directory: ${{ matrix.module.dir }}
        run: terraform init

      - name: Terraform Validate - ${{ matrix.module.name }}
        working-directory: ${{ matrix.module.dir }}
        run: terraform validate

      - name: Terraform Plan - ${{ matrix.module.name }}
        id: plan
        working-directory: ${{ matrix.module.dir }}
        run: |
          set +e
          terraform plan -no-color -out=tfplan
          PLAN_EXIT_CODE=$?
          terraform show -no-color tfplan > plan-${{ matrix.module.name }}.txt
          exit $PLAN_EXIT_CODE
        continue-on-error: true

      - name: Upload Plan Artifact - ${{ matrix.module.name }}
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: plan-${{ inputs.environment }}-${{ matrix.module.name }}
          path: ${{ matrix.module.dir }}/plan-${{ matrix.module.name }}.txt
          retention-days: 5
