# ============================================================================
# CrawlingHub - Terraform Apply (Production)
# ============================================================================
# Production 환경 Terraform Apply
# 기존 리소스 자동 Import + Outputs JSON Artifacts 30일 보관
# build-and-deploy.yml에서 호출 또는 수동 실행
# ============================================================================

name: Terraform Apply

on:
  push:
    branches:
      - main
    paths:
      - 'terraform/environments/prod/**'
      - '.github/workflows/terraform-apply.yml'
  workflow_dispatch:
    inputs:
      module:
        description: 'Terraform module to apply (leave empty for all)'
        required: false
        default: ''
        type: choice
        options:
          - ''
          - ecr
          - ecs-cluster
          - elasticache
          - sqs
          - ecs-web-api
          - ecs-scheduler
          - ecs-crawl-worker
  workflow_call:
    inputs:
      web-api-image-tag:
        description: 'Web API Docker image tag'
        required: false
        type: string
      scheduler-image-tag:
        description: 'Scheduler Docker image tag'
        required: false
        type: string
      crawl-worker-image-tag:
        description: 'Crawl Worker Docker image tag'
        required: false
        type: string
    secrets:
      AWS_ROLE_ARN:
        required: true

permissions:
  contents: read
  id-token: write

jobs:
  terraform-apply:
    name: Terraform Apply (prod)
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      max-parallel: 1
      matrix:
        module:
          - name: ecr
            dir: terraform/environments/prod/ecr
            order: 1
          - name: ecs-cluster
            dir: terraform/environments/prod/ecs-cluster
            order: 2
          - name: elasticache
            dir: terraform/environments/prod/elasticache
            order: 3
          - name: sqs
            dir: terraform/environments/prod/sqs
            order: 4
          - name: ecs-web-api
            dir: terraform/environments/prod/ecs-web-api
            order: 5
          - name: ecs-scheduler
            dir: terraform/environments/prod/ecs-scheduler
            order: 6
          - name: ecs-crawl-worker
            dir: terraform/environments/prod/ecs-crawl-worker
            order: 7

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ap-northeast-2
          role-duration-seconds: 3600
          role-session-name: GitHubActions-CrawlingHub-TerraformApply

      - name: Terraform Init - ${{ matrix.module.name }}
        working-directory: ${{ matrix.module.dir }}
        run: terraform init -reconfigure

      - name: Check and Import Existing Resources - ${{ matrix.module.name }}
        working-directory: ${{ matrix.module.dir }}
        run: |
          echo "Checking existing resources for ${{ matrix.module.name }}..."

          # Image Tag 변수 설정
          EXTRA_VARS=""
          if [ "${{ matrix.module.name }}" == "ecs-web-api" ] && [ -n "${{ inputs.web-api-image-tag }}" ]; then
            EXTRA_VARS="-var=image_tag=${{ inputs.web-api-image-tag }}"
          elif [ "${{ matrix.module.name }}" == "ecs-scheduler" ] && [ -n "${{ inputs.scheduler-image-tag }}" ]; then
            EXTRA_VARS="-var=image_tag=${{ inputs.scheduler-image-tag }}"
          elif [ "${{ matrix.module.name }}" == "ecs-crawl-worker" ] && [ -n "${{ inputs.crawl-worker-image-tag }}" ]; then
            EXTRA_VARS="-var=image_tag=${{ inputs.crawl-worker-image-tag }}"
          fi

          # Plan 실행하여 충돌 확인
          set +e
          terraform plan $EXTRA_VARS -out=tfplan 2>&1 | tee plan_output.txt
          PLAN_EXIT_CODE=$?
          set -e

          # "already exists" 패턴 확인
          if grep -q "EntityAlreadyExists\|already exists\|AlreadyExists" plan_output.txt; then
            echo "Existing resources found! Starting import..."

            # ECR 모듈
            if [ "${{ matrix.module.name }}" == "ecr" ]; then
              echo "Importing ECR repositories..."
              for repo_pair in "ecr_web_api:crawlinghub-web-api-prod" "ecr_scheduler:crawlinghub-scheduler-prod" "ecr_crawl_worker:crawlinghub-crawl-worker-prod"; do
                MODULE_NAME="${repo_pair%%:*}"
                REPO_NAME="${repo_pair##*:}"
                if aws ecr describe-repositories --repository-names "$REPO_NAME" --region ap-northeast-2 >/dev/null 2>&1; then
                  echo "  Importing $REPO_NAME..."
                  terraform import -input=false "module.${MODULE_NAME}.aws_ecr_repository.this[0]" "$REPO_NAME" || echo "  Import failed or already in state"
                fi
              done
            fi

            # ElastiCache 모듈
            if [ "${{ matrix.module.name }}" == "elasticache" ]; then
              echo "Importing ElastiCache resources..."
              if aws elasticache describe-cache-clusters --cache-cluster-id crawlinghub-redis-prod --region ap-northeast-2 >/dev/null 2>&1; then
                echo "  Importing crawlinghub-redis-prod..."
                terraform import -input=false aws_elasticache_cluster.redis crawlinghub-redis-prod || echo "  Import failed or already in state"
              fi
            fi

            # ECS Service 모듈 (web-api)
            if [ "${{ matrix.module.name }}" == "ecs-web-api" ]; then
              echo "Importing ECS web-api resources..."
              # IAM Execution Role
              if aws iam get-role --role-name crawlinghub-web-api-execution-role-prod >/dev/null 2>&1; then
                echo "  Importing execution role..."
                terraform import -input=false "module.ecs_task_execution_role.aws_iam_role.this[0]" crawlinghub-web-api-execution-role-prod || echo "  Import failed or already in state"
              fi
              # IAM Task Role
              if aws iam get-role --role-name crawlinghub-web-api-task-role-prod >/dev/null 2>&1; then
                echo "  Importing task role..."
                terraform import -input=false "module.ecs_task_role.aws_iam_role.this[0]" crawlinghub-web-api-task-role-prod || echo "  Import failed or already in state"
              fi
            fi

            # ECS Service 모듈 (scheduler)
            if [ "${{ matrix.module.name }}" == "ecs-scheduler" ]; then
              echo "Importing ECS scheduler resources..."
              if aws iam get-role --role-name crawlinghub-scheduler-execution-role-prod >/dev/null 2>&1; then
                echo "  Importing execution role..."
                terraform import -input=false "module.ecs_task_execution_role.aws_iam_role.this[0]" crawlinghub-scheduler-execution-role-prod || echo "  Import failed or already in state"
              fi
              if aws iam get-role --role-name crawlinghub-scheduler-task-role-prod >/dev/null 2>&1; then
                echo "  Importing task role..."
                terraform import -input=false "module.ecs_task_role.aws_iam_role.this[0]" crawlinghub-scheduler-task-role-prod || echo "  Import failed or already in state"
              fi
            fi

            # ECS Service 모듈 (crawl-worker)
            if [ "${{ matrix.module.name }}" == "ecs-crawl-worker" ]; then
              echo "Importing ECS crawl-worker resources..."
              if aws iam get-role --role-name crawlinghub-crawl-worker-execution-role-prod >/dev/null 2>&1; then
                echo "  Importing execution role..."
                terraform import -input=false "module.ecs_task_execution_role.aws_iam_role.this[0]" crawlinghub-crawl-worker-execution-role-prod || echo "  Import failed or already in state"
              fi
              if aws iam get-role --role-name crawlinghub-crawl-worker-task-role-prod >/dev/null 2>&1; then
                echo "  Importing task role..."
                terraform import -input=false "module.ecs_task_role.aws_iam_role.this[0]" crawlinghub-crawl-worker-task-role-prod || echo "  Import failed or already in state"
              fi
            fi

            echo "Import complete! Re-running plan..."
            terraform plan $EXTRA_VARS -out=tfplan
          else
            echo "No existing resource conflicts. Proceeding normally."
          fi

          rm -f plan_output.txt

      - name: Terraform Apply - ${{ matrix.module.name }}
        working-directory: ${{ matrix.module.dir }}
        run: |
          terraform apply -auto-approve -no-color tfplan
          echo "Apply completed for ${{ matrix.module.name }}"

      - name: Save Terraform Outputs - ${{ matrix.module.name }}
        working-directory: ${{ matrix.module.dir }}
        run: |
          echo "Outputs for ${{ matrix.module.name }}:"
          terraform output -json > outputs-${{ matrix.module.name }}.json
          terraform output

      - name: Upload Outputs Artifact - ${{ matrix.module.name }}
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: terraform-outputs-prod-${{ matrix.module.name }}
          path: ${{ matrix.module.dir }}/outputs-${{ matrix.module.name }}.json
          retention-days: 30

  notify-completion:
    name: Notify Completion
    needs: terraform-apply
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Create Summary
        run: |
          echo "## CrawlingHub Terraform Apply (Production)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status**: ${{ needs.terraform-apply.result }}" >> $GITHUB_STEP_SUMMARY
          echo "**Environment**: Production" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed by**: @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
