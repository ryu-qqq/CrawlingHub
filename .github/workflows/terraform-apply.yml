name: Terraform Apply

on:
  push:
    branches:
      - main
    paths:
      - 'terraform/**'
      - '.github/workflows/terraform-*.yml'
  workflow_dispatch:
    inputs:
      module:
        description: 'Terraform module to apply (leave empty for all)'
        required: false
        default: ''
        type: choice
        options:
          - ''
          - ecr
          - ecs-cluster
          - elasticache
          - ecs-web-api
          - ecs-scheduler
          - ecs-crawl-worker
          - eventbridge

permissions:
  contents: read
  id-token: write

jobs:
  terraform-apply:
    name: Terraform Apply
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      max-parallel: 1
      matrix:
        module:
          - name: ecr
            dir: terraform/ecr
            order: 1
          - name: ecs-cluster
            dir: terraform/ecs-cluster
            order: 2
          - name: elasticache
            dir: terraform/elasticache
            order: 3
          - name: ecs-web-api
            dir: terraform/ecs-web-api
            order: 4
          - name: ecs-scheduler
            dir: terraform/ecs-scheduler
            order: 5
          - name: ecs-crawl-worker
            dir: terraform/ecs-crawl-worker
            order: 6
          - name: eventbridge
            dir: terraform/eventbridge
            order: 7

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ap-northeast-2
          role-duration-seconds: 3600
          role-session-name: GitHubActions-CrawlingHub-TerraformApply

      - name: Terraform Init - ${{ matrix.module.name }}
        working-directory: ${{ matrix.module.dir }}
        run: terraform init

      - name: Check and Import Existing Resources - ${{ matrix.module.name }}
        working-directory: ${{ matrix.module.dir }}
        run: |
          echo "ðŸ” ê¸°ì¡´ ë¦¬ì†ŒìŠ¤ í™•ì¸ ë° Import ì¤‘..."

          # ECR ëª¨ë“ˆ: Plan ì „ì— ë¯¸ë¦¬ Import ì‹œë„
          if [ "${{ matrix.module.name }}" == "ecr" ]; then
            echo "ðŸ“¦ ECR Repository ì¡´ìž¬ ì—¬ë¶€ í™•ì¸ ë° Import..."

            # web-api ECR
            if aws ecr describe-repositories --repository-names crawlinghub-web-api-prod --region ap-northeast-2 >/dev/null 2>&1; then
              echo "  â†’ crawlinghub-web-api-prod ì¡´ìž¬í•¨. Import ì‹œë„..."
              terraform import -input=false 'module.ecr_web_api.aws_ecr_repository.this' crawlinghub-web-api-prod 2>/dev/null || echo "  âš ï¸  Already in state or import skipped"
            fi

            # scheduler ECR
            if aws ecr describe-repositories --repository-names crawlinghub-scheduler-prod --region ap-northeast-2 >/dev/null 2>&1; then
              echo "  â†’ crawlinghub-scheduler-prod ì¡´ìž¬í•¨. Import ì‹œë„..."
              terraform import -input=false 'module.ecr_scheduler.aws_ecr_repository.this' crawlinghub-scheduler-prod 2>/dev/null || echo "  âš ï¸  Already in state or import skipped"
            fi

            # crawl-worker ECR
            if aws ecr describe-repositories --repository-names crawlinghub-crawl-worker-prod --region ap-northeast-2 >/dev/null 2>&1; then
              echo "  â†’ crawlinghub-crawl-worker-prod ì¡´ìž¬í•¨. Import ì‹œë„..."
              terraform import -input=false 'module.ecr_crawl_worker.aws_ecr_repository.this' crawlinghub-crawl-worker-prod 2>/dev/null || echo "  âš ï¸  Already in state or import skipped"
            fi

            echo "âœ… ECR Import ì²´í¬ ì™„ë£Œ"
          fi

          # ECS-WEB-API ëª¨ë“ˆ: ê¸°ì¡´ ë¦¬ì†ŒìŠ¤ Import
          if [ "${{ matrix.module.name }}" == "ecs-web-api" ]; then
            echo "ðŸŒ ECS Web-API ê¸°ì¡´ ë¦¬ì†ŒìŠ¤ í™•ì¸ ë° Import..."

            # ALB Security Group
            ALB_SG_ID=$(aws ec2 describe-security-groups --filters "Name=group-name,Values=crawlinghub-alb-sg-prod" --query 'SecurityGroups[0].GroupId' --output text --region ap-northeast-2 2>/dev/null || echo "None")
            if [ "$ALB_SG_ID" != "None" ] && [ -n "$ALB_SG_ID" ]; then
              echo "  â†’ ALB Security Group ì¡´ìž¬í•¨ (${ALB_SG_ID}). Import ì‹œë„..."
              terraform import -input=false 'module.alb_security_group.aws_security_group.this[0]' "$ALB_SG_ID" 2>/dev/null || echo "  âš ï¸  Already in state or import skipped"
            fi

            # ECS Security Group
            ECS_SG_ID=$(aws ec2 describe-security-groups --filters "Name=group-name,Values=crawlinghub-web-api-sg-prod" --query 'SecurityGroups[0].GroupId' --output text --region ap-northeast-2 2>/dev/null || echo "None")
            if [ "$ECS_SG_ID" != "None" ] && [ -n "$ECS_SG_ID" ]; then
              echo "  â†’ ECS Security Group ì¡´ìž¬í•¨ (${ECS_SG_ID}). Import ì‹œë„..."
              terraform import -input=false 'module.ecs_security_group.aws_security_group.this[0]' "$ECS_SG_ID" 2>/dev/null || echo "  âš ï¸  Already in state or import skipped"
            fi

            # Target Group
            TG_ARN=$(aws elbv2 describe-target-groups --names crawlinghub-alb-prod-web-api --query 'TargetGroups[0].TargetGroupArn' --output text --region ap-northeast-2 2>/dev/null || echo "None")
            if [ "$TG_ARN" != "None" ] && [ -n "$TG_ARN" ]; then
              echo "  â†’ Target Group ì¡´ìž¬í•¨. Import ì‹œë„..."
              terraform import -input=false 'module.alb.aws_lb_target_group.this["web-api"]' "$TG_ARN" 2>/dev/null || echo "  âš ï¸  Already in state or import skipped"
            fi

            # ALB
            ALB_ARN=$(aws elbv2 describe-load-balancers --names crawlinghub-alb-prod --query 'LoadBalancers[0].LoadBalancerArn' --output text --region ap-northeast-2 2>/dev/null || echo "None")
            if [ "$ALB_ARN" != "None" ] && [ -n "$ALB_ARN" ]; then
              echo "  â†’ ALB ì¡´ìž¬í•¨. Import ì‹œë„..."
              terraform import -input=false 'module.alb.aws_lb.this[0]' "$ALB_ARN" 2>/dev/null || echo "  âš ï¸  Already in state or import skipped"

              # HTTPS Listener
              HTTPS_LISTENER_ARN=$(aws elbv2 describe-listeners --load-balancer-arn "$ALB_ARN" --query 'Listeners[?Port==`443`].ListenerArn' --output text --region ap-northeast-2 2>/dev/null || echo "None")
              if [ "$HTTPS_LISTENER_ARN" != "None" ] && [ -n "$HTTPS_LISTENER_ARN" ]; then
                echo "  â†’ HTTPS Listener ì¡´ìž¬í•¨. Import ì‹œë„..."
                terraform import -input=false 'module.alb.aws_lb_listener.https["https"]' "$HTTPS_LISTENER_ARN" 2>/dev/null || echo "  âš ï¸  Already in state or import skipped"
              fi

              # HTTP Listener
              HTTP_LISTENER_ARN=$(aws elbv2 describe-listeners --load-balancer-arn "$ALB_ARN" --query 'Listeners[?Port==`80`].ListenerArn' --output text --region ap-northeast-2 2>/dev/null || echo "None")
              if [ "$HTTP_LISTENER_ARN" != "None" ] && [ -n "$HTTP_LISTENER_ARN" ]; then
                echo "  â†’ HTTP Listener ì¡´ìž¬í•¨. Import ì‹œë„..."
                terraform import -input=false 'module.alb.aws_lb_listener.http["http-redirect"]' "$HTTP_LISTENER_ARN" 2>/dev/null || echo "  âš ï¸  Already in state or import skipped"
              fi
            fi

            # IAM Roles
            if aws iam get-role --role-name crawlinghub-web-api-execution-role-prod >/dev/null 2>&1; then
              echo "  â†’ Execution Role ì¡´ìž¬í•¨. Import ì‹œë„..."
              terraform import -input=false 'module.ecs_task_execution_role.aws_iam_role.this[0]' crawlinghub-web-api-execution-role-prod 2>/dev/null || echo "  âš ï¸  Already in state or import skipped"
            fi

            if aws iam get-role --role-name crawlinghub-web-api-task-role-prod >/dev/null 2>&1; then
              echo "  â†’ Task Role ì¡´ìž¬í•¨. Import ì‹œë„..."
              terraform import -input=false 'module.ecs_task_role.aws_iam_role.this[0]' crawlinghub-web-api-task-role-prod 2>/dev/null || echo "  âš ï¸  Already in state or import skipped"
            fi

            # CloudWatch Log Group
            if aws logs describe-log-groups --log-group-name-prefix "/aws/ecs/crawlinghub-web-api-prod/application" --query 'logGroups[0].logGroupName' --output text --region ap-northeast-2 2>/dev/null | grep -q "crawlinghub-web-api-prod"; then
              echo "  â†’ CloudWatch Log Group ì¡´ìž¬í•¨. Import ì‹œë„..."
              terraform import -input=false 'module.web_api_logs.aws_cloudwatch_log_group.this[0]' "/aws/ecs/crawlinghub-web-api-prod/application" 2>/dev/null || echo "  âš ï¸  Already in state or import skipped"
            fi

            # ECS Service
            if aws ecs describe-services --cluster crawlinghub-cluster-prod --services crawlinghub-web-api-prod --query 'services[0].serviceName' --output text --region ap-northeast-2 2>/dev/null | grep -q "crawlinghub-web-api-prod"; then
              echo "  â†’ ECS Service ì¡´ìž¬í•¨. Import ì‹œë„..."
              terraform import -input=false 'aws_ecs_service.web_api' "crawlinghub-cluster-prod/crawlinghub-web-api-prod" 2>/dev/null || echo "  âš ï¸  Already in state or import skipped"
            fi

            # Route53 Record
            ZONE_ID=$(aws route53 list-hosted-zones-by-name --dns-name "set-of.com" --query 'HostedZones[0].Id' --output text 2>/dev/null | sed 's|/hostedzone/||')
            if [ -n "$ZONE_ID" ] && [ "$ZONE_ID" != "None" ]; then
              if aws route53 list-resource-record-sets --hosted-zone-id "$ZONE_ID" --query "ResourceRecordSets[?Name=='crawler.set-of.com.']" --output text 2>/dev/null | grep -q "crawler.set-of.com"; then
                echo "  â†’ Route53 Record ì¡´ìž¬í•¨. Import ì‹œë„..."
                terraform import -input=false 'aws_route53_record.web_api' "${ZONE_ID}_crawler.set-of.com_A" 2>/dev/null || echo "  âš ï¸  Already in state or import skipped"
              fi
            fi

            echo "âœ… ECS Web-API Import ì²´í¬ ì™„ë£Œ"
          fi

          # ECS-SCHEDULER ëª¨ë“ˆ: ê¸°ì¡´ ë¦¬ì†ŒìŠ¤ Import
          if [ "${{ matrix.module.name }}" == "ecs-scheduler" ]; then
            echo "â° ECS Scheduler ê¸°ì¡´ ë¦¬ì†ŒìŠ¤ í™•ì¸ ë° Import..."

            # Scheduler Security Group
            SCHEDULER_SG_ID=$(aws ec2 describe-security-groups --filters "Name=group-name,Values=crawlinghub-scheduler-sg-prod" --query 'SecurityGroups[0].GroupId' --output text --region ap-northeast-2 2>/dev/null || echo "None")
            if [ "$SCHEDULER_SG_ID" != "None" ] && [ -n "$SCHEDULER_SG_ID" ]; then
              echo "  â†’ Scheduler Security Group ì¡´ìž¬í•¨ (${SCHEDULER_SG_ID}). Import ì‹œë„..."
              terraform import -input=false 'module.ecs_security_group.aws_security_group.this[0]' "$SCHEDULER_SG_ID" 2>/dev/null || echo "  âš ï¸  Already in state or import skipped"
            fi

            # IAM Roles
            if aws iam get-role --role-name crawlinghub-scheduler-execution-role-prod >/dev/null 2>&1; then
              echo "  â†’ Scheduler Execution Role ì¡´ìž¬í•¨. Import ì‹œë„..."
              terraform import -input=false 'module.scheduler_task_execution_role.aws_iam_role.this[0]' crawlinghub-scheduler-execution-role-prod 2>/dev/null || echo "  âš ï¸  Already in state or import skipped"
            fi

            if aws iam get-role --role-name crawlinghub-scheduler-task-role-prod >/dev/null 2>&1; then
              echo "  â†’ Scheduler Task Role ì¡´ìž¬í•¨. Import ì‹œë„..."
              terraform import -input=false 'module.scheduler_task_role.aws_iam_role.this[0]' crawlinghub-scheduler-task-role-prod 2>/dev/null || echo "  âš ï¸  Already in state or import skipped"
            fi

            # CloudWatch Log Group
            if aws logs describe-log-groups --log-group-name-prefix "/aws/ecs/crawlinghub-scheduler-prod/application" --query 'logGroups[0].logGroupName' --output text --region ap-northeast-2 2>/dev/null | grep -q "crawlinghub-scheduler-prod"; then
              echo "  â†’ CloudWatch Log Group ì¡´ìž¬í•¨. Import ì‹œë„..."
              terraform import -input=false 'module.scheduler_logs.aws_cloudwatch_log_group.this[0]' "/aws/ecs/crawlinghub-scheduler-prod/application" 2>/dev/null || echo "  âš ï¸  Already in state or import skipped"
            fi

            # ECS Service
            if aws ecs describe-services --cluster crawlinghub-cluster-prod --services crawlinghub-scheduler-prod --query 'services[0].serviceName' --output text --region ap-northeast-2 2>/dev/null | grep -q "crawlinghub-scheduler-prod"; then
              echo "  â†’ ECS Scheduler Service ì¡´ìž¬í•¨. Import ì‹œë„..."
              terraform import -input=false 'aws_ecs_service.scheduler' "crawlinghub-cluster-prod/crawlinghub-scheduler-prod" 2>/dev/null || echo "  âš ï¸  Already in state or import skipped"
            fi

            echo "âœ… ECS Scheduler Import ì²´í¬ ì™„ë£Œ"
          fi

          # ECS-CRAWL-WORKER ëª¨ë“ˆ: ê¸°ì¡´ ë¦¬ì†ŒìŠ¤ Import
          if [ "${{ matrix.module.name }}" == "ecs-crawl-worker" ]; then
            echo "ðŸ•·ï¸ ECS Crawl-Worker ê¸°ì¡´ ë¦¬ì†ŒìŠ¤ í™•ì¸ ë° Import..."

            # Crawl-Worker Security Group
            WORKER_SG_ID=$(aws ec2 describe-security-groups --filters "Name=group-name,Values=crawlinghub-crawl-worker-sg-prod" --query 'SecurityGroups[0].GroupId' --output text --region ap-northeast-2 2>/dev/null || echo "None")
            if [ "$WORKER_SG_ID" != "None" ] && [ -n "$WORKER_SG_ID" ]; then
              echo "  â†’ Crawl-Worker Security Group ì¡´ìž¬í•¨ (${WORKER_SG_ID}). Import ì‹œë„..."
              terraform import -input=false 'module.ecs_security_group.aws_security_group.this[0]' "$WORKER_SG_ID" 2>/dev/null || echo "  âš ï¸  Already in state or import skipped"
            fi

            # IAM Roles
            if aws iam get-role --role-name crawlinghub-crawl-worker-execution-role-prod >/dev/null 2>&1; then
              echo "  â†’ Crawl-Worker Execution Role ì¡´ìž¬í•¨. Import ì‹œë„..."
              terraform import -input=false 'module.crawl_worker_task_execution_role.aws_iam_role.this[0]' crawlinghub-crawl-worker-execution-role-prod 2>/dev/null || echo "  âš ï¸  Already in state or import skipped"
            fi

            if aws iam get-role --role-name crawlinghub-crawl-worker-task-role-prod >/dev/null 2>&1; then
              echo "  â†’ Crawl-Worker Task Role ì¡´ìž¬í•¨. Import ì‹œë„..."
              terraform import -input=false 'module.crawl_worker_task_role.aws_iam_role.this[0]' crawlinghub-crawl-worker-task-role-prod 2>/dev/null || echo "  âš ï¸  Already in state or import skipped"
            fi

            # CloudWatch Log Group
            if aws logs describe-log-groups --log-group-name-prefix "/aws/ecs/crawlinghub-crawl-worker-prod/application" --query 'logGroups[0].logGroupName' --output text --region ap-northeast-2 2>/dev/null | grep -q "crawlinghub-crawl-worker-prod"; then
              echo "  â†’ CloudWatch Log Group ì¡´ìž¬í•¨. Import ì‹œë„..."
              terraform import -input=false 'module.crawl_worker_logs.aws_cloudwatch_log_group.this[0]' "/aws/ecs/crawlinghub-crawl-worker-prod/application" 2>/dev/null || echo "  âš ï¸  Already in state or import skipped"
            fi

            # ECS Service
            if aws ecs describe-services --cluster crawlinghub-cluster-prod --services crawlinghub-crawl-worker-prod --query 'services[0].serviceName' --output text --region ap-northeast-2 2>/dev/null | grep -q "crawlinghub-crawl-worker-prod"; then
              echo "  â†’ ECS Crawl-Worker Service ì¡´ìž¬í•¨. Import ì‹œë„..."
              terraform import -input=false 'aws_ecs_service.crawl_worker' "crawlinghub-cluster-prod/crawlinghub-crawl-worker-prod" 2>/dev/null || echo "  âš ï¸  Already in state or import skipped"
            fi

            echo "âœ… ECS Crawl-Worker Import ì²´í¬ ì™„ë£Œ"
          fi

          # Plan ì‹¤í–‰
          echo "ðŸ“‹ Terraform Plan ì‹¤í–‰ ì¤‘..."
          terraform plan -out=tfplan

      - name: Terraform Apply - ${{ matrix.module.name }}
        working-directory: ${{ matrix.module.dir }}
        run: |
          echo "ðŸš€ Applying Terraform for ${{ matrix.module.name }}..."
          terraform apply -auto-approve -no-color tfplan
          echo "âœ… Apply completed for ${{ matrix.module.name }}"

      - name: Terraform Output - ${{ matrix.module.name }}
        working-directory: ${{ matrix.module.dir }}
        run: |
          echo "ðŸ“‹ Outputs for ${{ matrix.module.name }}:"
          terraform output -json > outputs-${{ matrix.module.name }}.json
          terraform output

      - name: Upload Apply Results - ${{ matrix.module.name }}
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: apply-results-${{ matrix.module.name }}
          path: ${{ matrix.module.dir }}/outputs-${{ matrix.module.name }}.json
          retention-days: 30

  notify-completion:
    name: Notify Deployment Completion
    needs: terraform-apply
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Create Deployment Summary
        run: |
          echo "## ðŸŽ‰ CrawlingHub Infrastructure Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status**: ${{ needs.terraform-apply.result }}" >> $GITHUB_STEP_SUMMARY
          echo "**Environment**: Production" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed by**: @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Modules Deployed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ECR Repositories (web-api, scheduler, crawl-worker)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ECS Cluster" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ElastiCache Redis" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ECS Service: web-api" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ECS Service: scheduler" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next Steps**:" >> $GITHUB_STEP_SUMMARY
          echo "1. Verify infrastructure in AWS Console" >> $GITHUB_STEP_SUMMARY
          echo "2. Check CloudWatch logs" >> $GITHUB_STEP_SUMMARY
          echo "3. Test application endpoints" >> $GITHUB_STEP_SUMMARY
