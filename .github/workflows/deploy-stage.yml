# ============================================================================
# CrawlingHub - Deploy Stage
# ============================================================================
# Stage 환경 배포 (path-filter 기반 선택적 빌드)
# shared 카테고리로 공통 레이어 변경 감지
# stage 브랜치 push 또는 수동 트리거
# ============================================================================

name: Deploy Stage

on:
  push:
    branches:
      - stage
    paths-ignore:
      - 'terraform/**'
      - '.github/workflows/terraform-*.yml'
      - '**.md'
      - 'docs/**'
      - 'atlantis.yaml'
  workflow_dispatch:
    inputs:
      force-all:
        description: 'Force build all components'
        required: false
        default: false
        type: boolean

permissions:
  contents: read
  id-token: write

env:
  AWS_REGION: ap-northeast-2
  ECS_CLUSTER: crawlinghub-cluster-stage

jobs:
  # ============================================================================
  # 변경 감지 (Path Filter - shared 카테고리 포함)
  # ============================================================================
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      shared: ${{ steps.filter.outputs.shared }}
      web-api: ${{ steps.filter.outputs.web-api }}
      scheduler: ${{ steps.filter.outputs.scheduler }}
      crawl-worker: ${{ steps.filter.outputs.crawl-worker }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Detect changed paths
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            shared:
              - 'gradle/**'
              - 'build.gradle'
              - 'settings.gradle'
              - 'domain/**'
              - 'application/**'
              - 'adapter-out/**'
            web-api:
              - 'adapter-in/rest-api/**'
              - 'bootstrap/bootstrap-web-api/**'
            scheduler:
              - 'adapter-in/scheduler/**'
              - 'bootstrap/bootstrap-scheduler/**'
            crawl-worker:
              - 'adapter-in/sqs-consumer/**'
              - 'bootstrap/bootstrap-crawl-worker/**'

  # ============================================================================
  # 테스트 (공통)
  # ============================================================================
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Run tests
        run: |
          chmod +x gradlew
          ./gradlew clean test -x jacocoTestCoverageVerification --no-daemon

  # ============================================================================
  # 빌드 Jobs (선택적 실행 - shared 변경 시 전체 빌드)
  # ============================================================================
  build-web-api:
    name: Build web-api (stage)
    needs: [test, detect-changes]
    if: ${{ needs.detect-changes.outputs.shared == 'true' || needs.detect-changes.outputs.web-api == 'true' || inputs.force-all == true }}
    uses: ryu-qqq/Infrastructure/.github/workflows/reusable-build-docker.yml@main
    with:
      ecr-repository: crawlinghub-web-api-stage
      component: web-api-stage
      dockerfile: bootstrap/bootstrap-web-api/Dockerfile
      gradle-task: ":bootstrap:bootstrap-web-api:bootJar"
      timeout-minutes: 30
    secrets:
      AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN }}

  build-scheduler:
    name: Build scheduler (stage)
    needs: [test, detect-changes]
    if: ${{ needs.detect-changes.outputs.shared == 'true' || needs.detect-changes.outputs.scheduler == 'true' || inputs.force-all == true }}
    uses: ryu-qqq/Infrastructure/.github/workflows/reusable-build-docker.yml@main
    with:
      ecr-repository: crawlinghub-scheduler-stage
      component: scheduler-stage
      dockerfile: bootstrap/bootstrap-scheduler/Dockerfile
      gradle-task: ":bootstrap:bootstrap-scheduler:bootJar"
      timeout-minutes: 30
    secrets:
      AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN }}

  build-crawl-worker:
    name: Build crawl-worker (stage)
    needs: [test, detect-changes]
    if: ${{ needs.detect-changes.outputs.shared == 'true' || needs.detect-changes.outputs.crawl-worker == 'true' || inputs.force-all == true }}
    uses: ryu-qqq/Infrastructure/.github/workflows/reusable-build-docker.yml@main
    with:
      ecr-repository: crawlinghub-crawl-worker-stage
      component: crawl-worker-stage
      dockerfile: bootstrap/bootstrap-crawl-worker/Dockerfile
      gradle-task: ":bootstrap:bootstrap-crawl-worker:bootJar"
      timeout-minutes: 30
    secrets:
      AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN }}

  # ============================================================================
  # 배포 Jobs (선택적 실행)
  # ============================================================================
  deploy-web-api:
    name: Deploy web-api (stage)
    needs: build-web-api
    if: ${{ needs.build-web-api.result == 'success' }}
    uses: ryu-qqq/Infrastructure/.github/workflows/reusable-deploy-ecs.yml@main
    with:
      ecs-cluster: crawlinghub-cluster-stage
      ecs-service: crawlinghub-web-api-stage
      image-uri: ${{ needs.build-web-api.outputs.image-uri }}
    secrets:
      AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN }}

  deploy-scheduler:
    name: Deploy scheduler (stage)
    needs: build-scheduler
    if: ${{ needs.build-scheduler.result == 'success' }}
    uses: ryu-qqq/Infrastructure/.github/workflows/reusable-deploy-ecs.yml@main
    with:
      ecs-cluster: crawlinghub-cluster-stage
      ecs-service: crawlinghub-scheduler-stage
      image-uri: ${{ needs.build-scheduler.outputs.image-uri }}
    secrets:
      AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN }}

  deploy-crawl-worker:
    name: Deploy crawl-worker (stage)
    needs: build-crawl-worker
    if: ${{ needs.build-crawl-worker.result == 'success' }}
    uses: ryu-qqq/Infrastructure/.github/workflows/reusable-deploy-ecs.yml@main
    with:
      ecs-cluster: crawlinghub-cluster-stage
      ecs-service: crawlinghub-crawl-worker-stage
      image-uri: ${{ needs.build-crawl-worker.outputs.image-uri }}
    secrets:
      AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN }}

  # ============================================================================
  # Terraform Image Tag 업데이트 (stage)
  # ============================================================================
  update-terraform-tags:
    name: Update Terraform Tags (stage)
    needs: [build-web-api, build-scheduler, build-crawl-worker]
    if: always() && (needs.build-web-api.result == 'success' || needs.build-scheduler.result == 'success' || needs.build-crawl-worker.result == 'success')
    uses: ./.github/workflows/terraform-apply-stage.yml
    with:
      web-api-image-tag: ${{ needs.build-web-api.outputs.image-tag || '' }}
      scheduler-image-tag: ${{ needs.build-scheduler.outputs.image-tag || '' }}
      crawl-worker-image-tag: ${{ needs.build-crawl-worker.outputs.image-tag || '' }}
    secrets:
      AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN }}
