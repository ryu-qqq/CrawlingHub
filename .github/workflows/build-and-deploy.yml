name: Build and Deploy to ECS

on:
  push:
    branches:
      - main
    paths-ignore:
      - 'terraform/**'
      - '.github/workflows/terraform-*.yml'
      - '**.md'
      - 'docs/**'

permissions:
  contents: read
  id-token: write

env:
  AWS_REGION: ap-northeast-2
  ECS_CLUSTER: crawlinghub-cluster-prod

jobs:
  build-and-push:
    name: Build and Push Docker Images
    runs-on: ubuntu-latest
    timeout-minutes: 30
    outputs:
      web-api-image-tag: ${{ steps.image-tag.outputs.tag }}
      web-api-image-uri: ${{ steps.build-web-api.outputs.image }}
      scheduler-image-uri: ${{ steps.build-scheduler.outputs.image }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Run tests
        run: |
          echo "ðŸ§ª Running tests..."
          ./gradlew clean test -x jacocoTestCoverageVerification --no-daemon --stacktrace
          echo "âœ… Tests completed"

      - name: Build web-api JAR
        run: |
          echo "ðŸ”¨ Building web-api..."
          ./gradlew :bootstrap:bootstrap-web-api:bootJar -x test --no-daemon --stacktrace
          echo "âœ… web-api build completed"
          ls -lh bootstrap/bootstrap-web-api/build/libs/

      - name: Build scheduler JAR
        run: |
          echo "ðŸ”¨ Building scheduler..."
          ./gradlew :bootstrap:bootstrap-scheduler:bootJar -x test --no-daemon --stacktrace
          echo "âœ… scheduler build completed"
          ls -lh bootstrap/bootstrap-scheduler/build/libs/

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-duration-seconds: 3600
          role-session-name: GitHubActions-CrawlingHub-Build

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Generate image tag
        id: image-tag
        run: |
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          TAG="${{ github.run_number }}-${SHORT_SHA}"
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Image tag: ${TAG}"

      - name: Build and push web-api Docker image
        id: build-web-api
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ steps.image-tag.outputs.tag }}
        run: |
          echo "ðŸ³ Building web-api Docker image..."
          ECR_REPOSITORY="crawlinghub-web-api-prod"
          IMAGE_URI="${ECR_REGISTRY}/${ECR_REPOSITORY}:${IMAGE_TAG}"

          docker build \
            -f bootstrap/bootstrap-web-api/Dockerfile \
            -t ${IMAGE_URI} \
            --build-arg JAR_FILE=bootstrap/bootstrap-web-api/build/libs/crawlinghub-web-api.jar \
            .
          docker tag ${IMAGE_URI} ${ECR_REGISTRY}/${ECR_REPOSITORY}:latest

          echo "ðŸ“¤ Pushing web-api to ECR..."
          docker push ${IMAGE_URI}
          docker push ${ECR_REGISTRY}/${ECR_REPOSITORY}:latest

          echo "image=${IMAGE_URI}" >> $GITHUB_OUTPUT
          echo "âœ… web-api image pushed: ${IMAGE_URI}"

      - name: Build and push scheduler Docker image
        id: build-scheduler
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ steps.image-tag.outputs.tag }}
        run: |
          echo "ðŸ³ Building scheduler Docker image..."
          ECR_REPOSITORY="crawlinghub-scheduler-prod"
          IMAGE_URI="${ECR_REGISTRY}/${ECR_REPOSITORY}:${IMAGE_TAG}"

          docker build \
            -f bootstrap/bootstrap-scheduler/Dockerfile \
            -t ${IMAGE_URI} \
            --build-arg JAR_FILE=bootstrap/bootstrap-scheduler/build/libs/crawlinghub-scheduler.jar \
            .
          docker tag ${IMAGE_URI} ${ECR_REGISTRY}/${ECR_REPOSITORY}:latest

          echo "ðŸ“¤ Pushing scheduler to ECR..."
          docker push ${IMAGE_URI}
          docker push ${ECR_REGISTRY}/${ECR_REPOSITORY}:latest

          echo "image=${IMAGE_URI}" >> $GITHUB_OUTPUT
          echo "âœ… scheduler image pushed: ${IMAGE_URI}"

  deploy-web-api:
    name: Deploy web-api to ECS
    needs: build-and-push
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-duration-seconds: 3600
          role-session-name: GitHubActions-CrawlingHub-Deploy-WebApi

      - name: Get current task definition
        id: get-task-def
        run: |
          ECS_SERVICE="crawlinghub-web-api-prod"
          echo "ðŸ“‹ Fetching current task definition for ${ECS_SERVICE}..."
          TASK_DEF_ARN=$(aws ecs describe-services \
            --cluster ${ECS_CLUSTER} \
            --services ${ECS_SERVICE} \
            --query 'services[0].taskDefinition' \
            --output text)

          aws ecs describe-task-definition \
            --task-definition ${TASK_DEF_ARN} \
            --query 'taskDefinition' > task-definition.json

          echo "âœ… Task definition retrieved"

      - name: Update task definition with new image
        run: |
          echo "ðŸ”„ Updating task definition..."

          cat task-definition.json | \
            jq --arg IMAGE "${{ needs.build-and-push.outputs.web-api-image-uri }}" \
               '.containerDefinitions[0].image = $IMAGE' | \
            jq 'del(.taskDefinitionArn, .revision, .status, .requiresAttributes, .compatibilities, .registeredAt, .registeredBy)' \
            > new-task-definition.json

          echo "âœ… Task definition updated with image: ${{ needs.build-and-push.outputs.web-api-image-uri }}"

      - name: Register new task definition
        id: register-task-def
        run: |
          echo "ðŸ“ Registering new task definition..."

          NEW_TASK_DEF_ARN=$(aws ecs register-task-definition \
            --cli-input-json file://new-task-definition.json \
            --query 'taskDefinition.taskDefinitionArn' \
            --output text)

          echo "task-def-arn=${NEW_TASK_DEF_ARN}" >> $GITHUB_OUTPUT
          echo "âœ… New task definition registered: ${NEW_TASK_DEF_ARN}"

      - name: Update ECS service
        run: |
          ECS_SERVICE="crawlinghub-web-api-prod"
          echo "ðŸš€ Updating ECS service ${ECS_SERVICE}..."

          aws ecs update-service \
            --cluster ${ECS_CLUSTER} \
            --service ${ECS_SERVICE} \
            --task-definition ${{ steps.register-task-def.outputs.task-def-arn }} \
            --force-new-deployment \
            --no-cli-pager

          echo "âœ… ECS service update initiated"

      - name: Wait for service stability
        run: |
          ECS_SERVICE="crawlinghub-web-api-prod"
          echo "â³ Waiting for ${ECS_SERVICE} to become stable..."

          aws ecs wait services-stable \
            --cluster ${ECS_CLUSTER} \
            --services ${ECS_SERVICE}

          echo "âœ… Service is now stable"

  deploy-scheduler:
    name: Deploy scheduler to ECS
    needs: build-and-push
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-duration-seconds: 3600
          role-session-name: GitHubActions-CrawlingHub-Deploy-Scheduler

      - name: Get current task definition
        id: get-task-def
        run: |
          ECS_SERVICE="crawlinghub-scheduler-prod"
          echo "ðŸ“‹ Fetching current task definition for ${ECS_SERVICE}..."
          TASK_DEF_ARN=$(aws ecs describe-services \
            --cluster ${ECS_CLUSTER} \
            --services ${ECS_SERVICE} \
            --query 'services[0].taskDefinition' \
            --output text)

          aws ecs describe-task-definition \
            --task-definition ${TASK_DEF_ARN} \
            --query 'taskDefinition' > task-definition.json

          echo "âœ… Task definition retrieved"

      - name: Update task definition with new image
        run: |
          echo "ðŸ”„ Updating task definition..."

          cat task-definition.json | \
            jq --arg IMAGE "${{ needs.build-and-push.outputs.scheduler-image-uri }}" \
               '.containerDefinitions[0].image = $IMAGE' | \
            jq 'del(.taskDefinitionArn, .revision, .status, .requiresAttributes, .compatibilities, .registeredAt, .registeredBy)' \
            > new-task-definition.json

          echo "âœ… Task definition updated with image: ${{ needs.build-and-push.outputs.scheduler-image-uri }}"

      - name: Register new task definition
        id: register-task-def
        run: |
          echo "ðŸ“ Registering new task definition..."

          NEW_TASK_DEF_ARN=$(aws ecs register-task-definition \
            --cli-input-json file://new-task-definition.json \
            --query 'taskDefinition.taskDefinitionArn' \
            --output text)

          echo "task-def-arn=${NEW_TASK_DEF_ARN}" >> $GITHUB_OUTPUT
          echo "âœ… New task definition registered: ${NEW_TASK_DEF_ARN}"

      - name: Update ECS service
        run: |
          ECS_SERVICE="crawlinghub-scheduler-prod"
          echo "ðŸš€ Updating ECS service ${ECS_SERVICE}..."

          aws ecs update-service \
            --cluster ${ECS_CLUSTER} \
            --service ${ECS_SERVICE} \
            --task-definition ${{ steps.register-task-def.outputs.task-def-arn }} \
            --force-new-deployment \
            --no-cli-pager

          echo "âœ… ECS service update initiated"

      - name: Wait for service stability
        run: |
          ECS_SERVICE="crawlinghub-scheduler-prod"
          echo "â³ Waiting for ${ECS_SERVICE} to become stable..."

          aws ecs wait services-stable \
            --cluster ${ECS_CLUSTER} \
            --services ${ECS_SERVICE}

          echo "âœ… Service is now stable"

  notify-completion:
    name: Notify Deployment Completion
    needs: [build-and-push, deploy-web-api, deploy-scheduler]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Create Deployment Summary
        run: |
          echo "## ðŸš€ CrawlingHub Application Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Build Status**: ${{ needs.build-and-push.result }}" >> $GITHUB_STEP_SUMMARY
          echo "**web-api Deploy**: ${{ needs.deploy-web-api.result }}" >> $GITHUB_STEP_SUMMARY
          echo "**scheduler Deploy**: ${{ needs.deploy-scheduler.result }}" >> $GITHUB_STEP_SUMMARY
          echo "**Environment**: Production" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed by**: @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Image Tag**: ${{ needs.build-and-push.outputs.web-api-image-tag }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Deployed Images" >> $GITHUB_STEP_SUMMARY
          echo "- **web-api**: \`${{ needs.build-and-push.outputs.web-api-image-uri }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **scheduler**: \`${{ needs.build-and-push.outputs.scheduler-image-uri }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… Deployment Steps" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Tests executed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… web-api JAR built" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… scheduler JAR built" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Docker images built and pushed to ECR" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ECS services deployed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next Steps**:" >> $GITHUB_STEP_SUMMARY
          echo "1. Check CloudWatch logs for application startup" >> $GITHUB_STEP_SUMMARY
          echo "2. Verify health check: https://crawler.set-of.com/actuator/health" >> $GITHUB_STEP_SUMMARY
          echo "3. Test API endpoints" >> $GITHUB_STEP_SUMMARY
          echo "4. Monitor CloudWatch metrics" >> $GITHUB_STEP_SUMMARY
