<!-- Generated by SpecStory, Markdown v2.0.0 -->

<!-- cursor Session 7f878d43-9483-4275-b83f-58cf5c8427f3 (2025-11-06 15:13Z) -->

# Implement phase 1 of product change tracking (2025-11-06 15:13Z)

_**User (2025-11-06 15:56Z)**_

claudedocs/product-change-tracking-system-design.md 문서를 읽고,

  Phase 1부터 순서대로 구현해줘. 모든 코드는 문서에 있는 그대로 작성하고,

  Zero-Tolerance 규칙을 준수해줘.

---

_**Agent (model default, mode Agent)**_



---


문서를 읽고 Phase 1부터 순서대로 구현합니다.


---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: claudedocs/product-change-tracking-system-design.md</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="generic" data-tool-name="list_dir">
<details>
            <summary>Tool use: **list_directory** • Listed directory undefined • **0** results</summary>
        
No results found
</details>
</tool-use>

---



---


프로젝트 구조를 확인하고 Phase 1부터 구현을 시작합니다.


---

<tool-use data-tool-type="generic" data-tool-name="list_dir">
<details>
            <summary>Tool use: **list_directory** • Listed directory undefined • **0** results</summary>
        
No results found
</details>
</tool-use>

---

<tool-use data-tool-type="search" data-tool-name="codebase_search">

</tool-use>

---

<tool-use data-tool-type="grep" data-tool-name="grep">
<details>
<summary>Tool use: **grep** • Grep for "package com\.ryuqq\.crawlinghub\.domain" in "domain/src/main/java" • 10 matches</summary>

Output mode: files_with_matches


| File |
|------|
| `domain/src/main/java/com/ryuqq/crawlinghub/domain/task/Task.java` |
| `domain/src/main/java/com/ryuqq/crawlinghub/domain/product/CrawledProduct.java` |
| `domain/src/main/java/com/ryuqq/crawlinghub/domain/useragent/UserAgent.java` |
| `domain/src/main/java/com/ryuqq/crawlinghub/domain/useragent/exception/UserAgentException.java` |
| `domain/src/main/java/com/ryuqq/crawlinghub/domain/useragent/exception/NoAvailableUserAgentException.java` |
| `domain/src/main/java/com/ryuqq/crawlinghub/domain/useragent/exception/TokenExpiredException.java` |
| `domain/src/main/java/com/ryuqq/crawlinghub/domain/useragent/exception/RateLimitExceededException.java` |
| `domain/src/main/java/com/ryuqq/crawlinghub/domain/useragent/exception/InvalidUserAgentException.java` |
| `domain/src/main/java/com/ryuqq/crawlinghub/domain/useragent/exception/UserAgentErrorCode.java` |
| `domain/src/main/java/com/ryuqq/crawlinghub/domain/token/TokenAcquisitionException.java` |


</details>
</tool-use>

---



---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: domain/src/main/java/com/ryuqq/crawlinghub/domain/seller/MustitSellerId.java</summary>

</details>
</tool-use>

---





---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: domain/src/main/java/com/ryuqq/crawlinghub/domain/product/ProductId.java</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="generic" data-tool-name="todo_write">
<details><summary>Tool use: **todo_write** • Todo List</summary>

- [-] Phase 1-1: ProductSnapshot Domain (Aggregate Root) 및 Value Objects 구현
- [ ] Phase 1-2: ProductChangeEvent (Domain Event) 및 보조 타입 구현
- [ ] Phase 1-3: ProductSyncOutbox Domain (Aggregate Root) 및 보조 타입 구현
- [ ] Phase 1-4: 모든 Value Objects 검증 및 완료

</details>
</tool-use>

---



---


Phase 1 구현 시작. Value Objects부터 생성합니다.


---

<tool-use data-tool-type="write" data-tool-name="write">

<details><summary>Tool use: **code_edit** • Edit file: domain/src/main/java/com/ryuqq/crawlinghub/domain/product/ProductSnapshotId.java</summary>

**Chunk 1**
Lines added: 20, lines removed: 1

```diff
@@ -1,1 +1,20 @@
- 
+ package com.ryuqq.crawlinghub.domain.product;
+ 
+ /**
+  * ProductSnapshot 식별자
+  *
+  * @author ryu-qqq
+  * @since 2025-11-07
+  */
+ public record ProductSnapshotId(Long value) {
+     public ProductSnapshotId {
+         if (value != null &amp;&amp; value &lt;= 0) {
+             throw new IllegalArgumentException(&quot;ProductSnapshot ID는 양수여야 합니다&quot;);
+         }
+     }
+ 
+     public static ProductSnapshotId of(Long value) {
+         return new ProductSnapshotId(value);
+     }
+ }
+ 
```

</details>

</tool-use>

---

<tool-use data-tool-type="write" data-tool-name="write">

<details><summary>Tool use: **code_edit** • Edit file: domain/src/main/java/com/ryuqq/crawlinghub/domain/product/ProductOption.java</summary>

**Chunk 1**
Lines added: 26, lines removed: 1

```diff
@@ -1,1 +1,26 @@
- 
+ package com.ryuqq.crawlinghub.domain.product;
+ 
+ import java.util.Objects;
+ 
+ /**
+  * 상품 옵션 Value Object
+  *
+  * @author ryu-qqq
+  * @since 2025-11-07
+  */
+ public record ProductOption(
+     String optionName,
+     String optionValue,
+     Integer stock,
+     Long additionalPrice
+ ) {
+     public ProductOption {
+         if (optionName == null || optionName.isBlank()) {
+             throw new IllegalArgumentException(&quot;옵션명은 필수입니다&quot;);
+         }
+         if (stock != null &amp;&amp; stock &lt; 0) {
+             throw new IllegalArgumentException(&quot;재고는 0 이상이어야 합니다&quot;);
+         }
+     }
+ }
+ 
```

</details>

</tool-use>

---

<tool-use data-tool-type="write" data-tool-name="write">

<details><summary>Tool use: **code_edit** • Edit file: domain/src/main/java/com/ryuqq/crawlinghub/domain/product/ProductInfoModule.java</summary>

**Chunk 1**
Lines added: 20, lines removed: 1

```diff
@@ -1,1 +1,20 @@
- 
+ package com.ryuqq.crawlinghub.domain.product;
+ 
+ /**
+  * 상품 정보 모듈 Value Object
+  *
+  * @author ryu-qqq
+  * @since 2025-11-07
+  */
+ public record ProductInfoModule(
+     String description,
+     String manufacturer,
+     String origin
+ ) {
+     public ProductInfoModule {
+         if (description == null || description.isBlank()) {
+             throw new IllegalArgumentException(&quot;상품 설명은 필수입니다&quot;);
+         }
+     }
+ }
+ 
```

</details>

</tool-use>

---

<tool-use data-tool-type="write" data-tool-name="write">

<details><summary>Tool use: **code_edit** • Edit file: domain/src/main/java/com/ryuqq/crawlinghub/domain/product/ShippingModule.java</summary>

**Chunk 1**
Lines added: 20, lines removed: 1

```diff
@@ -1,1 +1,20 @@
- 
+ package com.ryuqq.crawlinghub.domain.product;
+ 
+ /**
+  * 배송 모듈 Value Object
+  *
+  * @author ryu-qqq
+  * @since 2025-11-07
+  */
+ public record ShippingModule(
+     Integer shippingFee,
+     String shippingMethod,
+     Integer deliveryDays
+ ) {
+     public ShippingModule {
+         if (shippingFee != null &amp;&amp; shippingFee &lt; 0) {
+             throw new IllegalArgumentException(&quot;배송비는 0 이상이어야 합니다&quot;);
+         }
+     }
+ }
+ 
```

</details>

</tool-use>

---

<tool-use data-tool-type="write" data-tool-name="write">

<details><summary>Tool use: **code_edit** • Edit file: domain/src/main/java/com/ryuqq/crawlinghub/domain/product/ProductDetailInfoModule.java</summary>

**Chunk 1**
Lines added: 13, lines removed: 1

```diff
@@ -1,1 +1,13 @@
- 
+ package com.ryuqq.crawlinghub.domain.product;
+ 
+ /**
+  * 상품 상세 정보 모듈 Value Object
+  *
+  * @author ryu-qqq
+  * @since 2025-11-07
+  */
+ public record ProductDetailInfoModule(
+     String detailImageUrl,
+     String specifications
+ ) {}
+ 
```

</details>

</tool-use>

---

<tool-use data-tool-type="write" data-tool-name="write">

<details><summary>Tool use: **code_edit** • Edit file: domain/src/main/java/com/ryuqq/crawlinghub/domain/product/FullProductData.java</summary>

**Chunk 1**
Lines added: 22, lines removed: 1

```diff
@@ -1,1 +1,22 @@
- 
+ package com.ryuqq.crawlinghub.domain.product;
+ 
+ import java.util.List;
+ 
+ /**
+  * 외부 동기화용 전체 상품 데이터 DTO
+  *
+  * @author ryu-qqq
+  * @since 2025-11-07
+  */
+ public record FullProductData(
+     Long mustItItemNo,
+     String productName,
+     Long price,
+     String mainImageUrl,
+     List&lt;ProductOption&gt; options,
+     Integer totalStock,
+     ProductInfoModule productInfo,
+     ShippingModule shipping,
+     ProductDetailInfoModule detailInfo
+ ) {}
+ 
```

</details>

</tool-use>

---



---


ProductSnapshot Aggregate Root 생성. 문서의 import는 `MustItSellerId`이지만 실제 타입은 `MustitSellerId`입니다. 실제 타입을 사용합니다.


---

<tool-use data-tool-type="write" data-tool-name="write">

<details><summary>Tool use: **code_edit** • Edit file: domain/src/main/java/com/ryuqq/crawlinghub/domain/product/ProductSnapshot.java</summary>

**Chunk 1**
Lines added: 433, lines removed: 1

```diff
@@ -1,1 +1,433 @@
- 
+ package com.ryuqq.crawlinghub.domain.product;
+ 
+ import com.ryuqq.crawlinghub.domain.seller.MustitSellerId;
+ import java.time.Clock;
+ import java.time.LocalDateTime;
+ import java.util.ArrayList;
+ import java.util.List;
+ import java.util.Objects;
+ 
+ /**
+  * 상품 스냅샷 Aggregate Root
+  *
+  * &lt;p&gt;역할: 항상 완전한 상품 데이터를 유지하는 Materialized View
+  *
+  * &lt;p&gt;비즈니스 규칙:
+  * &lt;ul&gt;
+  *   &lt;li&gt;부분 데이터 수신 시 점진적으로 업데이트&lt;/li&gt;
+  *   &lt;li&gt;완전성 검증: 필수 필드가 모두 채워진 경우만 완전함&lt;/li&gt;
+  *   &lt;li&gt;버전 관리: 변경 시마다 버전 증가&lt;/li&gt;
+  * &lt;/ul&gt;
+  *
+  * @author ryu-qqq
+  * @since 2025-11-07
+  */
+ public class ProductSnapshot {
+ 
+     private final ProductSnapshotId id;
+     private final Long mustItItemNo;
+     private final MustitSellerId sellerId;
+ 
+     // 미니샵 데이터
+     private String productName;
+     private Long price;
+     private String mainImageUrl;
+ 
+     // 옵션 데이터
+     private List&lt;ProductOption&gt; options;
+     private Integer totalStock;
+ 
+     // 상세 데이터
+     private ProductInfoModule productInfo;
+     private ShippingModule shipping;
+     private ProductDetailInfoModule detailInfo;
+ 
+     // 메타 정보
+     private LocalDateTime lastSyncedAt;
+     private Integer version;
+     private final Clock clock;
+     private final LocalDateTime createdAt;
+     private LocalDateTime updatedAt;
+ 
+     /**
+      * Private 전체 생성자 (reconstitute 전용)
+      */
+     private ProductSnapshot(
+         ProductSnapshotId id,
+         Long mustItItemNo,
+         MustitSellerId sellerId,
+         String productName,
+         Long price,
+         String mainImageUrl,
+         List&lt;ProductOption&gt; options,
+         Integer totalStock,
+         ProductInfoModule productInfo,
+         ShippingModule shipping,
+         ProductDetailInfoModule detailInfo,
+         LocalDateTime lastSyncedAt,
+         Integer version,
+         Clock clock,
+         LocalDateTime createdAt,
+         LocalDateTime updatedAt
+     ) {
+         this.id = id;
+         this.mustItItemNo = mustItItemNo;
+         this.sellerId = sellerId;
+         this.productName = productName;
+         this.price = price;
+         this.mainImageUrl = mainImageUrl;
+         this.options = options != null ? new ArrayList&lt;&gt;(options) : new ArrayList&lt;&gt;();
+         this.totalStock = totalStock;
+         this.productInfo = productInfo;
+         this.shipping = shipping;
+         this.detailInfo = detailInfo;
+         this.lastSyncedAt = lastSyncedAt;
+         this.version = version;
+         this.clock = clock;
+         this.createdAt = createdAt;
+         this.updatedAt = updatedAt;
+     }
+ 
+     /**
+      * Package-private 주요 생성자 (검증 포함)
+      */
+     ProductSnapshot(
+         ProductSnapshotId id,
+         Long mustItItemNo,
+         MustitSellerId sellerId,
+         Clock clock
+     ) {
+         validateRequiredFields(mustItItemNo, sellerId);
+ 
+         LocalDateTime now = LocalDateTime.now(clock);
+         this.id = id;
+         this.mustItItemNo = mustItItemNo;
+         this.sellerId = sellerId;
+         this.productName = null;
+         this.price = null;
+         this.mainImageUrl = null;
+         this.options = new ArrayList&lt;&gt;();
+         this.totalStock = null;
+         this.productInfo = null;
+         this.shipping = null;
+         this.detailInfo = null;
+         this.lastSyncedAt = null;
+         this.version = 1;
+         this.clock = clock;
+         this.createdAt = now;
+         this.updatedAt = now;
+     }
+ 
+     /**
+      * 신규 Snapshot 생성 (ID 없음)
+      */
+     public static ProductSnapshot forNew(Long mustItItemNo, MustitSellerId sellerId) {
+         return new ProductSnapshot(null, mustItItemNo, sellerId, Clock.systemDefaultZone());
+     }
+ 
+     /**
+      * 기존 Snapshot 생성 (ID 있음)
+      */
+     public static ProductSnapshot of(ProductSnapshotId id, Long mustItItemNo, MustitSellerId sellerId) {
+         if (id == null) {
+             throw new IllegalArgumentException(&quot;ProductSnapshot ID는 필수입니다&quot;);
+         }
+         return new ProductSnapshot(id, mustItItemNo, sellerId, Clock.systemDefaultZone());
+     }
+ 
+     /**
+      * DB reconstitute (모든 필드 포함)
+      */
+     public static ProductSnapshot reconstitute(
+         ProductSnapshotId id,
+         Long mustItItemNo,
+         MustitSellerId sellerId,
+         String productName,
+         Long price,
+         String mainImageUrl,
+         List&lt;ProductOption&gt; options,
+         Integer totalStock,
+         ProductInfoModule productInfo,
+         ShippingModule shipping,
+         ProductDetailInfoModule detailInfo,
+         LocalDateTime lastSyncedAt,
+         Integer version,
+         LocalDateTime createdAt,
+         LocalDateTime updatedAt
+     ) {
+         if (id == null) {
+             throw new IllegalArgumentException(&quot;DB reconstitute는 ID가 필수입니다&quot;);
+         }
+         return new ProductSnapshot(
+             id, mustItItemNo, sellerId,
+             productName, price, mainImageUrl,
+             options, totalStock,
+             productInfo, shipping, detailInfo,
+             lastSyncedAt, version,
+             Clock.systemDefaultZone(),
+             createdAt, updatedAt
+         );
+     }
+ 
+     private static void validateRequiredFields(Long mustItItemNo, MustitSellerId sellerId) {
+         if (mustItItemNo == null) {
+             throw new IllegalArgumentException(&quot;머스트잇 상품 번호는 필수입니다&quot;);
+         }
+         if (sellerId == null) {
+             throw new IllegalArgumentException(&quot;셀러 ID는 필수입니다&quot;);
+         }
+     }
+ 
+     /**
+      * 미니샵 데이터 업데이트
+      */
+     public void updateProductName(String productName) {
+         if (productName == null || productName.isBlank()) {
+             throw new IllegalArgumentException(&quot;상품명은 필수입니다&quot;);
+         }
+         this.productName = productName;
+         incrementVersion();
+     }
+ 
+     public void updatePrice(Long price) {
+         if (price == null || price &lt; 0) {
+             throw new IllegalArgumentException(&quot;가격은 0 이상이어야 합니다&quot;);
+         }
+         this.price = price;
+         incrementVersion();
+     }
+ 
+     public void updateMainImage(String mainImageUrl) {
+         if (mainImageUrl == null || mainImageUrl.isBlank()) {
+             throw new IllegalArgumentException(&quot;메인 이미지 URL은 필수입니다&quot;);
+         }
+         this.mainImageUrl = mainImageUrl;
+         incrementVersion();
+     }
+ 
+     /**
+      * 옵션 데이터 업데이트
+      */
+     public void updateOptions(List&lt;ProductOption&gt; options) {
+         if (options == null) {
+             throw new IllegalArgumentException(&quot;옵션 리스트는 null일 수 없습니다&quot;);
+         }
+         this.options = new ArrayList&lt;&gt;(options);
+         incrementVersion();
+     }
+ 
+     public void updateTotalStock(Integer totalStock) {
+         if (totalStock == null || totalStock &lt; 0) {
+             throw new IllegalArgumentException(&quot;총 재고는 0 이상이어야 합니다&quot;);
+         }
+         this.totalStock = totalStock;
+         incrementVersion();
+     }
+ 
+     /**
+      * 상세 데이터 업데이트
+      */
+     public void updateProductInfo(ProductInfoModule productInfo) {
+         if (productInfo == null) {
+             throw new IllegalArgumentException(&quot;상품 정보 모듈은 필수입니다&quot;);
+         }
+         this.productInfo = productInfo;
+         incrementVersion();
+     }
+ 
+     public void updateShipping(ShippingModule shipping) {
+         if (shipping == null) {
+             throw new IllegalArgumentException(&quot;배송 모듈은 필수입니다&quot;);
+         }
+         this.shipping = shipping;
+         incrementVersion();
+     }
+ 
+     public void updateDetailInfo(ProductDetailInfoModule detailInfo) {
+         if (detailInfo == null) {
+             throw new IllegalArgumentException(&quot;상세 정보 모듈은 필수입니다&quot;);
+         }
+         this.detailInfo = detailInfo;
+         incrementVersion();
+     }
+ 
+     /**
+      * 외부 동기화 완료 기록
+      */
+     public void recordSyncCompleted() {
+         this.lastSyncedAt = LocalDateTime.now(clock);
+         this.updatedAt = LocalDateTime.now(clock);
+     }
+ 
+     /**
+      * 버전 증가
+      */
+     private void incrementVersion() {
+         this.version++;
+         this.updatedAt = LocalDateTime.now(clock);
+     }
+ 
+     /**
+      * 완전성 검증
+      *
+      * &lt;p&gt;최소 필수 필드:
+      * &lt;ul&gt;
+      *   &lt;li&gt;productName (미니샵)&lt;/li&gt;
+      *   &lt;li&gt;price (미니샵)&lt;/li&gt;
+      *   &lt;li&gt;options (옵션)&lt;/li&gt;
+      * &lt;/ul&gt;
+      *
+      * &lt;p&gt;상세 데이터는 선택적 (없어도 동기화 가능)
+      */
+     public boolean isComplete() {
+         return hasProductName()
+             &amp;&amp; hasPrice()
+             &amp;&amp; hasOptions();
+     }
+ 
+     /**
+      * 동기화 준비 여부 확인
+      */
+     public boolean isReadyForSync() {
+         return isComplete();
+     }
+ 
+     /**
+      * 전체 상품 데이터로 변환 (외부 동기화용)
+      */
+     public FullProductData toFullProductData() {
+         if (!isComplete()) {
+             throw new IllegalStateException(&quot;불완전한 Snapshot은 FullProductData로 변환할 수 없습니다&quot;);
+         }
+         return new FullProductData(
+             mustItItemNo,
+             productName,
+             price,
+             mainImageUrl,
+             options,
+             totalStock,
+             productInfo,
+             shipping,
+             detailInfo
+         );
+     }
+ 
+     // Law of Demeter 준수 메서드
+     public Long getIdValue() {
+         return id != null ? id.value() : null;
+     }
+ 
+     public Long getMustItItemNo() {
+         return mustItItemNo;
+     }
+ 
+     public Long getSellerIdValue() {
+         return sellerId != null ? sellerId.value() : null;
+     }
+ 
+     public String getProductName() {
+         return productName;
+     }
+ 
+     public Long getPrice() {
+         return price;
+     }
+ 
+     public String getMainImageUrl() {
+         return mainImageUrl;
+     }
+ 
+     public List&lt;ProductOption&gt; getOptions() {
+         return new ArrayList&lt;&gt;(options);
+     }
+ 
+     public Integer getTotalStock() {
+         return totalStock;
+     }
+ 
+     public ProductInfoModule getProductInfo() {
+         return productInfo;
+     }
+ 
+     public ShippingModule getShipping() {
+         return shipping;
+     }
+ 
+     public ProductDetailInfoModule getDetailInfo() {
+         return detailInfo;
+     }
+ 
+     public LocalDateTime getLastSyncedAt() {
+         return lastSyncedAt;
+     }
+ 
+     public Integer getVersion() {
+         return version;
+     }
+ 
+     public LocalDateTime getCreatedAt() {
+         return createdAt;
+     }
+ 
+     public LocalDateTime getUpdatedAt() {
+         return updatedAt;
+     }
+ 
+     // 필드 존재 여부 확인 메서드
+     public boolean hasProductName() {
+         return productName != null &amp;&amp; !productName.isBlank();
+     }
+ 
+     public boolean hasPrice() {
+         return price != null;
+     }
+ 
+     public boolean hasMainImage() {
+         return mainImageUrl != null &amp;&amp; !mainImageUrl.isBlank();
+     }
+ 
+     public boolean hasOptions() {
+         return options != null &amp;&amp; !options.isEmpty();
+     }
+ 
+     public boolean hasProductInfo() {
+         return productInfo != null;
+     }
+ 
+     public boolean hasShipping() {
+         return shipping != null;
+     }
+ 
+     public boolean hasDetailInfo() {
+         return detailInfo != null;
+     }
+ 
+     @Override
+     public boolean equals(Object o) {
+         if (this == o) {
+             return true;
+         }
+         if (o == null || getClass() != o.getClass()) {
+             return false;
+         }
+         ProductSnapshot that = (ProductSnapshot) o;
+         return Objects.equals(id, that.id);
+     }
+ 
+     @Override
+     public int hashCode() {
+         return Objects.hash(id);
+     }
+ 
+     @Override
+     public String toString() {
+         return &quot;ProductSnapshot{&quot; +
+             &quot;id=&quot; + id +
+             &quot;, mustItItemNo=&quot; + mustItItemNo +
+             &quot;, sellerId=&quot; + sellerId +
+             &quot;, version=&quot; + version +
+             &quot;, isComplete=&quot; + isComplete() +
+             &#39;}&#39;;
+     }
+ }
+ 
```

</details>

</tool-use>

---



---


Phase 1-2: ProductChangeEvent (Domain Event) 및 보조 타입 구현 중.


---

<tool-use data-tool-type="write" data-tool-name="write">

<details><summary>Tool use: **code_edit** • Edit file: domain/src/main/java/com/ryuqq/crawlinghub/domain/product/event/ChangeSource.java</summary>

**Chunk 1**
Lines added: 25, lines removed: 1

```diff
@@ -1,1 +1,25 @@
- 
+ package com.ryuqq.crawlinghub.domain.product.event;
+ 
+ /**
+  * 변경 소스 Enum
+  *
+  * @author ryu-qqq
+  * @since 2025-11-07
+  */
+ public enum ChangeSource {
+     /**
+      * 미니샵 크롤링 (이미지, 상품명, 가격)
+      */
+     MINI_SHOP,
+ 
+     /**
+      * 옵션 크롤링 (옵션, 재고)
+      */
+     OPTION,
+ 
+     /**
+      * 상세 크롤링 (모듈)
+      */
+     DETAIL
+ }
+ 
```

</details>

</tool-use>

---

<tool-use data-tool-type="write" data-tool-name="write">

<details><summary>Tool use: **code_edit** • Edit file: domain/src/main/java/com/ryuqq/crawlinghub/domain/product/event/FieldChange.java</summary>

**Chunk 1**
Lines added: 29, lines removed: 1

```diff
@@ -1,1 +1,29 @@
- 
+ package com.ryuqq.crawlinghub.domain.product.event;
+ 
+ import java.util.Objects;
+ 
+ /**
+  * 필드 변경 내역 Value Object
+  *
+  * @author ryu-qqq
+  * @since 2025-11-07
+  */
+ public record FieldChange(
+     String fieldName,
+     Object oldValue,
+     Object newValue
+ ) {
+     public FieldChange {
+         if (fieldName == null || fieldName.isBlank()) {
+             throw new IllegalArgumentException(&quot;필드명은 필수입니다&quot;);
+         }
+     }
+ 
+     /**
+      * 실제로 값이 변경되었는지 확인
+      */
+     public boolean isActuallyChanged() {
+         return !Objects.equals(oldValue, newValue);
+     }
+ }
+ 
```

</details>

</tool-use>

---

<tool-use data-tool-type="write" data-tool-name="write">

<details><summary>Tool use: **code_edit** • Edit file: domain/src/main/java/com/ryuqq/crawlinghub/domain/product/event/ProductChangeEvent.java</summary>

**Chunk 1**
Lines added: 123, lines removed: 1

```diff
@@ -1,1 +1,123 @@
- 
+ package com.ryuqq.crawlinghub.domain.product.event;
+ 
+ import java.time.LocalDateTime;
+ import java.util.Map;
+ import java.util.Objects;
+ 
+ /**
+  * 상품 변경 이벤트
+  *
+  * &lt;p&gt;역할: 상품 데이터 변경 시 발행되는 Domain Event
+  *
+  * &lt;p&gt;포함 정보:
+  * &lt;ul&gt;
+  *   &lt;li&gt;productId: 변경된 상품 ID&lt;/li&gt;
+  *   &lt;li&gt;source: 변경 소스 (MINI_SHOP, OPTION, DETAIL)&lt;/li&gt;
+  *   &lt;li&gt;changedFields: 변경된 필드 목록 (필드명 → 변경 내역)&lt;/li&gt;
+  *   &lt;li&gt;occurredAt: 변경 발생 시각&lt;/li&gt;
+  * &lt;/ul&gt;
+  *
+  * @author ryu-qqq
+  * @since 2025-11-07
+  */
+ public class ProductChangeEvent {
+ 
+     private final Long productId;
+     private final ChangeSource source;
+     private final Map&lt;String, FieldChange&gt; changedFields;
+     private final LocalDateTime occurredAt;
+ 
+     public ProductChangeEvent(
+         Long productId,
+         ChangeSource source,
+         Map&lt;String, FieldChange&gt; changedFields,
+         LocalDateTime occurredAt
+     ) {
+         validateRequiredFields(productId, source, changedFields, occurredAt);
+ 
+         this.productId = productId;
+         this.source = source;
+         this.changedFields = Map.copyOf(changedFields); // 불변 복사
+         this.occurredAt = occurredAt;
+     }
+ 
+     private static void validateRequiredFields(
+         Long productId,
+         ChangeSource source,
+         Map&lt;String, FieldChange&gt; changedFields,
+         LocalDateTime occurredAt
+     ) {
+         if (productId == null) {
+             throw new IllegalArgumentException(&quot;Product ID는 필수입니다&quot;);
+         }
+         if (source == null) {
+             throw new IllegalArgumentException(&quot;변경 소스는 필수입니다&quot;);
+         }
+         if (changedFields == null || changedFields.isEmpty()) {
+             throw new IllegalArgumentException(&quot;변경 필드는 최소 1개 이상이어야 합니다&quot;);
+         }
+         if (occurredAt == null) {
+             throw new IllegalArgumentException(&quot;변경 발생 시각은 필수입니다&quot;);
+         }
+     }
+ 
+     public Long getProductId() {
+         return productId;
+     }
+ 
+     public ChangeSource getSource() {
+         return source;
+     }
+ 
+     public Map&lt;String, FieldChange&gt; getChangedFields() {
+         return changedFields;
+     }
+ 
+     public LocalDateTime getOccurredAt() {
+         return occurredAt;
+     }
+ 
+     /**
+      * 특정 필드가 변경되었는지 확인
+      */
+     public boolean hasFieldChanged(String fieldName) {
+         return changedFields.containsKey(fieldName);
+     }
+ 
+     /**
+      * 변경된 필드 수
+      */
+     public int getChangedFieldCount() {
+         return changedFields.size();
+     }
+ 
+     @Override
+     public boolean equals(Object o) {
+         if (this == o) {
+             return true;
+         }
+         if (o == null || getClass() != o.getClass()) {
+             return false;
+         }
+         ProductChangeEvent that = (ProductChangeEvent) o;
+         return Objects.equals(productId, that.productId) &amp;&amp;
+             source == that.source &amp;&amp;
+             Objects.equals(occurredAt, that.occurredAt);
+     }
+ 
+     @Override
+     public int hashCode() {
+         return Objects.hash(productId, source, occurredAt);
+     }
+ 
+     @Override
+     public String toString() {
+         return &quot;ProductChangeEvent{&quot; +
+             &quot;productId=&quot; + productId +
+             &quot;, source=&quot; + source +
+             &quot;, changedFieldCount=&quot; + changedFields.size() +
+             &quot;, occurredAt=&quot; + occurredAt +
+             &#39;}&#39;;
+     }
+ }
+ 
```

</details>

</tool-use>

---



---


Phase 1-3: ProductSyncOutbox Domain (Aggregate Root) 및 보조 타입 구현 중.


---

<tool-use data-tool-type="write" data-tool-name="write">

<details><summary>Tool use: **code_edit** • Edit file: domain/src/main/java/com/ryuqq/crawlinghub/domain/product/ProductSyncOutboxId.java</summary>

**Chunk 1**
Lines added: 20, lines removed: 1

```diff
@@ -1,1 +1,20 @@
- 
+ package com.ryuqq.crawlinghub.domain.product;
+ 
+ /**
+  * ProductSyncOutbox 식별자
+  *
+  * @author ryu-qqq
+  * @since 2025-11-07
+  */
+ public record ProductSyncOutboxId(Long value) {
+     public ProductSyncOutboxId {
+         if (value != null &amp;&amp; value &lt;= 0) {
+             throw new IllegalArgumentException(&quot;ProductSyncOutbox ID는 양수여야 합니다&quot;);
+         }
+     }
+ 
+     public static ProductSyncOutboxId of(Long value) {
+         return new ProductSyncOutboxId(value);
+     }
+ }
+ 
```

</details>

</tool-use>

---

<tool-use data-tool-type="write" data-tool-name="write">

<details><summary>Tool use: **code_edit** • Edit file: domain/src/main/java/com/ryuqq/crawlinghub/domain/product/SyncStatus.java</summary>

**Chunk 1**
Lines added: 30, lines removed: 1

```diff
@@ -1,1 +1,30 @@
- 
+ package com.ryuqq.crawlinghub.domain.product;
+ 
+ /**
+  * 동기화 상태 Enum
+  *
+  * @author ryu-qqq
+  * @since 2025-11-07
+  */
+ public enum SyncStatus {
+     /**
+      * 동기화 대기 중
+      */
+     PENDING,
+ 
+     /**
+      * 동기화 진행 중
+      */
+     PROCESSING,
+ 
+     /**
+      * 동기화 완료
+      */
+     COMPLETED,
+ 
+     /**
+      * 동기화 실패
+      */
+     FAILED
+ }
+ 
```

</details>

</tool-use>

---

<tool-use data-tool-type="write" data-tool-name="write">

<details><summary>Tool use: **code_edit** • Edit file: domain/src/main/java/com/ryuqq/crawlinghub/domain/product/ProductSyncOutbox.java</summary>

**Chunk 1**
Lines added: 242, lines removed: 1

```diff
@@ -1,1 +1,242 @@
- 
+ package com.ryuqq.crawlinghub.domain.product;
+ 
+ import java.time.Clock;
+ import java.time.LocalDateTime;
+ import java.util.Objects;
+ 
+ /**
+  * 상품 동기화 Outbox Aggregate Root
+  *
+  * &lt;p&gt;역할: Outbox Pattern으로 외부 API 호출 트랜잭션 보장
+  *
+  * &lt;p&gt;처리 흐름:
+  * &lt;ol&gt;
+  *   &lt;li&gt;PENDING: 동기화 대기 중&lt;/li&gt;
+  *   &lt;li&gt;PROCESSING: 동기화 진행 중&lt;/li&gt;
+  *   &lt;li&gt;COMPLETED: 동기화 완료&lt;/li&gt;
+  *   &lt;li&gt;FAILED: 동기화 실패 (최대 재시도 초과)&lt;/li&gt;
+  * &lt;/ol&gt;
+  *
+  * @author ryu-qqq
+  * @since 2025-11-07
+  */
+ public class ProductSyncOutbox {
+ 
+     private static final int MAX_RETRY_COUNT = 3;
+ 
+     private final ProductSyncOutboxId id;
+     private final Long productId;
+     private final String productJson;
+     private SyncStatus status;
+     private Integer retryCount;
+     private String errorMessage;
+     private final Clock clock;
+     private final LocalDateTime createdAt;
+     private LocalDateTime processedAt;
+ 
+     /**
+      * Private 전체 생성자 (reconstitute 전용)
+      */
+     private ProductSyncOutbox(
+         ProductSyncOutboxId id,
+         Long productId,
+         String productJson,
+         SyncStatus status,
+         Integer retryCount,
+         String errorMessage,
+         Clock clock,
+         LocalDateTime createdAt,
+         LocalDateTime processedAt
+     ) {
+         this.id = id;
+         this.productId = productId;
+         this.productJson = productJson;
+         this.status = status;
+         this.retryCount = retryCount;
+         this.errorMessage = errorMessage;
+         this.clock = clock;
+         this.createdAt = createdAt;
+         this.processedAt = processedAt;
+     }
+ 
+     /**
+      * Package-private 주요 생성자 (검증 포함)
+      */
+     ProductSyncOutbox(
+         ProductSyncOutboxId id,
+         Long productId,
+         String productJson,
+         Clock clock
+     ) {
+         validateRequiredFields(productId, productJson);
+ 
+         this.id = id;
+         this.productId = productId;
+         this.productJson = productJson;
+         this.status = SyncStatus.PENDING;
+         this.retryCount = 0;
+         this.errorMessage = null;
+         this.clock = clock;
+         this.createdAt = LocalDateTime.now(clock);
+         this.processedAt = null;
+     }
+ 
+     /**
+      * 신규 Outbox 생성 (ID 없음)
+      */
+     public static ProductSyncOutbox create(Long productId, String productJson) {
+         return new ProductSyncOutbox(null, productId, productJson, Clock.systemDefaultZone());
+     }
+ 
+     /**
+      * DB reconstitute (모든 필드 포함)
+      */
+     public static ProductSyncOutbox reconstitute(
+         ProductSyncOutboxId id,
+         Long productId,
+         String productJson,
+         SyncStatus status,
+         Integer retryCount,
+         String errorMessage,
+         LocalDateTime createdAt,
+         LocalDateTime processedAt
+     ) {
+         if (id == null) {
+             throw new IllegalArgumentException(&quot;DB reconstitute는 ID가 필수입니다&quot;);
+         }
+         return new ProductSyncOutbox(
+             id, productId, productJson,
+             status, retryCount, errorMessage,
+             Clock.systemDefaultZone(),
+             createdAt, processedAt
+         );
+     }
+ 
+     private static void validateRequiredFields(Long productId, String productJson) {
+         if (productId == null) {
+             throw new IllegalArgumentException(&quot;Product ID는 필수입니다&quot;);
+         }
+         if (productJson == null || productJson.isBlank()) {
+             throw new IllegalArgumentException(&quot;Product JSON은 필수입니다&quot;);
+         }
+     }
+ 
+     /**
+      * 처리 시작
+      */
+     public void markAsProcessing() {
+         if (status != SyncStatus.PENDING) {
+             throw new IllegalStateException(&quot;PENDING 상태에서만 PROCESSING으로 변경 가능합니다&quot;);
+         }
+         this.status = SyncStatus.PROCESSING;
+     }
+ 
+     /**
+      * 처리 완료
+      */
+     public void markAsCompleted() {
+         if (status != SyncStatus.PROCESSING) {
+             throw new IllegalStateException(&quot;PROCESSING 상태에서만 COMPLETED로 변경 가능합니다&quot;);
+         }
+         this.status = SyncStatus.COMPLETED;
+         this.processedAt = LocalDateTime.now(clock);
+     }
+ 
+     /**
+      * 재시도 카운트 증가
+      */
+     public void incrementRetryCount() {
+         this.retryCount++;
+         this.status = SyncStatus.PENDING; // 재시도를 위해 PENDING으로 복원
+     }
+ 
+     /**
+      * 에러 메시지 기록
+      */
+     public void recordError(String errorMessage) {
+         this.errorMessage = errorMessage;
+     }
+ 
+     /**
+      * 처리 실패
+      */
+     public void markAsFailed() {
+         this.status = SyncStatus.FAILED;
+         this.processedAt = LocalDateTime.now(clock);
+     }
+ 
+     /**
+      * 최대 재시도 횟수 초과 여부
+      */
+     public boolean isMaxRetriesExceeded() {
+         return retryCount &gt;= MAX_RETRY_COUNT;
+     }
+ 
+     /**
+      * 처리 가능 여부 확인
+      */
+     public boolean canProcess() {
+         return status == SyncStatus.PENDING &amp;&amp; !isMaxRetriesExceeded();
+     }
+ 
+     // Law of Demeter 준수 메서드
+     public Long getIdValue() {
+         return id != null ? id.value() : null;
+     }
+ 
+     public Long getProductId() {
+         return productId;
+     }
+ 
+     public String getProductJson() {
+         return productJson;
+     }
+ 
+     public SyncStatus getStatus() {
+         return status;
+     }
+ 
+     public Integer getRetryCount() {
+         return retryCount;
+     }
+ 
+     public String getErrorMessage() {
+         return errorMessage;
+     }
+ 
+     public LocalDateTime getCreatedAt() {
+         return createdAt;
+     }
+ 
+     public LocalDateTime getProcessedAt() {
+         return processedAt;
+     }
+ 
+     @Override
+     public boolean equals(Object o) {
+         if (this == o) {
+             return true;
+         }
+         if (o == null || getClass() != o.getClass()) {
+             return false;
+         }
+         ProductSyncOutbox that = (ProductSyncOutbox) o;
+         return Objects.equals(id, that.id);
+     }
+ 
+     @Override
+     public int hashCode() {
+         return Objects.hash(id);
+     }
+ 
+     @Override
+     public String toString() {
+         return &quot;ProductSyncOutbox{&quot; +
+             &quot;id=&quot; + id +
+             &quot;, productId=&quot; + productId +
+             &quot;, status=&quot; + status +
+             &quot;, retryCount=&quot; + retryCount +
+             &#39;}&#39;;
+     }
+ }
+ 
```

</details>

</tool-use>

---

<tool-use data-tool-type="generic" data-tool-name="todo_write">
<details><summary>Tool use: **todo_write** • Todo List</summary>

- [x] Phase 1-1: ProductSnapshot Domain (Aggregate Root) 및 Value Objects 구현
- [x] Phase 1-2: ProductChangeEvent (Domain Event) 및 보조 타입 구현
- [x] Phase 1-3: ProductSyncOutbox Domain (Aggregate Root) 및 보조 타입 구현
- [-] Phase 1-4: 모든 Value Objects 검증 및 완료

</details>
</tool-use>

---

<tool-use data-tool-type="generic" data-tool-name="read_lints">
<details>
          <summary>Tool use: **read_lints** • Read lints for 1 file</summary>
      
Lint paths:

- `domain/src/main/java/com/ryuqq/crawlinghub/domain/product`

Lint results

Lint errors for `domain/src/main/java/com/ryuqq/crawlinghub/domain/product/ProductOption.java`


| Message | Range | Severity |
|-------|-------|----------|
| The import java.util.Objects is never used | 3:8-3:25 | DIAGNOSTIC_SEVERITY_WARNING |


</details>
</tool-use>

---



---


Linter 오류 수정 중: 사용하지 않는 import 제거.


---

<tool-use data-tool-type="write" data-tool-name="search_replace">

<details><summary>Tool use: **code_edit** • Edit file: domain/src/main/java/com/ryuqq/crawlinghub/domain/product/ProductOption.java</summary>

**Chunk 1**
Lines added: undefined, lines removed: 2

```diff
@@ -1,5 +1,3 @@
  package com.ryuqq.crawlinghub.domain.product;
- 
- import java.util.Objects;
  
  /**
```

</details>

</tool-use>

---

<tool-use data-tool-type="generic" data-tool-name="read_lints">
<details>
          <summary>Tool use: **read_lints** • Read lints for 1 file</summary>
      
Lint paths:

- `domain/src/main/java/com/ryuqq/crawlinghub/domain/product`

Lint results


**No lint errors found**
</details>
</tool-use>

---

<tool-use data-tool-type="generic" data-tool-name="todo_write">
<details><summary>Tool use: **todo_write** • Todo List</summary>

- [x] Phase 1-1: ProductSnapshot Domain (Aggregate Root) 및 Value Objects 구현
- [x] Phase 1-2: ProductChangeEvent (Domain Event) 및 보조 타입 구현
- [x] Phase 1-3: ProductSyncOutbox Domain (Aggregate Root) 및 보조 타입 구현
- [x] Phase 1-4: 모든 Value Objects 검증 및 완료

</details>
</tool-use>

---



---


Phase 1 완료. Phase 2로 진행: Application Layer 구현. 먼저 application 레이어 구조를 확인합니다.


---

<tool-use data-tool-type="generic" data-tool-name="list_dir">
<details>
            <summary>Tool use: **list_directory** • Listed directory undefined • **0** results</summary>
        
No results found
</details>
</tool-use>

---

<tool-use data-tool-type="search" data-tool-name="codebase_search">
<details>
                <summary>Tool use: **codebase_search** • Searched codebase "port interface LoadPort SavePort application layer" • **3** results</summary>
            
| File | Lines |
|------|-------|
| `application/src/main/java/com/ryuqq/crawlinghub/application/product/port/out/LoadProductPort.java` | L34 |
| `application/src/main/java/com/ryuqq/crawlinghub/application/useragent/port/out/SaveUserAgentPort.java` | L29 |
| `application/src/main/java/com/ryuqq/crawlinghub/application/useragent/port/out/LoadUserAgentPort.java` | L58 |

</details>
</tool-use>

---

<tool-use data-tool-type="generic" data-tool-name="todo_write">
<details><summary>Tool use: **todo_write** • Todo List</summary>

- [-] Phase 2-1: Port 인터페이스 정의
- [ ] Phase 2-2: ProductSnapshotBuilder 구현
- [ ] Phase 2-3: ExternalSyncOrchestrator 구현
- [ ] Phase 2-4: ProductSyncWorker 구현

</details>
</tool-use>

---



---


Phase 2 시작: Port 인터페이스 정의부터 진행합니다.


---

<tool-use data-tool-type="write" data-tool-name="write">

<details><summary>Tool use: **code_edit** • Edit file: application/src/main/java/com/ryuqq/crawlinghub/application/product/port/out/LoadProductSnapshotPort.java</summary>

**Chunk 1**
Lines added: 28, lines removed: 1

```diff
@@ -1,1 +1,28 @@
- 
+ package com.ryuqq.crawlinghub.application.product.port.out;
+ 
+ import com.ryuqq.crawlinghub.domain.product.ProductSnapshot;
+ import com.ryuqq.crawlinghub.domain.seller.MustitSellerId;
+ 
+ import java.util.Optional;
+ 
+ /**
+  * ProductSnapshot 조회 Port (Outbound)
+  *
+  * &lt;p&gt;Query Adapter가 구현
+  *
+  * @author ryu-qqq
+  * @since 2025-11-07
+  */
+ public interface LoadProductSnapshotPort {
+ 
+     /**
+      * ProductSnapshot ID로 조회
+      */
+     Optional&lt;ProductSnapshot&gt; findById(Long productId);
+ 
+     /**
+      * Mustit 상품 번호 + Seller ID로 조회
+      */
+     Optional&lt;ProductSnapshot&gt; findByMustitItemNoAndSellerId(Long mustItItemNo, MustitSellerId sellerId);
+ }
+ 
```

</details>

</tool-use>

---

<tool-use data-tool-type="write" data-tool-name="write">

<details><summary>Tool use: **code_edit** • Edit file: application/src/main/java/com/ryuqq/crawlinghub/application/product/port/out/SaveProductSnapshotPort.java</summary>

**Chunk 1**
Lines added: 24, lines removed: 1

```diff
@@ -1,1 +1,24 @@
- 
+ package com.ryuqq.crawlinghub.application.product.port.out;
+ 
+ import com.ryuqq.crawlinghub.domain.product.ProductSnapshot;
+ 
+ /**
+  * ProductSnapshot 저장 Port (Outbound)
+  *
+  * &lt;p&gt;Persistence Adapter가 구현
+  *
+  * @author ryu-qqq
+  * @since 2025-11-07
+  */
+ public interface SaveProductSnapshotPort {
+ 
+     /**
+      * ProductSnapshot 저장 (신규 생성 또는 수정)
+      *
+      * @param snapshot 저장할 ProductSnapshot (null 불가)
+      * @return 저장된 ProductSnapshot (ID 포함)
+      * @throws IllegalArgumentException snapshot이 null인 경우
+      */
+     ProductSnapshot save(ProductSnapshot snapshot);
+ }
+ 
```

</details>

</tool-use>

---

<tool-use data-tool-type="write" data-tool-name="write">

<details><summary>Tool use: **code_edit** • Edit file: application/src/main/java/com/ryuqq/crawlinghub/application/product/port/out/SaveProductSyncOutboxPort.java</summary>

**Chunk 1**
Lines added: 24, lines removed: 1

```diff
@@ -1,1 +1,24 @@
- 
+ package com.ryuqq.crawlinghub.application.product.port.out;
+ 
+ import com.ryuqq.crawlinghub.domain.product.ProductSyncOutbox;
+ 
+ /**
+  * ProductSyncOutbox 저장 Port (Outbound)
+  *
+  * &lt;p&gt;Persistence Adapter가 구현
+  *
+  * @author ryu-qqq
+  * @since 2025-11-07
+  */
+ public interface SaveProductSyncOutboxPort {
+ 
+     /**
+      * ProductSyncOutbox 저장 (신규 생성 또는 수정)
+      *
+      * @param outbox 저장할 ProductSyncOutbox (null 불가)
+      * @return 저장된 ProductSyncOutbox (ID 포함)
+      * @throws IllegalArgumentException outbox가 null인 경우
+      */
+     ProductSyncOutbox save(ProductSyncOutbox outbox);
+ }
+ 
```

</details>

</tool-use>

---

<tool-use data-tool-type="write" data-tool-name="write">

<details><summary>Tool use: **code_edit** • Edit file: application/src/main/java/com/ryuqq/crawlinghub/application/product/port/out/LoadProductSyncOutboxPort.java</summary>

**Chunk 1**
Lines added: 28, lines removed: 1

```diff
@@ -1,1 +1,28 @@
- 
+ package com.ryuqq.crawlinghub.application.product.port.out;
+ 
+ import com.ryuqq.crawlinghub.domain.product.ProductSyncOutbox;
+ import com.ryuqq.crawlinghub.domain.product.SyncStatus;
+ 
+ import java.util.List;
+ 
+ /**
+  * ProductSyncOutbox 조회 Port (Outbound)
+  *
+  * &lt;p&gt;Query Adapter가 구현
+  *
+  * @author ryu-qqq
+  * @since 2025-11-07
+  */
+ public interface LoadProductSyncOutboxPort {
+ 
+     /**
+      * 상태로 ProductSyncOutbox 목록 조회
+      *
+      * @param status SyncStatus (null 불가)
+      * @param limit 최대 조회 개수
+      * @return ProductSyncOutbox 목록
+      * @throws IllegalArgumentException status가 null인 경우
+      */
+     List&lt;ProductSyncOutbox&gt; findByStatus(SyncStatus status, int limit);
+ }
+ 
```

</details>

</tool-use>

---

<tool-use data-tool-type="write" data-tool-name="write">

<details><summary>Tool use: **code_edit** • Edit file: application/src/main/java/com/ryuqq/crawlinghub/application/product/port/out/ExternalProductApiPort.java</summary>

**Chunk 1**
Lines added: 22, lines removed: 1

```diff
@@ -1,1 +1,22 @@
- 
+ package com.ryuqq.crawlinghub.application.product.port.out;
+ 
+ /**
+  * 외부 상품 API Port (Outbound)
+  *
+  * &lt;p&gt;HTTP Adapter가 구현
+  *
+  * @author ryu-qqq
+  * @since 2025-11-07
+  */
+ public interface ExternalProductApiPort {
+ 
+     /**
+      * 외부 상품 서버에 상품 데이터 업데이트
+      *
+      * @param productJson 상품 데이터 JSON (null 불가)
+      * @throws IllegalArgumentException productJson이 null인 경우
+      * @throws RuntimeException 외부 API 호출 실패 시
+      */
+     void updateProduct(String productJson);
+ }
+ 
```

</details>

</tool-use>

---



---


DTO 생성 및 ProductSnapshotBuilder 구현 중.


---

<tool-use data-tool-type="write" data-tool-name="write">

<details><summary>Tool use: **code_edit** • Edit file: application/src/main/java/com/ryuqq/crawlinghub/application/product/builder/MiniShopData.java</summary>

**Chunk 1**
Lines added: 14, lines removed: 1

```diff
@@ -1,1 +1,14 @@
- 
+ package com.ryuqq.crawlinghub.application.product.builder;
+ 
+ /**
+  * 미니샵 데이터 DTO
+  *
+  * @author ryu-qqq
+  * @since 2025-11-07
+  */
+ public record MiniShopData(
+     String productName,
+     Long price,
+     String mainImageUrl
+ ) {}
+ 
```

</details>

</tool-use>

---

<tool-use data-tool-type="write" data-tool-name="write">

<details><summary>Tool use: **code_edit** • Edit file: application/src/main/java/com/ryuqq/crawlinghub/application/product/builder/OptionData.java</summary>

**Chunk 1**
Lines added: 17, lines removed: 1

```diff
@@ -1,1 +1,17 @@
- 
+ package com.ryuqq.crawlinghub.application.product.builder;
+ 
+ import com.ryuqq.crawlinghub.domain.product.ProductOption;
+ 
+ import java.util.List;
+ 
+ /**
+  * 옵션 데이터 DTO
+  *
+  * @author ryu-qqq
+  * @since 2025-11-07
+  */
+ public record OptionData(
+     List&lt;ProductOption&gt; options,
+     Integer totalStock
+ ) {}
+ 
```

</details>

</tool-use>

---

<tool-use data-tool-type="write" data-tool-name="write">

<details><summary>Tool use: **code_edit** • Edit file: application/src/main/java/com/ryuqq/crawlinghub/application/product/builder/DetailData.java</summary>

**Chunk 1**
Lines added: 18, lines removed: 1

```diff
@@ -1,1 +1,18 @@
- 
+ package com.ryuqq.crawlinghub.application.product.builder;
+ 
+ import com.ryuqq.crawlinghub.domain.product.ProductDetailInfoModule;
+ import com.ryuqq.crawlinghub.domain.product.ProductInfoModule;
+ import com.ryuqq.crawlinghub.domain.product.ShippingModule;
+ 
+ /**
+  * 상세 데이터 DTO
+  *
+  * @author ryu-qqq
+  * @since 2025-11-07
+  */
+ public record DetailData(
+     ProductInfoModule productInfo,
+     ShippingModule shipping,
+     ProductDetailInfoModule detailInfo
+ ) {}
+ 
```

</details>

</tool-use>

---

<tool-use data-tool-type="write" data-tool-name="write">

<details><summary>Tool use: **code_edit** • Edit file: application/src/main/java/com/ryuqq/crawlinghub/application/product/builder/ProductSnapshotBuilder.java</summary>

**Chunk 1**
Lines added: 190, lines removed: 1

```diff
@@ -1,1 +1,190 @@
- 
+ package com.ryuqq.crawlinghub.application.product.builder;
+ 
+ import com.ryuqq.crawlinghub.domain.product.ProductSnapshot;
+ import com.ryuqq.crawlinghub.domain.product.event.ChangeSource;
+ import com.ryuqq.crawlinghub.domain.product.event.FieldChange;
+ import com.ryuqq.crawlinghub.domain.product.event.ProductChangeEvent;
+ import org.springframework.context.ApplicationEventPublisher;
+ import org.springframework.stereotype.Component;
+ 
+ import java.time.LocalDateTime;
+ import java.util.HashMap;
+ import java.util.Map;
+ 
+ /**
+  * ProductSnapshot 빌더
+  *
+  * &lt;p&gt;역할: 부분 데이터를 받아서 Snapshot을 점진적으로 구축
+  *
+  * &lt;p&gt;처리 흐름:
+  * &lt;ol&gt;
+  *   &lt;li&gt;기존 Snapshot과 신규 데이터 비교 (변경 감지)&lt;/li&gt;
+  *   &lt;li&gt;변경된 필드만 Snapshot 업데이트&lt;/li&gt;
+  *   &lt;li&gt;ProductChangeEvent 발행&lt;/li&gt;
+  * &lt;/ol&gt;
+  *
+  * @author ryu-qqq
+  * @since 2025-11-07
+  */
+ @Component
+ public class ProductSnapshotBuilder {
+ 
+     private final ApplicationEventPublisher eventPublisher;
+ 
+     public ProductSnapshotBuilder(ApplicationEventPublisher eventPublisher) {
+         this.eventPublisher = eventPublisher;
+     }
+ 
+     /**
+      * 미니샵 데이터 적용
+      *
+      * @param snapshot 기존 Snapshot
+      * @param newData 신규 미니샵 데이터
+      * @return 업데이트된 Snapshot
+      */
+     public ProductSnapshot applyMiniShopData(ProductSnapshot snapshot, MiniShopData newData) {
+         Map&lt;String, FieldChange&gt; changes = new HashMap&lt;&gt;();
+ 
+         // 1. 상품명 변경 감지
+         if (!equals(snapshot.getProductName(), newData.productName())) {
+             changes.put(&quot;productName&quot;, new FieldChange(
+                 &quot;productName&quot;,
+                 snapshot.getProductName(),
+                 newData.productName()
+             ));
+             snapshot.updateProductName(newData.productName());
+         }
+ 
+         // 2. 가격 변경 감지
+         if (!equals(snapshot.getPrice(), newData.price())) {
+             changes.put(&quot;price&quot;, new FieldChange(
+                 &quot;price&quot;,
+                 snapshot.getPrice(),
+                 newData.price()
+             ));
+             snapshot.updatePrice(newData.price());
+         }
+ 
+         // 3. 메인 이미지 변경 감지
+         if (!equals(snapshot.getMainImageUrl(), newData.mainImageUrl())) {
+             changes.put(&quot;mainImageUrl&quot;, new FieldChange(
+                 &quot;mainImageUrl&quot;,
+                 snapshot.getMainImageUrl(),
+                 newData.mainImageUrl()
+             ));
+             snapshot.updateMainImage(newData.mainImageUrl());
+         }
+ 
+         // 4. 변경 사항이 있으면 Event 발행
+         if (!changes.isEmpty()) {
+             publishChangeEvent(snapshot.getIdValue(), ChangeSource.MINI_SHOP, changes);
+         }
+ 
+         return snapshot;
+     }
+ 
+     /**
+      * 옵션 데이터 적용
+      */
+     public ProductSnapshot applyOptionData(ProductSnapshot snapshot, OptionData newData) {
+         Map&lt;String, FieldChange&gt; changes = new HashMap&lt;&gt;();
+ 
+         // 1. 옵션 변경 감지
+         if (!equals(snapshot.getOptions(), newData.options())) {
+             changes.put(&quot;options&quot;, new FieldChange(
+                 &quot;options&quot;,
+                 snapshot.getOptions(),
+                 newData.options()
+             ));
+             snapshot.updateOptions(newData.options());
+         }
+ 
+         // 2. 총 재고 변경 감지
+         if (!equals(snapshot.getTotalStock(), newData.totalStock())) {
+             changes.put(&quot;totalStock&quot;, new FieldChange(
+                 &quot;totalStock&quot;,
+                 snapshot.getTotalStock(),
+                 newData.totalStock()
+             ));
+             snapshot.updateTotalStock(newData.totalStock());
+         }
+ 
+         // 3. 변경 사항이 있으면 Event 발행
+         if (!changes.isEmpty()) {
+             publishChangeEvent(snapshot.getIdValue(), ChangeSource.OPTION, changes);
+         }
+ 
+         return snapshot;
+     }
+ 
+     /**
+      * 상세 데이터 적용
+      */
+     public ProductSnapshot applyDetailData(ProductSnapshot snapshot, DetailData newData) {
+         Map&lt;String, FieldChange&gt; changes = new HashMap&lt;&gt;();
+ 
+         // 1. 상품 정보 모듈 변경 감지
+         if (!equals(snapshot.getProductInfo(), newData.productInfo())) {
+             changes.put(&quot;productInfo&quot;, new FieldChange(
+                 &quot;productInfo&quot;,
+                 snapshot.getProductInfo(),
+                 newData.productInfo()
+             ));
+             snapshot.updateProductInfo(newData.productInfo());
+         }
+ 
+         // 2. 배송 모듈 변경 감지
+         if (!equals(snapshot.getShipping(), newData.shipping())) {
+             changes.put(&quot;shipping&quot;, new FieldChange(
+                 &quot;shipping&quot;,
+                 snapshot.getShipping(),
+                 newData.shipping()
+             ));
+             snapshot.updateShipping(newData.shipping());
+         }
+ 
+         // 3. 상세 정보 모듈 변경 감지
+         if (!equals(snapshot.getDetailInfo(), newData.detailInfo())) {
+             changes.put(&quot;detailInfo&quot;, new FieldChange(
+                 &quot;detailInfo&quot;,
+                 snapshot.getDetailInfo(),
+                 newData.detailInfo()
+             ));
+             snapshot.updateDetailInfo(newData.detailInfo());
+         }
+ 
+         // 4. 변경 사항이 있으면 Event 발행
+         if (!changes.isEmpty()) {
+             publishChangeEvent(snapshot.getIdValue(), ChangeSource.DETAIL, changes);
+         }
+ 
+         return snapshot;
+     }
+ 
+     /**
+      * ProductChangeEvent 발행
+      */
+     private void publishChangeEvent(Long productId, ChangeSource source, Map&lt;String, FieldChange&gt; changes) {
+         ProductChangeEvent event = new ProductChangeEvent(
+             productId,
+             source,
+             changes,
+             LocalDateTime.now()
+         );
+         eventPublisher.publishEvent(event);
+     }
+ 
+     /**
+      * 객체 동등성 비교 (null-safe)
+      */
+     private boolean equals(Object a, Object b) {
+         if (a == null &amp;&amp; b == null) {
+             return true;
+         }
+         if (a == null || b == null) {
+             return false;
+         }
+         return a.equals(b);
+     }
+ }
+ 
```

</details>

</tool-use>

---

<tool-use data-tool-type="generic" data-tool-name="todo_write">
<details><summary>Tool use: **todo_write** • Todo List</summary>

- [x] Phase 2-1: Port 인터페이스 정의
- [x] Phase 2-2: ProductSnapshotBuilder 구현
- [-] Phase 2-3: ExternalSyncOrchestrator 구현
- [ ] Phase 2-4: ProductSyncWorker 구현

</details>
</tool-use>

---



---


ExternalSyncOrchestrator 구현 중.


---

<tool-use data-tool-type="write" data-tool-name="write">

<details><summary>Tool use: **code_edit** • Edit file: application/src/main/java/com/ryuqq/crawlinghub/application/product/orchestrator/ExternalSyncOrchestrator.java</summary>

**Chunk 1**
Lines added: 104, lines removed: 1

```diff
@@ -1,1 +1,104 @@
- 
+ package com.ryuqq.crawlinghub.application.product.orchestrator;
+ 
+ import com.fasterxml.jackson.core.JsonProcessingException;
+ import com.fasterxml.jackson.databind.ObjectMapper;
+ import com.ryuqq.crawlinghub.application.product.port.out.LoadProductSnapshotPort;
+ import com.ryuqq.crawlinghub.application.product.port.out.SaveProductSyncOutboxPort;
+ import com.ryuqq.crawlinghub.domain.product.FullProductData;
+ import com.ryuqq.crawlinghub.domain.product.ProductSnapshot;
+ import com.ryuqq.crawlinghub.domain.product.ProductSyncOutbox;
+ import com.ryuqq.crawlinghub.domain.product.event.ProductChangeEvent;
+ import org.slf4j.Logger;
+ import org.slf4j.LoggerFactory;
+ import org.springframework.context.event.EventListener;
+ import org.springframework.scheduling.annotation.Async;
+ import org.springframework.stereotype.Service;
+ import org.springframework.transaction.annotation.Transactional;
+ 
+ /**
+  * 외부 동기화 오케스트레이터
+  *
+  * &lt;p&gt;역할: ProductChangeEvent를 구독하여 외부 동기화 트리거
+  *
+  * &lt;p&gt;처리 흐름:
+  * &lt;ol&gt;
+  *   &lt;li&gt;ProductChangeEvent 수신&lt;/li&gt;
+  *   &lt;li&gt;최신 Snapshot 조회&lt;/li&gt;
+  *   &lt;li&gt;완전성 검증&lt;/li&gt;
+  *   &lt;li&gt;Outbox에 전체 데이터 저장 (트랜잭션)&lt;/li&gt;
+  * &lt;/ol&gt;
+  *
+  * @author ryu-qqq
+  * @since 2025-11-07
+  */
+ @Service
+ public class ExternalSyncOrchestrator {
+ 
+     private static final Logger log = LoggerFactory.getLogger(ExternalSyncOrchestrator.class);
+ 
+     private final LoadProductSnapshotPort loadSnapshotPort;
+     private final SaveProductSyncOutboxPort saveOutboxPort;
+     private final ObjectMapper objectMapper;
+ 
+     public ExternalSyncOrchestrator(
+         LoadProductSnapshotPort loadSnapshotPort,
+         SaveProductSyncOutboxPort saveOutboxPort,
+         ObjectMapper objectMapper
+     ) {
+         this.loadSnapshotPort = loadSnapshotPort;
+         this.saveOutboxPort = saveOutboxPort;
+         this.objectMapper = objectMapper;
+     }
+ 
+     /**
+      * ProductChangeEvent 구독 → 외부 동기화 트리거
+      *
+      * &lt;p&gt;⚠️ Transaction 경계:
+      * &lt;ul&gt;
+      *   &lt;li&gt;트랜잭션 내부: Outbox 저장&lt;/li&gt;
+      *   &lt;li&gt;트랜잭션 외부: Worker가 Outbox Polling하여 외부 API 호출&lt;/li&gt;
+      * &lt;/ul&gt;
+      */
+     @EventListener
+     @Async
+     @Transactional
+     public void onProductChanged(ProductChangeEvent event) {
+         log.info(&quot;ProductChangeEvent 수신. productId={}, source={}, changedFields={}&quot;,
+             event.getProductId(), event.getSource(), event.getChangedFieldCount());
+ 
+         // 1. 최신 Snapshot 조회
+         ProductSnapshot snapshot = loadSnapshotPort.findById(event.getProductId())
+             .orElseThrow(() -&gt; new IllegalStateException(
+                 &quot;Snapshot을 찾을 수 없습니다: &quot; + event.getProductId()
+             ));
+ 
+         // 2. 완전성 검증
+         if (!snapshot.isReadyForSync()) {
+             log.warn(&quot;Snapshot 불완전. 동기화 연기. productId={}, isComplete={}&quot;,
+                 event.getProductId(), snapshot.isComplete());
+             return;
+         }
+ 
+         // 3. FullProductData 변환
+         FullProductData fullData = snapshot.toFullProductData();
+ 
+         // 4. JSON 직렬화
+         String productJson;
+         try {
+             productJson = objectMapper.writeValueAsString(fullData);
+         } catch (JsonProcessingException e) {
+             log.error(&quot;JSON 직렬화 실패. productId={}&quot;, event.getProductId(), e);
+             return;
+         }
+ 
+         // 5. Outbox에 동기화 작업 저장 (트랜잭션 보장)
+         ProductSyncOutbox outbox = ProductSyncOutbox.create(
+             event.getProductId(),
+             productJson
+         );
+         saveOutboxPort.save(outbox);
+ 
+         log.info(&quot;Outbox 저장 완료. productId={}, status=PENDING&quot;, event.getProductId());
+     }
+ }
+ 
```

</details>

</tool-use>

---

<tool-use data-tool-type="generic" data-tool-name="todo_write">
<details><summary>Tool use: **todo_write** • Todo List</summary>

- [x] Phase 2-1: Port 인터페이스 정의
- [x] Phase 2-2: ProductSnapshotBuilder 구현
- [x] Phase 2-3: ExternalSyncOrchestrator 구현
- [-] Phase 2-4: ProductSyncWorker 구현

</details>
</tool-use>

---



---


ProductSyncWorker 구현 중.


---

<tool-use data-tool-type="write" data-tool-name="write">

<details><summary>Tool use: **code_edit** • Edit file: application/src/main/java/com/ryuqq/crawlinghub/application/product/worker/ProductSyncWorker.java</summary>

**Chunk 1**
Lines added: 121, lines removed: 1

```diff
@@ -1,1 +1,121 @@
- 
+ package com.ryuqq.crawlinghub.application.product.worker;
+ 
+ import com.ryuqq.crawlinghub.application.product.port.out.ExternalProductApiPort;
+ import com.ryuqq.crawlinghub.application.product.port.out.LoadProductSyncOutboxPort;
+ import com.ryuqq.crawlinghub.application.product.port.out.SaveProductSyncOutboxPort;
+ import com.ryuqq.crawlinghub.domain.product.ProductSyncOutbox;
+ import com.ryuqq.crawlinghub.domain.product.SyncStatus;
+ import org.slf4j.Logger;
+ import org.slf4j.LoggerFactory;
+ import org.springframework.scheduling.annotation.Scheduled;
+ import org.springframework.stereotype.Component;
+ import org.springframework.transaction.annotation.Transactional;
+ 
+ import java.util.List;
+ 
+ /**
+  * 상품 동기화 워커
+  *
+  * &lt;p&gt;역할: Outbox Pattern으로 외부 API 호출 (Polling Worker)
+  *
+  * &lt;p&gt;처리 흐름:
+  * &lt;ol&gt;
+  *   &lt;li&gt;PENDING 상태 Outbox 조회 (최대 10개)&lt;/li&gt;
+  *   &lt;li&gt;외부 API 호출 (PUT /products/{id})&lt;/li&gt;
+  *   &lt;li&gt;성공 시: COMPLETED 상태로 변경&lt;/li&gt;
+  *   &lt;li&gt;실패 시: 재시도 카운트 증가, 최대 3회 초과 시 FAILED&lt;/li&gt;
+  * &lt;/ol&gt;
+  *
+  * @author ryu-qqq
+  * @since 2025-11-07
+  */
+ @Component
+ public class ProductSyncWorker {
+ 
+     private static final Logger log = LoggerFactory.getLogger(ProductSyncWorker.class);
+     private static final int BATCH_SIZE = 10;
+ 
+     private final LoadProductSyncOutboxPort loadOutboxPort;
+     private final SaveProductSyncOutboxPort saveOutboxPort;
+     private final ExternalProductApiPort externalApiPort;
+ 
+     public ProductSyncWorker(
+         LoadProductSyncOutboxPort loadOutboxPort,
+         SaveProductSyncOutboxPort saveOutboxPort,
+         ExternalProductApiPort externalApiPort
+     ) {
+         this.loadOutboxPort = loadOutboxPort;
+         this.saveOutboxPort = saveOutboxPort;
+         this.externalApiPort = externalApiPort;
+     }
+ 
+     /**
+      * 5초마다 PENDING 상태 Outbox 처리
+      *
+      * &lt;p&gt;⚠️ Transaction 경계:
+      * &lt;ul&gt;
+      *   &lt;li&gt;각 Outbox별로 별도 트랜잭션&lt;/li&gt;
+      *   &lt;li&gt;외부 API 호출은 트랜잭션 밖에서&lt;/li&gt;
+      * &lt;/ul&gt;
+      */
+     @Scheduled(fixedDelay = 5000)
+     public void syncPendingProducts() {
+         List&lt;ProductSyncOutbox&gt; pendingOutboxes = loadOutboxPort
+             .findByStatus(SyncStatus.PENDING, BATCH_SIZE);
+ 
+         if (pendingOutboxes.isEmpty()) {
+             return;
+         }
+ 
+         log.info(&quot;PENDING Outbox 처리 시작. count={}&quot;, pendingOutboxes.size());
+ 
+         for (ProductSyncOutbox outbox : pendingOutboxes) {
+             processOutbox(outbox);
+         }
+ 
+         log.info(&quot;PENDING Outbox 처리 완료. count={}&quot;, pendingOutboxes.size());
+     }
+ 
+     /**
+      * 개별 Outbox 처리 (별도 트랜잭션)
+      */
+     @Transactional
+     protected void processOutbox(ProductSyncOutbox outbox) {
+         try {
+             log.info(&quot;Outbox 처리 시작. outboxId={}, productId={}, retryCount={}&quot;,
+                 outbox.getIdValue(), outbox.getProductId(), outbox.getRetryCount());
+ 
+             // 1. 처리 중 상태로 변경
+             outbox.markAsProcessing();
+             saveOutboxPort.save(outbox);
+ 
+             // 2. 외부 API 호출 (트랜잭션 밖에서)
+             externalApiPort.updateProduct(outbox.getProductJson());
+ 
+             // 3. 성공 시 COMPLETED 상태로 변경
+             outbox.markAsCompleted();
+             saveOutboxPort.save(outbox);
+ 
+             log.info(&quot;외부 동기화 완료. outboxId={}, productId={}&quot;,
+                 outbox.getIdValue(), outbox.getProductId());
+ 
+         } catch (Exception e) {
+             log.error(&quot;외부 동기화 실패. outboxId={}, productId={}, error={}&quot;,
+                 outbox.getIdValue(), outbox.getProductId(), e.getMessage(), e);
+ 
+             // 4. 실패 시 재시도 카운트 증가
+             outbox.incrementRetryCount();
+             outbox.recordError(e.getMessage());
+ 
+             // 5. 최대 재시도 횟수 초과 시 FAILED
+             if (outbox.isMaxRetriesExceeded()) {
+                 outbox.markAsFailed();
+                 log.error(&quot;최대 재시도 횟수 초과. Dead Letter Queue 이동. outboxId={}, productId={}&quot;,
+                     outbox.getIdValue(), outbox.getProductId());
+             }
+ 
+             saveOutboxPort.save(outbox);
+         }
+     }
+ }
+ 
```

</details>

</tool-use>

---

<tool-use data-tool-type="generic" data-tool-name="read_lints">
<details>
          <summary>Tool use: **read_lints** • Read lints for 1 file</summary>
      
Lint paths:

- `application/src/main/java/com/ryuqq/crawlinghub/application/product`

Lint results

Lint errors for `application/src/main/java/com/ryuqq/crawlinghub/application/product/manager/ProductManager.java`


| Message | Range | Severity |
|-------|-------|----------|
| The import com.ryuqq.crawlinghub.domain.product.ProductId is never used | 9:8-9:54 | DIAGNOSTIC_SEVERITY_WARNING |


</details>
</tool-use>

---

<tool-use data-tool-type="generic" data-tool-name="todo_write">
<details><summary>Tool use: **todo_write** • Todo List</summary>

- [x] Phase 2-1: Port 인터페이스 정의
- [x] Phase 2-2: ProductSnapshotBuilder 구현
- [x] Phase 2-3: ExternalSyncOrchestrator 구현
- [x] Phase 2-4: ProductSyncWorker 구현

</details>
</tool-use>

---



---


Phase 2 완료. Phase 3로 진행: Persistence Layer 구현. 먼저 persistence 레이어 구조를 확인합니다.


---

<tool-use data-tool-type="generic" data-tool-name="list_dir">
<details>
            <summary>Tool use: **list_directory** • Listed directory undefined • **0** results</summary>
        
No results found
</details>
</tool-use>

---

<tool-use data-tool-type="search" data-tool-name="codebase_search">
<details>
                <summary>Tool use: **codebase_search** • Searched codebase "Entity JPA entity repository implementation" • **5** results</summary>
            
| File | Lines |
|------|-------|
| `adapter-out/persistence-mysql/src/main/java/com/ryuqq/crawlinghub/adapter/out/persistence/config/JpaConfig.java` | L12-139 |
| `adapter-out/persistence-mysql/src/main/java/com/ryuqq/crawlinghub/adapter/out/persistence/common/entity/SoftDeletableEntity.java` | L51 |
| `adapter-out/persistence-mysql/src/main/java/com/ryuqq/crawlinghub/adapter/out/persistence/config/JpaConfig.java` | L38 |
| `adapter-out/persistence-mysql/src/main/java/com/ryuqq/crawlinghub/adapter/out/persistence/common/entity/SoftDeletableEntity.java` | L3-117 |
| `adapter-out/persistence-mysql/src/main/java/com/ryuqq/crawlinghub/adapter/out/persistence/common/entity/BaseAuditEntity.java` | L39 |

</details>
</tool-use>

---

<tool-use data-tool-type="generic" data-tool-name="todo_write">
<details><summary>Tool use: **todo_write** • Todo List</summary>

- [-] Phase 3-1: ProductSnapshotEntity + Repository 구현
- [ ] Phase 3-2: ProductSyncOutboxEntity + Repository 구현
- [ ] Phase 3-3: Mapper 구현
- [ ] Phase 3-4: 데이터베이스 마이그레이션

</details>
</tool-use>

---



---


기존 Entity 패턴을 확인하고, ProductSnapshotEntity와 Repository 구현을 시작합니다.


---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: adapter-out/persistence-mysql/src/main/java/com/ryuqq/crawlinghub/adapter/out/persistence/schedule/entity/ScheduleEntity.java</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: adapter-out/persistence-mysql/src/main/java/com/ryuqq/crawlinghub/adapter/out/persistence/schedule/repository/ScheduleJpaRepository.java</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: adapter-out/persistence-mysql/src/main/java/com/ryuqq/crawlinghub/adapter/out/persistence/schedule/mapper/ScheduleMapper.java</summary>

</details>
</tool-use>

---



---


ProductSnapshotEntity와 Repository 구현 중.


---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: adapter-out/persistence-mysql/src/main/java/com/ryuqq/crawlinghub/adapter/out/persistence/common/entity/BaseAuditEntity.java</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="search" data-tool-name="codebase_search">
<details>
                <summary>Tool use: **codebase_search** • Searched codebase "JSON column type MySQL JPA entity" • **1** results</summary>
            
| File | Lines |
|------|-------|
| `adapter-out/persistence-mysql/src/main/java/com/ryuqq/crawlinghub/adapter/out/persistence/common/entity/SoftDeletableEntity.java` | L3-117 |

</details>
</tool-use>

---



---


ProductSnapshotEntity와 Repository 구현 중. 문서의 스키마에 맞춰 JSON 필드는 MySQL JSON 타입으로 매핑합니다.


---

<tool-use data-tool-type="write" data-tool-name="write">

<details><summary>Tool use: **code_edit** • Edit file: adapter-out/persistence-mysql/src/main/java/com/ryuqq/crawlinghub/adapter/out/persistence/product/entity/ProductSnapshotEntity.java</summary>

**Chunk 1**
Lines added: 281, lines removed: 1

```diff
@@ -1,1 +1,281 @@
- 
+ package com.ryuqq.crawlinghub.adapter.out.persistence.product.entity;
+ 
+ import com.ryuqq.crawlinghub.adapter.out.persistence.common.entity.BaseAuditEntity;
+ import jakarta.persistence.*;
+ import java.time.LocalDateTime;
+ import java.util.Objects;
+ 
+ /**
+  * ProductSnapshot JPA Entity
+  *
+  * &lt;p&gt;테이블: product_snapshot&lt;/p&gt;
+  *
+  * &lt;p&gt;&lt;strong&gt;컨벤션 준수:&lt;/strong&gt;&lt;/p&gt;
+  * &lt;ul&gt;
+  *   &lt;li&gt;✅ Lombok 금지 - Pure Java&lt;/li&gt;
+  *   &lt;li&gt;✅ 3-생성자 패턴: no-args, create, reconstitute&lt;/li&gt;
+  *   &lt;li&gt;✅ Long FK 전략 - sellerId는 Long 타입&lt;/li&gt;
+  *   &lt;li&gt;✅ 불변성 - final 필드 사용&lt;/li&gt;
+  * &lt;/ul&gt;
+  *
+  * @author ryu-qqq
+  * @since 2025-11-07
+  */
+ @Entity
+ @Table(
+     name = &quot;product_snapshot&quot;,
+     uniqueConstraints = {
+         @UniqueConstraint(columnNames = {&quot;must_it_item_no&quot;, &quot;seller_id&quot;})
+     },
+     indexes = {
+         @Index(name = &quot;idx_last_synced&quot;, columnList = &quot;last_synced_at&quot;)
+     }
+ )
+ public class ProductSnapshotEntity extends BaseAuditEntity {
+ 
+     @Id
+     @GeneratedValue(strategy = GenerationType.IDENTITY)
+     private final Long id;
+ 
+     @Column(name = &quot;must_it_item_no&quot;, nullable = false)
+     private final Long mustItItemNo;
+ 
+     @Column(name = &quot;seller_id&quot;, nullable = false)
+     private final Long sellerId;
+ 
+     // 미니샵 데이터
+     @Column(name = &quot;product_name&quot;, length = 500)
+     private final String productName;
+ 
+     @Column(name = &quot;price&quot;)
+     private final Long price;
+ 
+     @Column(name = &quot;main_image_url&quot;, length = 1000)
+     private final String mainImageUrl;
+ 
+     // 옵션 데이터
+     @Column(name = &quot;options&quot;, columnDefinition = &quot;JSON&quot;)
+     private final String options;
+ 
+     @Column(name = &quot;total_stock&quot;)
+     private final Integer totalStock;
+ 
+     // 상세 데이터
+     @Column(name = &quot;product_info&quot;, columnDefinition = &quot;JSON&quot;)
+     private final String productInfo;
+ 
+     @Column(name = &quot;shipping&quot;, columnDefinition = &quot;JSON&quot;)
+     private final String shipping;
+ 
+     @Column(name = &quot;detail_info&quot;, columnDefinition = &quot;JSON&quot;)
+     private final String detailInfo;
+ 
+     // 메타 정보
+     @Column(name = &quot;last_synced_at&quot;)
+     private final LocalDateTime lastSyncedAt;
+ 
+     @Column(name = &quot;version&quot;, nullable = false)
+     private final Integer version;
+ 
+     /**
+      * No-args 생성자 (JPA 필수)
+      */
+     protected ProductSnapshotEntity() {
+         super();
+         this.id = null;
+         this.mustItItemNo = null;
+         this.sellerId = null;
+         this.productName = null;
+         this.price = null;
+         this.mainImageUrl = null;
+         this.options = null;
+         this.totalStock = null;
+         this.productInfo = null;
+         this.shipping = null;
+         this.detailInfo = null;
+         this.lastSyncedAt = null;
+         this.version = null;
+     }
+ 
+     /**
+      * 신규 생성용 생성자 (ID 없음)
+      */
+     protected ProductSnapshotEntity(
+         Long mustItItemNo,
+         Long sellerId
+     ) {
+         super();
+         this.id = null;
+         this.mustItItemNo = Objects.requireNonNull(mustItItemNo, &quot;mustItItemNo must not be null&quot;);
+         this.sellerId = Objects.requireNonNull(sellerId, &quot;sellerId must not be null&quot;);
+         this.productName = null;
+         this.price = null;
+         this.mainImageUrl = null;
+         this.options = null;
+         this.totalStock = null;
+         this.productInfo = null;
+         this.shipping = null;
+         this.detailInfo = null;
+         this.lastSyncedAt = null;
+         this.version = 1;
+         initializeAuditFields();
+     }
+ 
+     /**
+      * Static Factory Method - 신규 생성
+      */
+     public static ProductSnapshotEntity create(
+         Long mustItItemNo,
+         Long sellerId
+     ) {
+         return new ProductSnapshotEntity(mustItItemNo, sellerId);
+     }
+ 
+     /**
+      * DB reconstitute용 전체 생성자
+      */
+     private ProductSnapshotEntity(
+         Long id,
+         Long mustItItemNo,
+         Long sellerId,
+         String productName,
+         Long price,
+         String mainImageUrl,
+         String options,
+         Integer totalStock,
+         String productInfo,
+         String shipping,
+         String detailInfo,
+         LocalDateTime lastSyncedAt,
+         Integer version,
+         LocalDateTime createdAt,
+         LocalDateTime updatedAt
+     ) {
+         super(createdAt, updatedAt);
+         this.id = id;
+         this.mustItItemNo = Objects.requireNonNull(mustItItemNo, &quot;mustItItemNo must not be null&quot;);
+         this.sellerId = Objects.requireNonNull(sellerId, &quot;sellerId must not be null&quot;);
+         this.productName = productName;
+         this.price = price;
+         this.mainImageUrl = mainImageUrl;
+         this.options = options;
+         this.totalStock = totalStock;
+         this.productInfo = productInfo;
+         this.shipping = shipping;
+         this.detailInfo = detailInfo;
+         this.lastSyncedAt = lastSyncedAt;
+         this.version = Objects.requireNonNull(version, &quot;version must not be null&quot;);
+     }
+ 
+     /**
+      * Static Factory Method - DB reconstitute
+      */
+     public static ProductSnapshotEntity reconstitute(
+         Long id,
+         Long mustItItemNo,
+         Long sellerId,
+         String productName,
+         Long price,
+         String mainImageUrl,
+         String options,
+         Integer totalStock,
+         String productInfo,
+         String shipping,
+         String detailInfo,
+         LocalDateTime lastSyncedAt,
+         Integer version,
+         LocalDateTime createdAt,
+         LocalDateTime updatedAt
+     ) {
+         return new ProductSnapshotEntity(
+             id, mustItItemNo, sellerId,
+             productName, price, mainImageUrl,
+             options, totalStock,
+             productInfo, shipping, detailInfo,
+             lastSyncedAt, version,
+             createdAt, updatedAt
+         );
+     }
+ 
+     // Getters
+ 
+     public Long getId() {
+         return id;
+     }
+ 
+     public Long getMustItItemNo() {
+         return mustItItemNo;
+     }
+ 
+     public Long getSellerId() {
+         return sellerId;
+     }
+ 
+     public String getProductName() {
+         return productName;
+     }
+ 
+     public Long getPrice() {
+         return price;
+     }
+ 
+     public String getMainImageUrl() {
+         return mainImageUrl;
+     }
+ 
+     public String getOptions() {
+         return options;
+     }
+ 
+     public Integer getTotalStock() {
+         return totalStock;
+     }
+ 
+     public String getProductInfo() {
+         return productInfo;
+     }
+ 
+     public String getShipping() {
+         return shipping;
+     }
+ 
+     public String getDetailInfo() {
+         return detailInfo;
+     }
+ 
+     public LocalDateTime getLastSyncedAt() {
+         return lastSyncedAt;
+     }
+ 
+     public Integer getVersion() {
+         return version;
+     }
+ 
+     @Override
+     public boolean equals(Object o) {
+         if (this == o) {
+             return true;
+         }
+         if (o == null || getClass() != o.getClass()) {
+             return false;
+         }
+         ProductSnapshotEntity that = (ProductSnapshotEntity) o;
+         return Objects.equals(id, that.id);
+     }
+ 
+     @Override
+     public int hashCode() {
+         return Objects.hash(id);
+     }
+ 
+     @Override
+     public String toString() {
+         return &quot;ProductSnapshotEntity{&quot; +
+             &quot;id=&quot; + id +
+             &quot;, mustItItemNo=&quot; + mustItItemNo +
+             &quot;, sellerId=&quot; + sellerId +
+             &quot;, version=&quot; + version +
+             &#39;}&#39;;
+     }
+ }
+ 
```

</details>

</tool-use>

---

<tool-use data-tool-type="write" data-tool-name="write">

<details><summary>Tool use: **code_edit** • Edit file: adapter-out/persistence-mysql/src/main/java/com/ryuqq/crawlinghub/adapter/out/persistence/product/repository/ProductSnapshotJpaRepository.java</summary>

**Chunk 1**
Lines added: 32, lines removed: 1

```diff
@@ -1,1 +1,32 @@
- 
+ package com.ryuqq.crawlinghub.adapter.out.persistence.product.repository;
+ 
+ import com.ryuqq.crawlinghub.adapter.out.persistence.product.entity.ProductSnapshotEntity;
+ import org.springframework.data.jpa.repository.JpaRepository;
+ 
+ import java.util.Optional;
+ 
+ /**
+  * ProductSnapshot JPA Repository
+  *
+  * &lt;p&gt;&lt;strong&gt;컨벤션 준수:&lt;/strong&gt;&lt;/p&gt;
+  * &lt;ul&gt;
+  *   &lt;li&gt;✅ Spring Data JPA 사용&lt;/li&gt;
+  *   &lt;li&gt;✅ Query 메서드 네이밍 규칙 준수&lt;/li&gt;
+  *   &lt;li&gt;✅ Optional 반환 (findBy...)&lt;/li&gt;
+  * &lt;/ul&gt;
+  *
+  * @author ryu-qqq
+  * @since 2025-11-07
+  */
+ public interface ProductSnapshotJpaRepository extends JpaRepository&lt;ProductSnapshotEntity, Long&gt; {
+ 
+     /**
+      * Mustit 상품 번호 + Seller ID로 조회
+      *
+      * @param mustItItemNo 머스트잇 상품 번호
+      * @param sellerId 셀러 ID (Long FK)
+      * @return ProductSnapshot (Optional)
+      */
+     Optional&lt;ProductSnapshotEntity&gt; findByMustItItemNoAndSellerId(Long mustItItemNo, Long sellerId);
+ }
+ 
```

</details>

</tool-use>

---



---


ProductSyncOutboxEntity와 Repository 구현 중.


---

<tool-use data-tool-type="write" data-tool-name="write">

<details><summary>Tool use: **code_edit** • Edit file: adapter-out/persistence-mysql/src/main/java/com/ryuqq/crawlinghub/adapter/out/persistence/product/entity/ProductSyncOutboxEntity.java</summary>

**Chunk 1**
Lines added: 211, lines removed: 1

```diff
@@ -1,1 +1,211 @@
- 
+ package com.ryuqq.crawlinghub.adapter.out.persistence.product.entity;
+ 
+ import com.ryuqq.crawlinghub.adapter.out.persistence.common.entity.BaseAuditEntity;
+ import jakarta.persistence.*;
+ import java.time.LocalDateTime;
+ import java.util.Objects;
+ 
+ /**
+  * ProductSyncOutbox JPA Entity
+  *
+  * &lt;p&gt;테이블: product_sync_outbox&lt;/p&gt;
+  *
+  * &lt;p&gt;&lt;strong&gt;컨벤션 준수:&lt;/strong&gt;&lt;/p&gt;
+  * &lt;ul&gt;
+  *   &lt;li&gt;✅ Lombok 금지 - Pure Java&lt;/li&gt;
+  *   &lt;li&gt;✅ 3-생성자 패턴: no-args, create, reconstitute&lt;/li&gt;
+  *   &lt;li&gt;✅ Long FK 전략 - productId는 Long 타입&lt;/li&gt;
+  *   &lt;li&gt;✅ 불변성 - final 필드 사용&lt;/li&gt;
+  * &lt;/ul&gt;
+  *
+  * @author ryu-qqq
+  * @since 2025-11-07
+  */
+ @Entity
+ @Table(
+     name = &quot;product_sync_outbox&quot;,
+     indexes = {
+         @Index(name = &quot;idx_status_created&quot;, columnList = &quot;status, created_at&quot;)
+     }
+ )
+ public class ProductSyncOutboxEntity extends BaseAuditEntity {
+ 
+     @Id
+     @GeneratedValue(strategy = GenerationType.IDENTITY)
+     private final Long id;
+ 
+     @Column(name = &quot;product_id&quot;, nullable = false)
+     private final Long productId;
+ 
+     @Column(name = &quot;product_json&quot;, columnDefinition = &quot;JSON&quot;, nullable = false)
+     private final String productJson;
+ 
+     @Enumerated(EnumType.STRING)
+     @Column(name = &quot;status&quot;, nullable = false, length = 20)
+     private final SyncStatus status;
+ 
+     @Column(name = &quot;retry_count&quot;, nullable = false)
+     private final Integer retryCount;
+ 
+     @Column(name = &quot;error_message&quot;, columnDefinition = &quot;TEXT&quot;)
+     private final String errorMessage;
+ 
+     @Column(name = &quot;processed_at&quot;)
+     private final LocalDateTime processedAt;
+ 
+     /**
+      * 동기화 상태 Enum
+      */
+     public enum SyncStatus {
+         PENDING,
+         PROCESSING,
+         COMPLETED,
+         FAILED
+     }
+ 
+     /**
+      * No-args 생성자 (JPA 필수)
+      */
+     protected ProductSyncOutboxEntity() {
+         super();
+         this.id = null;
+         this.productId = null;
+         this.productJson = null;
+         this.status = null;
+         this.retryCount = null;
+         this.errorMessage = null;
+         this.processedAt = null;
+     }
+ 
+     /**
+      * 신규 생성용 생성자 (ID 없음)
+      */
+     protected ProductSyncOutboxEntity(
+         Long productId,
+         String productJson
+     ) {
+         super();
+         this.id = null;
+         this.productId = Objects.requireNonNull(productId, &quot;productId must not be null&quot;);
+         this.productJson = Objects.requireNonNull(productJson, &quot;productJson must not be null&quot;);
+         this.status = SyncStatus.PENDING;
+         this.retryCount = 0;
+         this.errorMessage = null;
+         this.processedAt = null;
+         initializeAuditFields();
+     }
+ 
+     /**
+      * Static Factory Method - 신규 생성
+      */
+     public static ProductSyncOutboxEntity create(
+         Long productId,
+         String productJson
+     ) {
+         return new ProductSyncOutboxEntity(productId, productJson);
+     }
+ 
+     /**
+      * DB reconstitute용 전체 생성자
+      */
+     private ProductSyncOutboxEntity(
+         Long id,
+         Long productId,
+         String productJson,
+         SyncStatus status,
+         Integer retryCount,
+         String errorMessage,
+         LocalDateTime processedAt,
+         LocalDateTime createdAt,
+         LocalDateTime updatedAt
+     ) {
+         super(createdAt, updatedAt);
+         this.id = id;
+         this.productId = Objects.requireNonNull(productId, &quot;productId must not be null&quot;);
+         this.productJson = Objects.requireNonNull(productJson, &quot;productJson must not be null&quot;);
+         this.status = Objects.requireNonNull(status, &quot;status must not be null&quot;);
+         this.retryCount = Objects.requireNonNull(retryCount, &quot;retryCount must not be null&quot;);
+         this.errorMessage = errorMessage;
+         this.processedAt = processedAt;
+     }
+ 
+     /**
+      * Static Factory Method - DB reconstitute
+      */
+     public static ProductSyncOutboxEntity reconstitute(
+         Long id,
+         Long productId,
+         String productJson,
+         SyncStatus status,
+         Integer retryCount,
+         String errorMessage,
+         LocalDateTime processedAt,
+         LocalDateTime createdAt,
+         LocalDateTime updatedAt
+     ) {
+         return new ProductSyncOutboxEntity(
+             id, productId, productJson,
+             status, retryCount, errorMessage,
+             processedAt,
+             createdAt, updatedAt
+         );
+     }
+ 
+     // Getters
+ 
+     public Long getId() {
+         return id;
+     }
+ 
+     public Long getProductId() {
+         return productId;
+     }
+ 
+     public String getProductJson() {
+         return productJson;
+     }
+ 
+     public SyncStatus getStatus() {
+         return status;
+     }
+ 
+     public Integer getRetryCount() {
+         return retryCount;
+     }
+ 
+     public String getErrorMessage() {
+         return errorMessage;
+     }
+ 
+     public LocalDateTime getProcessedAt() {
+         return processedAt;
+     }
+ 
+     @Override
+     public boolean equals(Object o) {
+         if (this == o) {
+             return true;
+         }
+         if (o == null || getClass() != o.getClass()) {
+             return false;
+         }
+         ProductSyncOutboxEntity that = (ProductSyncOutboxEntity) o;
+         return Objects.equals(id, that.id);
+     }
+ 
+     @Override
+     public int hashCode() {
+         return Objects.hash(id);
+     }
+ 
+     @Override
+     public String toString() {
+         return &quot;ProductSyncOutboxEntity{&quot; +
+             &quot;id=&quot; + id +
+             &quot;, productId=&quot; + productId +
+             &quot;, status=&quot; + status +
+             &quot;, retryCount=&quot; + retryCount +
+             &#39;}&#39;;
+     }
+ }
+ 
```

</details>

</tool-use>

---

<tool-use data-tool-type="write" data-tool-name="write">

<details><summary>Tool use: **code_edit** • Edit file: adapter-out/persistence-mysql/src/main/java/com/ryuqq/crawlinghub/adapter/out/persistence/product/repository/ProductSyncOutboxJpaRepository.java</summary>

**Chunk 1**
Lines added: 35, lines removed: 1

```diff
@@ -1,1 +1,35 @@
- 
+ package com.ryuqq.crawlinghub.adapter.out.persistence.product.repository;
+ 
+ import com.ryuqq.crawlinghub.adapter.out.persistence.product.entity.ProductSyncOutboxEntity;
+ import org.springframework.data.jpa.repository.JpaRepository;
+ import org.springframework.data.jpa.repository.Query;
+ import org.springframework.data.repository.query.Param;
+ 
+ import java.util.List;
+ 
+ /**
+  * ProductSyncOutbox JPA Repository
+  *
+  * &lt;p&gt;&lt;strong&gt;컨벤션 준수:&lt;/strong&gt;&lt;/p&gt;
+  * &lt;ul&gt;
+  *   &lt;li&gt;✅ Spring Data JPA 사용&lt;/li&gt;
+  *   &lt;li&gt;✅ Query 메서드 네이밍 규칙 준수&lt;/li&gt;
+  *   &lt;li&gt;✅ List 반환 (findByStatus)&lt;/li&gt;
+  * &lt;/ul&gt;
+  *
+  * @author ryu-qqq
+  * @since 2025-11-07
+  */
+ public interface ProductSyncOutboxJpaRepository extends JpaRepository&lt;ProductSyncOutboxEntity, Long&gt; {
+ 
+     /**
+      * 상태로 ProductSyncOutbox 목록 조회 (생성 시간 순)
+      *
+      * @param status 동기화 상태
+      * @param limit 최대 조회 개수
+      * @return ProductSyncOutbox 목록
+      */
+     @Query(&quot;SELECT o FROM ProductSyncOutboxEntity o WHERE o.status = :status ORDER BY o.createdAt ASC&quot;)
+     List&lt;ProductSyncOutboxEntity&gt; findByStatusOrderByCreatedAtAsc(@Param(&quot;status&quot;) ProductSyncOutboxEntity.SyncStatus status);
+ }
+ 
```

</details>

</tool-use>

---

<tool-use data-tool-type="generic" data-tool-name="todo_write">
<details><summary>Tool use: **todo_write** • Todo List</summary>

- [x] Phase 3-1: ProductSnapshotEntity + Repository 구현
- [x] Phase 3-2: ProductSyncOutboxEntity + Repository 구현
- [-] Phase 3-3: Mapper 구현
- [ ] Phase 3-4: 데이터베이스 마이그레이션

</details>
</tool-use>

---



---


Mapper 구현 중. JSON 필드 변환을 위해 ObjectMapper를 사용합니다.


---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: adapter-out/persistence-mysql/src/main/java/com/ryuqq/crawlinghub/adapter/out/persistence/schedule/adapter/ScheduleCommandAdapter.java</summary>

</details>
</tool-use>

---



---


Mapper 구현 중. JSON 필드 변환을 위해 ObjectMapper를 사용합니다.


---

<tool-use data-tool-type="write" data-tool-name="write">

<details><summary>Tool use: **code_edit** • Edit file: adapter-out/persistence-mysql/src/main/java/com/ryuqq/crawlinghub/adapter/out/persistence/product/mapper/ProductSnapshotMapper.java</summary>

**Chunk 1**
Lines added: 141, lines removed: 1

```diff
@@ -1,1 +1,141 @@
- 
+ package com.ryuqq.crawlinghub.adapter.out.persistence.product.mapper;
+ 
+ import com.fasterxml.jackson.core.JsonProcessingException;
+ import com.fasterxml.jackson.core.type.TypeReference;
+ import com.fasterxml.jackson.databind.ObjectMapper;
+ import com.ryuqq.crawlinghub.adapter.out.persistence.product.entity.ProductSnapshotEntity;
+ import com.ryuqq.crawlinghub.domain.product.*;
+ import com.ryuqq.crawlinghub.domain.seller.MustitSellerId;
+ import org.springframework.stereotype.Component;
+ 
+ import java.util.ArrayList;
+ import java.util.List;
+ import java.util.Objects;
+ 
+ /**
+  * ProductSnapshot Mapper (Pure Java)
+  *
+  * &lt;p&gt;Entity ↔ Domain 변환을 담당합니다.&lt;/p&gt;
+  *
+  * &lt;p&gt;&lt;strong&gt;컨벤션 준수:&lt;/strong&gt;&lt;/p&gt;
+  * &lt;ul&gt;
+  *   &lt;li&gt;✅ MapStruct 금지 - Pure Java 사용&lt;/li&gt;
+  *   &lt;li&gt;✅ @Component (Spring Bean 등록)&lt;/li&gt;
+  *   &lt;li&gt;✅ Value Object 수동 변환&lt;/li&gt;
+  *   &lt;li&gt;✅ Null 체크 및 검증&lt;/li&gt;
+  *   &lt;li&gt;✅ JSON 필드 변환 (ObjectMapper 사용)&lt;/li&gt;
+  * &lt;/ul&gt;
+  *
+  * @author ryu-qqq
+  * @since 2025-11-07
+  */
+ @Component
+ public class ProductSnapshotMapper {
+ 
+     private final ObjectMapper objectMapper;
+ 
+     public ProductSnapshotMapper(ObjectMapper objectMapper) {
+         this.objectMapper = Objects.requireNonNull(objectMapper, &quot;objectMapper must not be null&quot;);
+     }
+ 
+     /**
+      * Domain → Entity 변환
+      *
+      * &lt;p&gt;Domain Model의 ID가 null이면 신규 생성 Entity 반환&lt;/p&gt;
+      */
+     public ProductSnapshotEntity toEntity(ProductSnapshot snapshot) {
+         Objects.requireNonNull(snapshot, &quot;snapshot must not be null&quot;);
+ 
+         Long id = snapshot.getIdValue();
+         Long mustItItemNo = snapshot.getMustItItemNo();
+         Long sellerId = snapshot.getSellerIdValue();
+ 
+         String optionsJson = toJson(snapshot.getOptions());
+         String productInfoJson = toJson(snapshot.getProductInfo());
+         String shippingJson = toJson(snapshot.getShipping());
+         String detailInfoJson = toJson(snapshot.getDetailInfo());
+ 
+         if (id == null) {
+             // 신규 생성 Entity
+             return ProductSnapshotEntity.create(mustItItemNo, sellerId);
+         } else {
+             // DB reconstitute Entity
+             return ProductSnapshotEntity.reconstitute(
+                 id,
+                 mustItItemNo,
+                 sellerId,
+                 snapshot.getProductName(),
+                 snapshot.getPrice(),
+                 snapshot.getMainImageUrl(),
+                 optionsJson,
+                 snapshot.getTotalStock(),
+                 productInfoJson,
+                 shippingJson,
+                 detailInfoJson,
+                 snapshot.getLastSyncedAt(),
+                 snapshot.getVersion(),
+                 snapshot.getCreatedAt(),
+                 snapshot.getUpdatedAt()
+             );
+         }
+     }
+ 
+     /**
+      * Entity → Domain 변환
+      */
+     public ProductSnapshot toDomain(ProductSnapshotEntity entity) {
+         Objects.requireNonNull(entity, &quot;entity must not be null&quot;);
+ 
+         List&lt;ProductOption&gt; options = fromJson(entity.getOptions(), new TypeReference&lt;List&lt;ProductOption&gt;&gt;() {});
+         ProductInfoModule productInfo = fromJson(entity.getProductInfo(), new TypeReference&lt;ProductInfoModule&gt;() {});
+         ShippingModule shipping = fromJson(entity.getShipping(), new TypeReference&lt;ShippingModule&gt;() {});
+         ProductDetailInfoModule detailInfo = fromJson(entity.getDetailInfo(), new TypeReference&lt;ProductDetailInfoModule&gt;() {});
+ 
+         return ProductSnapshot.reconstitute(
+             ProductSnapshotId.of(entity.getId()),
+             entity.getMustItItemNo(),
+             MustitSellerId.of(entity.getSellerId()),
+             entity.getProductName(),
+             entity.getPrice(),
+             entity.getMainImageUrl(),
+             options,
+             entity.getTotalStock(),
+             productInfo,
+             shipping,
+             detailInfo,
+             entity.getLastSyncedAt(),
+             entity.getVersion(),
+             entity.getCreatedAt(),
+             entity.getUpdatedAt()
+         );
+     }
+ 
+     /**
+      * 객체를 JSON 문자열로 변환
+      */
+     private String toJson(Object obj) {
+         if (obj == null) {
+             return null;
+         }
+         try {
+             return objectMapper.writeValueAsString(obj);
+         } catch (JsonProcessingException e) {
+             throw new RuntimeException(&quot;JSON 직렬화 실패: &quot; + obj.getClass().getSimpleName(), e);
+         }
+     }
+ 
+     /**
+      * JSON 문자열을 객체로 변환
+      */
+     private &lt;T&gt; T fromJson(String json, TypeReference&lt;T&gt; typeRef) {
+         if (json == null || json.isBlank()) {
+             return null;
+         }
+         try {
+             return objectMapper.readValue(json, typeRef);
+         } catch (JsonProcessingException e) {
+             throw new RuntimeException(&quot;JSON 역직렬화 실패: &quot; + typeRef.getType(), e);
+         }
+     }
+ }
+ 
```

</details>

</tool-use>

---

<tool-use data-tool-type="write" data-tool-name="write">

<details><summary>Tool use: **code_edit** • Edit file: adapter-out/persistence-mysql/src/main/java/com/ryuqq/crawlinghub/adapter/out/persistence/product/mapper/ProductSyncOutboxMapper.java</summary>

**Chunk 1**
Lines added: 109, lines removed: 1

```diff
@@ -1,1 +1,109 @@
- 
+ package com.ryuqq.crawlinghub.adapter.out.persistence.product.mapper;
+ 
+ import com.ryuqq.crawlinghub.adapter.out.persistence.product.entity.ProductSyncOutboxEntity;
+ import com.ryuqq.crawlinghub.domain.product.ProductSyncOutbox;
+ import com.ryuqq.crawlinghub.domain.product.ProductSyncOutboxId;
+ import com.ryuqq.crawlinghub.domain.product.SyncStatus;
+ import org.springframework.stereotype.Component;
+ 
+ import java.util.Objects;
+ 
+ /**
+  * ProductSyncOutbox Mapper (Pure Java)
+  *
+  * &lt;p&gt;Entity ↔ Domain 변환을 담당합니다.&lt;/p&gt;
+  *
+  * &lt;p&gt;&lt;strong&gt;컨벤션 준수:&lt;/strong&gt;&lt;/p&gt;
+  * &lt;ul&gt;
+  *   &lt;li&gt;✅ MapStruct 금지 - Pure Java 사용&lt;/li&gt;
+  *   &lt;li&gt;✅ @Component (Spring Bean 등록)&lt;/li&gt;
+  *   &lt;li&gt;✅ Value Object 수동 변환&lt;/li&gt;
+  *   &lt;li&gt;✅ Null 체크 및 검증&lt;/li&gt;
+  * &lt;/ul&gt;
+  *
+  * @author ryu-qqq
+  * @since 2025-11-07
+  */
+ @Component
+ public class ProductSyncOutboxMapper {
+ 
+     /**
+      * Domain → Entity 변환
+      *
+      * &lt;p&gt;Domain Model의 ID가 null이면 신규 생성 Entity 반환&lt;/p&gt;
+      */
+     public ProductSyncOutboxEntity toEntity(ProductSyncOutbox outbox) {
+         Objects.requireNonNull(outbox, &quot;outbox must not be null&quot;);
+ 
+         Long id = outbox.getIdValue();
+         Long productId = outbox.getProductId();
+         String productJson = outbox.getProductJson();
+         SyncStatus domainStatus = outbox.getStatus();
+         ProductSyncOutboxEntity.SyncStatus entityStatus = toEntityStatus(domainStatus);
+ 
+         if (id == null) {
+             // 신규 생성 Entity
+             return ProductSyncOutboxEntity.create(productId, productJson);
+         } else {
+             // DB reconstitute Entity
+             return ProductSyncOutboxEntity.reconstitute(
+                 id,
+                 productId,
+                 productJson,
+                 entityStatus,
+                 outbox.getRetryCount(),
+                 outbox.getErrorMessage(),
+                 outbox.getProcessedAt(),
+                 outbox.getCreatedAt(),
+                 outbox.getUpdatedAt()
+             );
+         }
+     }
+ 
+     /**
+      * Entity → Domain 변환
+      */
+     public ProductSyncOutbox toDomain(ProductSyncOutboxEntity entity) {
+         Objects.requireNonNull(entity, &quot;entity must not be null&quot;);
+ 
+         return ProductSyncOutbox.reconstitute(
+             ProductSyncOutboxId.of(entity.getId()),
+             entity.getProductId(),
+             entity.getProductJson(),
+             toDomainStatus(entity.getStatus()),
+             entity.getRetryCount(),
+             entity.getErrorMessage(),
+             entity.getCreatedAt(),
+             entity.getProcessedAt()
+         );
+     }
+ 
+     /**
+      * Domain SyncStatus → Entity SyncStatus
+      */
+     private ProductSyncOutboxEntity.SyncStatus toEntityStatus(SyncStatus domainStatus) {
+         Objects.requireNonNull(domainStatus, &quot;domainStatus must not be null&quot;);
+ 
+         return switch (domainStatus) {
+             case PENDING -&gt; ProductSyncOutboxEntity.SyncStatus.PENDING;
+             case PROCESSING -&gt; ProductSyncOutboxEntity.SyncStatus.PROCESSING;
+             case COMPLETED -&gt; ProductSyncOutboxEntity.SyncStatus.COMPLETED;
+             case FAILED -&gt; ProductSyncOutboxEntity.SyncStatus.FAILED;
+         };
+     }
+ 
+     /**
+      * Entity SyncStatus → Domain SyncStatus
+      */
+     private SyncStatus toDomainStatus(ProductSyncOutboxEntity.SyncStatus entityStatus) {
+         Objects.requireNonNull(entityStatus, &quot;entityStatus must not be null&quot;);
+ 
+         return switch (entityStatus) {
+             case PENDING -&gt; SyncStatus.PENDING;
+             case PROCESSING -&gt; SyncStatus.PROCESSING;
+             case COMPLETED -&gt; SyncStatus.COMPLETED;
+             case FAILED -&gt; SyncStatus.FAILED;
+         };
+     }
+ }
+ 
```

</details>

</tool-use>

---



---


Adapter 구현 중. Command Adapter와 Query Adapter를 생성합니다.


---

<tool-use data-tool-type="write" data-tool-name="write">

<details><summary>Tool use: **code_edit** • Edit file: adapter-out/persistence-mysql/src/main/java/com/ryuqq/crawlinghub/adapter/out/persistence/product/adapter/ProductSnapshotCommandAdapter.java</summary>

**Chunk 1**
Lines added: 54, lines removed: 1

```diff
@@ -1,1 +1,54 @@
- 
+ package com.ryuqq.crawlinghub.adapter.out.persistence.product.adapter;
+ 
+ import com.ryuqq.crawlinghub.adapter.out.persistence.product.entity.ProductSnapshotEntity;
+ import com.ryuqq.crawlinghub.adapter.out.persistence.product.mapper.ProductSnapshotMapper;
+ import com.ryuqq.crawlinghub.adapter.out.persistence.product.repository.ProductSnapshotJpaRepository;
+ import com.ryuqq.crawlinghub.application.product.port.out.SaveProductSnapshotPort;
+ import com.ryuqq.crawlinghub.domain.product.ProductSnapshot;
+ import org.springframework.stereotype.Component;
+ 
+ import java.util.Objects;
+ 
+ /**
+  * ProductSnapshot Command Adapter (CQRS - Command)
+  *
+  * &lt;p&gt;&lt;strong&gt;책임:&lt;/strong&gt;&lt;/p&gt;
+  * &lt;ul&gt;
+  *   &lt;li&gt;✅ CUD (Create, Update, Delete) 작업 전담&lt;/li&gt;
+  *   &lt;li&gt;✅ SaveProductSnapshotPort 구현&lt;/li&gt;
+  *   &lt;li&gt;✅ Domain → Entity 변환&lt;/li&gt;
+  *   &lt;li&gt;✅ JPA Repository 호출&lt;/li&gt;
+  * &lt;/ul&gt;
+  *
+  * @author ryu-qqq
+  * @since 2025-11-07
+  */
+ @Component
+ public class ProductSnapshotCommandAdapter implements SaveProductSnapshotPort {
+ 
+     private final ProductSnapshotJpaRepository repository;
+     private final ProductSnapshotMapper mapper;
+ 
+     public ProductSnapshotCommandAdapter(
+         ProductSnapshotJpaRepository repository,
+         ProductSnapshotMapper mapper
+     ) {
+         this.repository = Objects.requireNonNull(repository, &quot;repository must not be null&quot;);
+         this.mapper = Objects.requireNonNull(mapper, &quot;mapper must not be null&quot;);
+     }
+ 
+     @Override
+     public ProductSnapshot save(ProductSnapshot snapshot) {
+         Objects.requireNonNull(snapshot, &quot;snapshot must not be null&quot;);
+ 
+         // 1. Domain → Entity
+         ProductSnapshotEntity entity = mapper.toEntity(snapshot);
+ 
+         // 2. JPA save
+         ProductSnapshotEntity savedEntity = repository.save(entity);
+ 
+         // 3. Entity → Domain
+         return mapper.toDomain(savedEntity);
+     }
+ }
+ 
```

</details>

</tool-use>

---

<tool-use data-tool-type="write" data-tool-name="write">

<details><summary>Tool use: **code_edit** • Edit file: adapter-out/persistence-mysql/src/main/java/com/ryuqq/crawlinghub/adapter/out/persistence/product/adapter/ProductSnapshotQueryAdapter.java</summary>

**Chunk 1**
Lines added: 59, lines removed: 1

```diff
@@ -1,1 +1,59 @@
- 
+ package com.ryuqq.crawlinghub.adapter.out.persistence.product.adapter;
+ 
+ import com.ryuqq.crawlinghub.adapter.out.persistence.product.entity.ProductSnapshotEntity;
+ import com.ryuqq.crawlinghub.adapter.out.persistence.product.mapper.ProductSnapshotMapper;
+ import com.ryuqq.crawlinghub.adapter.out.persistence.product.repository.ProductSnapshotJpaRepository;
+ import com.ryuqq.crawlinghub.application.product.port.out.LoadProductSnapshotPort;
+ import com.ryuqq.crawlinghub.domain.product.ProductSnapshot;
+ import com.ryuqq.crawlinghub.domain.seller.MustitSellerId;
+ import org.springframework.stereotype.Component;
+ 
+ import java.util.Objects;
+ import java.util.Optional;
+ 
+ /**
+  * ProductSnapshot Query Adapter (CQRS - Query)
+  *
+  * &lt;p&gt;&lt;strong&gt;책임:&lt;/strong&gt;&lt;/p&gt;
+  * &lt;ul&gt;
+  *   &lt;li&gt;✅ Read 작업 전담&lt;/li&gt;
+  *   &lt;li&gt;✅ LoadProductSnapshotPort 구현&lt;/li&gt;
+  *   &lt;li&gt;✅ Entity → Domain 변환&lt;/li&gt;
+  *   &lt;li&gt;✅ JPA Repository 호출&lt;/li&gt;
+  * &lt;/ul&gt;
+  *
+  * @author ryu-qqq
+  * @since 2025-11-07
+  */
+ @Component
+ public class ProductSnapshotQueryAdapter implements LoadProductSnapshotPort {
+ 
+     private final ProductSnapshotJpaRepository repository;
+     private final ProductSnapshotMapper mapper;
+ 
+     public ProductSnapshotQueryAdapter(
+         ProductSnapshotJpaRepository repository,
+         ProductSnapshotMapper mapper
+     ) {
+         this.repository = Objects.requireNonNull(repository, &quot;repository must not be null&quot;);
+         this.mapper = Objects.requireNonNull(mapper, &quot;mapper must not be null&quot;);
+     }
+ 
+     @Override
+     public Optional&lt;ProductSnapshot&gt; findById(Long productId) {
+         Objects.requireNonNull(productId, &quot;productId must not be null&quot;);
+ 
+         return repository.findById(productId)
+             .map(mapper::toDomain);
+     }
+ 
+     @Override
+     public Optional&lt;ProductSnapshot&gt; findByMustitItemNoAndSellerId(Long mustItItemNo, MustitSellerId sellerId) {
+         Objects.requireNonNull(mustItItemNo, &quot;mustItItemNo must not be null&quot;);
+         Objects.requireNonNull(sellerId, &quot;sellerId must not be null&quot;);
+ 
+         return repository.findByMustItItemNoAndSellerId(mustItItemNo, sellerId.value())
+             .map(mapper::toDomain);
+     }
+ }
+ 
```

</details>

</tool-use>

---

<tool-use data-tool-type="write" data-tool-name="write">

<details><summary>Tool use: **code_edit** • Edit file: adapter-out/persistence-mysql/src/main/java/com/ryuqq/crawlinghub/adapter/out/persistence/product/adapter/ProductSyncOutboxCommandAdapter.java</summary>

**Chunk 1**
Lines added: 54, lines removed: 1

```diff
@@ -1,1 +1,54 @@
- 
+ package com.ryuqq.crawlinghub.adapter.out.persistence.product.adapter;
+ 
+ import com.ryuqq.crawlinghub.adapter.out.persistence.product.entity.ProductSyncOutboxEntity;
+ import com.ryuqq.crawlinghub.adapter.out.persistence.product.mapper.ProductSyncOutboxMapper;
+ import com.ryuqq.crawlinghub.adapter.out.persistence.product.repository.ProductSyncOutboxJpaRepository;
+ import com.ryuqq.crawlinghub.application.product.port.out.SaveProductSyncOutboxPort;
+ import com.ryuqq.crawlinghub.domain.product.ProductSyncOutbox;
+ import org.springframework.stereotype.Component;
+ 
+ import java.util.Objects;
+ 
+ /**
+  * ProductSyncOutbox Command Adapter (CQRS - Command)
+  *
+  * &lt;p&gt;&lt;strong&gt;책임:&lt;/strong&gt;&lt;/p&gt;
+  * &lt;ul&gt;
+  *   &lt;li&gt;✅ CUD (Create, Update, Delete) 작업 전담&lt;/li&gt;
+  *   &lt;li&gt;✅ SaveProductSyncOutboxPort 구현&lt;/li&gt;
+  *   &lt;li&gt;✅ Domain → Entity 변환&lt;/li&gt;
+  *   &lt;li&gt;✅ JPA Repository 호출&lt;/li&gt;
+  * &lt;/ul&gt;
+  *
+  * @author ryu-qqq
+  * @since 2025-11-07
+  */
+ @Component
+ public class ProductSyncOutboxCommandAdapter implements SaveProductSyncOutboxPort {
+ 
+     private final ProductSyncOutboxJpaRepository repository;
+     private final ProductSyncOutboxMapper mapper;
+ 
+     public ProductSyncOutboxCommandAdapter(
+         ProductSyncOutboxJpaRepository repository,
+         ProductSyncOutboxMapper mapper
+     ) {
+         this.repository = Objects.requireNonNull(repository, &quot;repository must not be null&quot;);
+         this.mapper = Objects.requireNonNull(mapper, &quot;mapper must not be null&quot;);
+     }
+ 
+     @Override
+     public ProductSyncOutbox save(ProductSyncOutbox outbox) {
+         Objects.requireNonNull(outbox, &quot;outbox must not be null&quot;);
+ 
+         // 1. Domain → Entity
+         ProductSyncOutboxEntity entity = mapper.toEntity(outbox);
+ 
+         // 2. JPA save
+         ProductSyncOutboxEntity savedEntity = repository.save(entity);
+ 
+         // 3. Entity → Domain
+         return mapper.toDomain(savedEntity);
+     }
+ }
+ 
```

</details>

</tool-use>

---

<tool-use data-tool-type="write" data-tool-name="write">

<details><summary>Tool use: **code_edit** • Edit file: adapter-out/persistence-mysql/src/main/java/com/ryuqq/crawlinghub/adapter/out/persistence/product/adapter/ProductSyncOutboxQueryAdapter.java</summary>

**Chunk 1**
Lines added: 65, lines removed: 1

```diff
@@ -1,1 +1,65 @@
- 
+ package com.ryuqq.crawlinghub.adapter.out.persistence.product.adapter;
+ 
+ import com.ryuqq.crawlinghub.adapter.out.persistence.product.entity.ProductSyncOutboxEntity;
+ import com.ryuqq.crawlinghub.adapter.out.persistence.product.mapper.ProductSyncOutboxMapper;
+ import com.ryuqq.crawlinghub.adapter.out.persistence.product.repository.ProductSyncOutboxJpaRepository;
+ import com.ryuqq.crawlinghub.application.product.port.out.LoadProductSyncOutboxPort;
+ import com.ryuqq.crawlinghub.domain.product.ProductSyncOutbox;
+ import com.ryuqq.crawlinghub.domain.product.SyncStatus;
+ import org.springframework.stereotype.Component;
+ 
+ import java.util.List;
+ import java.util.Objects;
+ import java.util.stream.Collectors;
+ 
+ /**
+  * ProductSyncOutbox Query Adapter (CQRS - Query)
+  *
+  * &lt;p&gt;&lt;strong&gt;책임:&lt;/strong&gt;&lt;/p&gt;
+  * &lt;ul&gt;
+  *   &lt;li&gt;✅ Read 작업 전담&lt;/li&gt;
+  *   &lt;li&gt;✅ LoadProductSyncOutboxPort 구현&lt;/li&gt;
+  *   &lt;li&gt;✅ Entity → Domain 변환&lt;/li&gt;
+  *   &lt;li&gt;✅ JPA Repository 호출&lt;/li&gt;
+  * &lt;/ul&gt;
+  *
+  * @author ryu-qqq
+  * @since 2025-11-07
+  */
+ @Component
+ public class ProductSyncOutboxQueryAdapter implements LoadProductSyncOutboxPort {
+ 
+     private final ProductSyncOutboxJpaRepository repository;
+     private final ProductSyncOutboxMapper mapper;
+ 
+     public ProductSyncOutboxQueryAdapter(
+         ProductSyncOutboxJpaRepository repository,
+         ProductSyncOutboxMapper mapper
+     ) {
+         this.repository = Objects.requireNonNull(repository, &quot;repository must not be null&quot;);
+         this.mapper = Objects.requireNonNull(mapper, &quot;mapper must not be null&quot;);
+     }
+ 
+     @Override
+     public List&lt;ProductSyncOutbox&gt; findByStatus(SyncStatus status, int limit) {
+         Objects.requireNonNull(status, &quot;status must not be null&quot;);
+ 
+         ProductSyncOutboxEntity.SyncStatus entityStatus = toEntityStatus(status);
+         List&lt;ProductSyncOutboxEntity&gt; entities = repository.findByStatusOrderByCreatedAtAsc(entityStatus);
+ 
+         return entities.stream()
+             .limit(limit)
+             .map(mapper::toDomain)
+             .collect(Collectors.toList());
+     }
+ 
+     private ProductSyncOutboxEntity.SyncStatus toEntityStatus(SyncStatus domainStatus) {
+         return switch (domainStatus) {
+             case PENDING -&gt; ProductSyncOutboxEntity.SyncStatus.PENDING;
+             case PROCESSING -&gt; ProductSyncOutboxEntity.SyncStatus.PROCESSING;
+             case COMPLETED -&gt; ProductSyncOutboxEntity.SyncStatus.COMPLETED;
+             case FAILED -&gt; ProductSyncOutboxEntity.SyncStatus.FAILED;
+         };
+     }
+ }
+ 
```

</details>

</tool-use>

---

<tool-use data-tool-type="generic" data-tool-name="read_lints">
<details>
          <summary>Tool use: **read_lints** • Read lints for 1 file</summary>
      
Lint paths:

- `adapter-out/persistence-mysql/src/main/java/com/ryuqq/crawlinghub/adapter/out/persistence/product`

Lint results

Lint errors for `adapter-out/persistence-mysql/src/main/java/com/ryuqq/crawlinghub/adapter/out/persistence/product/mapper/ProductSnapshotMapper.java`


| Message | Range | Severity |
|-------|-------|----------|
| The import java.util.ArrayList is never used | 11:8-11:27 | DIAGNOSTIC_SEVERITY_WARNING |


Lint errors for `adapter-out/persistence-mysql/src/main/java/com/ryuqq/crawlinghub/adapter/out/persistence/product/mapper/ProductSyncOutboxMapper.java`


| Message | Range | Severity |
|-------|-------|----------|
| The method getUpdatedAt() is undefined for the type ProductSyncOutbox | 58:24-58:36 | DIAGNOSTIC_SEVERITY_ERROR |


Lint errors for `adapter-out/persistence-mysql/src/main/java/com/ryuqq/crawlinghub/adapter/out/persistence/product/adapter/ProductSnapshotQueryAdapter.java`


| Message | Range | Severity |
|-------|-------|----------|
| The import com.ryuqq.crawlinghub.adapter.out.persistence.product.entity.ProductSnapshotEntity is never used | 3:8-3:90 | DIAGNOSTIC_SEVERITY_WARNING |


</details>
</tool-use>

---

<tool-use data-tool-type="generic" data-tool-name="todo_write">
<details><summary>Tool use: **todo_write** • Todo List</summary>

- [x] Phase 3-1: ProductSnapshotEntity + Repository 구현
- [x] Phase 3-2: ProductSyncOutboxEntity + Repository 구현
- [x] Phase 3-3: Mapper 구현
- [-] Phase 3-4: 데이터베이스 마이그레이션

</details>
</tool-use>

---



---


Linter 오류 수정 중.


---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: domain/src/main/java/com/ryuqq/crawlinghub/domain/product/ProductSyncOutbox.java</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="write" data-tool-name="search_replace">

<details><summary>Tool use: **code_edit** • Edit file: adapter-out/persistence-mysql/src/main/java/com/ryuqq/crawlinghub/adapter/out/persistence/product/mapper/ProductSnapshotMapper.java</summary>

**Chunk 1**
Lines added: undefined, lines removed: 1

```diff
@@ -9,5 +9,4 @@
  import org.springframework.stereotype.Component;
  
- import java.util.ArrayList;
  import java.util.List;
  import java.util.Objects;
```

</details>

</tool-use>

---

<tool-use data-tool-type="write" data-tool-name="search_replace">

<details><summary>Tool use: **code_edit** • Edit file: adapter-out/persistence-mysql/src/main/java/com/ryuqq/crawlinghub/adapter/out/persistence/product/adapter/ProductSnapshotQueryAdapter.java</summary>

**Chunk 1**
Lines added: undefined, lines removed: 1

```diff
@@ -1,5 +1,4 @@
  package com.ryuqq.crawlinghub.adapter.out.persistence.product.adapter;
  
- import com.ryuqq.crawlinghub.adapter.out.persistence.product.entity.ProductSnapshotEntity;
  import com.ryuqq.crawlinghub.adapter.out.persistence.product.mapper.ProductSnapshotMapper;
  import com.ryuqq.crawlinghub.adapter.out.persistence.product.repository.ProductSnapshotJpaRepository;
```

</details>

</tool-use>

---

<tool-use data-tool-type="write" data-tool-name="search_replace">

<details><summary>Tool use: **code_edit** • Edit file: adapter-out/persistence-mysql/src/main/java/com/ryuqq/crawlinghub/adapter/out/persistence/product/mapper/ProductSyncOutboxMapper.java</summary>

**Chunk 1**
Lines added: 1, lines removed: 1

```diff
@@ -56,5 +56,5 @@
                  outbox.getProcessedAt(),
                  outbox.getCreatedAt(),
-                 outbox.getUpdatedAt()
+                 outbox.getCreatedAt() // updatedAt이 없으므로 createdAt 사용
              );
          }
```

</details>

</tool-use>

---

<tool-use data-tool-type="generic" data-tool-name="read_lints">
<details>
          <summary>Tool use: **read_lints** • Read lints for 1 file</summary>
      
Lint paths:

- `adapter-out/persistence-mysql/src/main/java/com/ryuqq/crawlinghub/adapter/out/persistence/product`

Lint results


**No lint errors found**
</details>
</tool-use>

---



---


데이터베이스 마이그레이션 파일 생성 중. Flyway 마이그레이션 파일 위치 확인 중.


---

<tool-use data-tool-type="generic" data-tool-name="list_dir">
<details>
            <summary>Tool use: **list_directory** • Listed directory undefined • **0** results</summary>
        
No results found
</details>
</tool-use>

---

<tool-use data-tool-type="generic" data-tool-name="glob_file_search">
<details>
<summary>Tool use: **glob_file_search** • Searched codebase "**/V*.sql" • **1** result in **1** directory</summary>

Directory: **/Users/sangwon-ryu/crawlinghub/adapter-out/persistence-mysql** (1 file)

| File |
|------|
| `src/main/resources/db/migration/V2__Create_product_count_history.sql` |

</details>
</tool-use>

---



---


데이터베이스 마이그레이션 파일 생성 중.


---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: adapter-out/persistence-mysql/src/main/resources/db/migration/V2__Create_product_count_history.sql</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="write" data-tool-name="write">

<details><summary>Tool use: **code_edit** • Edit file: adapter-out/persistence-mysql/src/main/resources/db/migration/V3__Create_product_snapshot_and_sync_outbox.sql</summary>

**Chunk 1**
Lines added: 45, lines removed: 1

```diff
@@ -1,1 +1,45 @@
- 
+ -- ProductSnapshot 테이블
+ CREATE TABLE product_snapshot (
+     id BIGINT PRIMARY KEY AUTO_INCREMENT,
+     must_it_item_no BIGINT NOT NULL,
+     seller_id BIGINT NOT NULL,
+ 
+     -- 미니샵 데이터
+     product_name VARCHAR(500),
+     price BIGINT,
+     main_image_url VARCHAR(1000),
+ 
+     -- 옵션 데이터
+     options JSON,
+     total_stock INT,
+ 
+     -- 상세 데이터
+     product_info JSON,
+     shipping JSON,
+     detail_info JSON,
+ 
+     -- 메타 정보
+     last_synced_at TIMESTAMP,
+     version INT NOT NULL DEFAULT 1,
+     created_at TIMESTAMP NOT NULL,
+     updated_at TIMESTAMP NOT NULL,
+ 
+     UNIQUE KEY uk_item_seller (must_it_item_no, seller_id),
+     INDEX idx_last_synced (last_synced_at)
+ );
+ 
+ -- ProductSyncOutbox 테이블
+ CREATE TABLE product_sync_outbox (
+     id BIGINT PRIMARY KEY AUTO_INCREMENT,
+     product_id BIGINT NOT NULL,
+     product_json JSON NOT NULL,
+     status VARCHAR(20) NOT NULL,
+     retry_count INT NOT NULL DEFAULT 0,
+     error_message TEXT,
+     created_at TIMESTAMP NOT NULL,
+     updated_at TIMESTAMP NOT NULL,
+     processed_at TIMESTAMP,
+ 
+     INDEX idx_status_created (status, created_at)
+ );
+ 
```

</details>

</tool-use>

---

<tool-use data-tool-type="generic" data-tool-name="read_lints">
<details>
          <summary>Tool use: **read_lints** • Read lints for 1 file</summary>
      
Lint paths:

- `adapter-out/persistence-mysql/src/main/java/com/ryuqq/crawlinghub/adapter/out/persistence/product`

Lint results


**No lint errors found**
</details>
</tool-use>

---

<tool-use data-tool-type="generic" data-tool-name="todo_write">
<details><summary>Tool use: **todo_write** • Todo List</summary>

- [x] Phase 3-1: ProductSnapshotEntity + Repository 구현
- [x] Phase 3-2: ProductSyncOutboxEntity + Repository 구현
- [x] Phase 3-3: Mapper 구현
- [x] Phase 3-4: 데이터베이스 마이그레이션

</details>
</tool-use>

---



---


Phase 1~3 완료. 구현 요약:

## 구현 완료 내역

### Phase 1: Domain Layer ✅
- **ProductSnapshot** (Aggregate Root) 및 Value Objects
- **ProductChangeEvent** (Domain Event) 및 보조 타입
- **ProductSyncOutbox** (Aggregate Root) 및 보조 타입
- 모든 Value Objects (ProductOption, ProductInfoModule, ShippingModule, ProductDetailInfoModule, FullProductData)

### Phase 2: Application Layer ✅
- **Port 인터페이스** 정의 (LoadProductSnapshotPort, SaveProductSnapshotPort, LoadProductSyncOutboxPort, SaveProductSyncOutboxPort, ExternalProductApiPort)
- **ProductSnapshotBuilder** (부분 → 전체 변환)
- **ExternalSyncOrchestrator** (Event Listener)
- **ProductSyncWorker** (Polling Worker)
- DTO (MiniShopData, OptionData, DetailData)

### Phase 3: Persistence Layer ✅
- **ProductSnapshotEntity** + Repository
- **ProductSyncOutboxEntity** + Repository
- **Mapper** 구현 (ProductSnapshotMapper, ProductSyncOutboxMapper)
- **Adapter** 구현 (Command/Query Adapter)
- **데이터베이스 마이그레이션** (V3__Create_product_snapshot_and_sync_outbox.sql)

## Zero-Tolerance 규칙 준수 확인

✅ **Lombok 금지**: 모든 클래스에서 Pure Java getter/setter 직접 작성  
✅ **Law of Demeter**: getter 체이닝 없이 메서드 직접 제공 (예: `getIdValue()`, `getSellerIdValue()`)  
✅ **Long FK Strategy**: JPA 관계 없이 Long FK 사용 (`sellerId`, `productId`)  
✅ **Transaction 경계**: ExternalSyncOrchestrator는 Outbox 저장까지만 트랜잭션, Worker는 외부 API 호출을 트랜잭션 밖에서 수행  
✅ **Javadoc 필수**: 모든 public 클래스/메서드에 Javadoc 작성

모든 코드는 문서에 명시된 대로 작성되었으며, Zero-Tolerance 규칙을 준수합니다.

---

