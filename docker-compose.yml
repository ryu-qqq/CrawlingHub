# ===============================================
# CrawlingHub Local Development Docker Compose
# ===============================================
# MySQL 8.0 + Redis 7.x 로컬 개발 환경
#
# 사용법:
#   docker-compose up -d        # 백그라운드 실행
#   docker-compose down         # 중지 및 제거
#   docker-compose logs -f      # 로그 확인
#
# @author development-team
# @since 1.0.0
# ===============================================

version: '3.8'

services:
  # ===============================================
  # MySQL 8.0
  # ===============================================
  mysql:
    image: mysql:8.0
    container_name: crawlinghub-mysql
    restart: unless-stopped

    environment:
      MYSQL_ROOT_PASSWORD: ${DB_PASSWORD:-rootpassword}
      MYSQL_DATABASE: crawlinghub
      MYSQL_CHARACTER_SET_SERVER: utf8mb4
      MYSQL_COLLATION_SERVER: utf8mb4_unicode_ci
      TZ: Asia/Seoul

    ports:
      - "3306:3306"

    volumes:
      - mysql_data:/var/lib/mysql
      - ./docker/mysql/init:/docker-entrypoint-initdb.d  # 초기화 SQL (선택사항)

    command:
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
      - --default-time-zone=+09:00
      - --max_connections=200
      - --innodb_buffer_pool_size=512M
      - --innodb_log_file_size=128M

    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${DB_PASSWORD:-rootpassword}"]
      interval: 10s
      timeout: 5s
      retries: 5

    networks:
      - crawlinghub-network

  # ===============================================
  # Redis 7.x
  # ===============================================
  redis:
    image: redis:7-alpine
    container_name: crawlinghub-redis
    restart: unless-stopped

    environment:
      TZ: Asia/Seoul

    ports:
      - "6379:6379"

    volumes:
      - redis_data:/data

    command: redis-server --appendonly yes

    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5

    networks:
      - crawlinghub-network

# ===============================================
# Volumes
# ===============================================
volumes:
  mysql_data:
    driver: local
  redis_data:
    driver: local

# ===============================================
# Networks
# ===============================================
networks:
  crawlinghub-network:
    driver: bridge
