{
  "name": "CrawlingHub - Seller Daily Report",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "cronExpression",
              "expression": "0 9 * * *"
            }
          ]
        }
      },
      "id": "trigger-cron",
      "name": "Every Day 09:00 KST",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [0, 0]
    },
    {
      "parameters": {
        "jsCode": "const staticData = $getWorkflowStaticData('global');\nconst token = staticData.token || null;\nconst tokenExpiry = staticData.tokenExpiry || 0;\nconst now = Date.now();\n\n// ÌÜ†ÌÅ∞Ïù¥ ÏóÜÍ±∞ÎÇò 5Î∂Ñ ÎÇ¥ ÎßåÎ£å ÏòàÏ†ïÏù¥Î©¥ Í∞±Ïã† ÌïÑÏöî\nconst needsRefresh = !token || (tokenExpiry - now) < 5 * 60 * 1000;\n\nreturn {\n  accessToken: token,\n  needsRefresh,\n  tokenExpiry: new Date(tokenExpiry).toISOString()\n};"
      },
      "id": "code-check-token",
      "name": "Check Token",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [220, 0]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "needs-refresh",
              "leftValue": "={{ $json.needsRefresh }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "if-needs-refresh",
      "name": "Needs Token Refresh?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [440, 0]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.set-of.com/api/v1/auth/login",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"identifier\": \"{{ $vars.AUTHHUB_IDENTIFIER }}\",\n  \"password\": \"{{ $vars.AUTHHUB_PASSWORD }}\"\n}",
        "options": {
          "timeout": 10000
        }
      },
      "id": "http-login",
      "name": "Login to AuthHub",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [660, -100]
    },
    {
      "parameters": {
        "jsCode": "const response = $input.first().json;\nconst staticData = $getWorkflowStaticData('global');\n\nif (response.data && response.data.accessToken) {\n  staticData.token = response.data.accessToken;\n  staticData.refreshToken = response.data.refreshToken;\n  // ÌÜ†ÌÅ∞ ÎßåÎ£å ÏãúÍ∞Ñ ÏÑ§Ï†ï (Í∏∞Î≥∏ 55Î∂Ñ)\n  staticData.tokenExpiry = Date.now() + 55 * 60 * 1000;\n  \n  return {\n    accessToken: response.data.accessToken,\n    success: true\n  };\n} else {\n  throw new Error('Failed to get access token from AuthHub');\n}"
      },
      "id": "code-save-token",
      "name": "Save New Token",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [880, -100]
    },
    {
      "parameters": {
        "mode": "combine",
        "mergeByFields": {
          "values": []
        },
        "combinationMode": "multiplex",
        "options": {}
      },
      "id": "merge-token",
      "name": "Merge Token",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [1100, 0]
    },
    {
      "parameters": {
        "jsCode": "// Ïñ¥Ï†ú 00:00 ~ 23:59:59 (KST Í∏∞Ï§Ä)\nconst now = new Date();\nconst yesterday = new Date(now);\nyesterday.setDate(yesterday.getDate() - 1);\nyesterday.setHours(0, 0, 0, 0);\n\nconst yesterdayEnd = new Date(yesterday);\nyesterdayEnd.setHours(23, 59, 59, 999);\n\n// ÌÜ†ÌÅ∞ Ï†ïÎ≥¥ Ïú†ÏßÄ\nconst staticData = $getWorkflowStaticData('global');\n\nreturn {\n  fromISO: yesterday.toISOString(),\n  toISO: yesterdayEnd.toISOString(),\n  reportDate: yesterday.toISOString().split('T')[0],\n  accessToken: staticData.token\n};"
      },
      "id": "code-time-range",
      "name": "Calculate Yesterday Range",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1320, 0]
    },
    {
      "parameters": {
        "method": "GET",
        "url": "https://api.set-of.com/api/v1/crawling/sellers?size=100",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $json.accessToken }}"
            }
          ]
        },
        "options": {
          "timeout": 30000
        }
      },
      "id": "http-get-sellers",
      "name": "Get All Sellers",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1540, -100]
    },
    {
      "parameters": {
        "method": "GET",
        "url": "=https://api.set-of.com/api/v1/crawling/executions?from={{ $('Calculate Yesterday Range').item.json.fromISO }}&to={{ $('Calculate Yesterday Range').item.json.toISO }}&size=100",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $('Calculate Yesterday Range').item.json.accessToken }}"
            }
          ]
        },
        "options": {
          "timeout": 60000
        }
      },
      "id": "http-get-executions",
      "name": "Get All Executions",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1540, 100]
    },
    {
      "parameters": {
        "jsCode": "// Í∞Å ÎÖ∏ÎìúÏùò Í≤∞Í≥ºÎ•º ÏßÅÏ†ë Ï∞∏Ï°∞\nconst sellersResponse = $('Get All Sellers').first().json;\nconst executionsResponse = $('Get All Executions').first().json;\n\nconst sellers = sellersResponse?.data?.content || [];\nconst executions = executionsResponse?.data?.content || [];\n\n// Seller ID ‚Üí Name Îß§Ìïë\nconst sellerMap = {};\nsellers.forEach(s => {\n  sellerMap[s.sellerId] = s.sellerName || s.mustItSellerName || `Seller ${s.sellerId}`;\n});\n\n// SellerÎ≥Ñ ÌÜµÍ≥Ñ ÏßëÍ≥Ñ\nconst sellerStats = {};\n\nsellers.forEach(s => {\n  sellerStats[s.sellerId] = {\n    sellerId: s.sellerId,\n    sellerName: sellerMap[s.sellerId],\n    status: s.status,\n    productCount: s.productCount || 0,\n    success: 0,\n    failed: 0,\n    timeout: 0,\n    running: 0,\n    totalDurationMs: 0,\n    executionCount: 0\n  };\n});\n\nexecutions.forEach(exec => {\n  const sellerId = exec.sellerId;\n  if (!sellerStats[sellerId]) {\n    sellerStats[sellerId] = {\n      sellerId,\n      sellerName: `Unknown (${sellerId})`,\n      status: 'UNKNOWN',\n      productCount: 0,\n      success: 0,\n      failed: 0,\n      timeout: 0,\n      running: 0,\n      totalDurationMs: 0,\n      executionCount: 0\n    };\n  }\n  \n  const stats = sellerStats[sellerId];\n  stats.executionCount++;\n  \n  switch (exec.status) {\n    case 'SUCCESS': stats.success++; break;\n    case 'FAILED': stats.failed++; break;\n    case 'TIMEOUT': stats.timeout++; break;\n    case 'RUNNING': stats.running++; break;\n  }\n  \n  if (exec.durationMs) {\n    stats.totalDurationMs += exec.durationMs;\n  }\n});\n\n// Í≤∞Í≥º Ï†ïÎ¶¨\nconst sellerReports = Object.values(sellerStats)\n  .map(s => {\n    const total = s.success + s.failed + s.timeout;\n    const successRate = total > 0 ? (s.success / total * 100).toFixed(1) : 'N/A';\n    const avgDuration = s.executionCount > 0 \n      ? (s.totalDurationMs / s.executionCount / 1000).toFixed(2) \n      : 'N/A';\n    \n    return {\n      ...s,\n      totalExecutions: total,\n      successRate,\n      avgDurationSec: avgDuration\n    };\n  })\n  .filter(s => s.totalExecutions > 0 || s.status === 'ACTIVE')\n  .sort((a, b) => b.totalExecutions - a.totalExecutions);\n\n// Ï†ÑÏ≤¥ ÏöîÏïΩ\nconst totalSuccess = sellerReports.reduce((sum, s) => sum + s.success, 0);\nconst totalFailed = sellerReports.reduce((sum, s) => sum + s.failed, 0);\nconst totalTimeout = sellerReports.reduce((sum, s) => sum + s.timeout, 0);\nconst totalExecutions = totalSuccess + totalFailed + totalTimeout;\nconst overallSuccessRate = totalExecutions > 0 \n  ? (totalSuccess / totalExecutions * 100).toFixed(1) \n  : 'N/A';\n\n// Top 5 ÏÑ±Í≥µÎ•† Seller\nconst topSellers = sellerReports\n  .filter(s => s.totalExecutions >= 10)\n  .sort((a, b) => parseFloat(b.successRate) - parseFloat(a.successRate))\n  .slice(0, 5);\n\n// Î¨∏Ï†ú Seller (Ïã§Ìå®Ïú® 20% Ïù¥ÏÉÅ)\nconst problematicSellers = sellerReports\n  .filter(s => s.totalExecutions >= 5 && parseFloat(s.successRate) < 80)\n  .sort((a, b) => parseFloat(a.successRate) - parseFloat(b.successRate))\n  .slice(0, 5);\n\n// ÎπÑÌôúÏÑ± Seller (ACTIVEÏù∏Îç∞ Ïã§Ìñâ ÏóÜÏùå)\nconst inactiveSellers = sellerReports\n  .filter(s => s.status === 'ACTIVE' && s.totalExecutions === 0);\n\nconst reportDate = $('Calculate Yesterday Range').item.json.reportDate;\n\nreturn {\n  reportDate,\n  summary: {\n    totalSellers: sellers.length,\n    activeSellers: sellers.filter(s => s.status === 'ACTIVE').length,\n    totalExecutions,\n    totalSuccess,\n    totalFailed,\n    totalTimeout,\n    overallSuccessRate\n  },\n  topSellers,\n  problematicSellers,\n  inactiveSellers: inactiveSellers.slice(0, 5),\n  sellerReports: sellerReports.slice(0, 20)\n};"
      },
      "id": "code-analyze",
      "name": "Generate Report",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1760, 0]
    },
    {
      "parameters": {
        "jsCode": "const data = $input.first().json;\nconst summary = data.summary;\nconst topSellers = data.topSellers;\nconst problematicSellers = data.problematicSellers;\nconst inactiveSellers = data.inactiveSellers;\n\n// Top Sellers ÌÖçÏä§Ìä∏\nlet topSellersText = topSellers.length > 0\n  ? topSellers.map((s, i) => `${i + 1}. ${s.sellerName}: ${s.successRate}% (${s.totalExecutions}Í±¥)`).join('\\n')\n  : 'Ìï¥Îãπ ÏóÜÏùå';\n\n// Î¨∏Ï†ú Sellers ÌÖçÏä§Ìä∏\nlet problemText = problematicSellers.length > 0\n  ? problematicSellers.map(s => `‚Ä¢ ${s.sellerName}: ${s.successRate}% (Ïã§Ìå® ${s.failed + s.timeout}Í±¥)`).join('\\n')\n  : '‚úÖ Î™®Îì† Seller Ï†ïÏÉÅ';\n\n// ÎπÑÌôúÏÑ± Sellers ÌÖçÏä§Ìä∏\nlet inactiveText = inactiveSellers.length > 0\n  ? inactiveSellers.map(s => `‚Ä¢ ${s.sellerName}`).join('\\n')\n  : 'Ìï¥Îãπ ÏóÜÏùå';\n\nconst slackMessage = {\n  text: `üìä CrawlingHub Daily Report - ${data.reportDate}`,\n  attachments: [\n    {\n      color: '#36a64f',\n      blocks: [\n        {\n          type: 'header',\n          text: {\n            type: 'plain_text',\n            text: `üìä CrawlingHub ÏùºÍ∞Ñ Î¶¨Ìè¨Ìä∏ - ${data.reportDate}`,\n            emoji: true\n          }\n        },\n        {\n          type: 'section',\n          text: {\n            type: 'mrkdwn',\n            text: '*üìà Ï†ÑÏ≤¥ ÏöîÏïΩ*'\n          }\n        },\n        {\n          type: 'section',\n          fields: [\n            {\n              type: 'mrkdwn',\n              text: `*Ï¥ù Seller*\\n${summary.totalSellers}Í∞ú (Active: ${summary.activeSellers})`\n            },\n            {\n              type: 'mrkdwn',\n              text: `*Ï¥ù ÌÅ¨Î°§ÎßÅ*\\n${summary.totalExecutions}Í±¥`\n            },\n            {\n              type: 'mrkdwn',\n              text: `*Ï†ÑÏ≤¥ ÏÑ±Í≥µÎ•†*\\n${summary.overallSuccessRate}%`\n            },\n            {\n              type: 'mrkdwn',\n              text: `*ÏÑ±Í≥µ/Ïã§Ìå®/ÌÉÄÏûÑÏïÑÏõÉ*\\n${summary.totalSuccess}/${summary.totalFailed}/${summary.totalTimeout}`\n            }\n          ]\n        },\n        {\n          type: 'divider'\n        },\n        {\n          type: 'section',\n          text: {\n            type: 'mrkdwn',\n            text: `*üèÜ Top 5 Seller (ÏÑ±Í≥µÎ•†)*\\n${topSellersText}`\n          }\n        },\n        {\n          type: 'divider'\n        },\n        {\n          type: 'section',\n          text: {\n            type: 'mrkdwn',\n            text: `*‚ö†Ô∏è Ï£ºÏùò ÌïÑÏöî Seller (ÏÑ±Í≥µÎ•† 80% ÎØ∏Îßå)*\\n${problemText}`\n          }\n        },\n        {\n          type: 'divider'\n        },\n        {\n          type: 'section',\n          text: {\n            type: 'mrkdwn',\n            text: `*üí§ ÎπÑÌôúÏÑ± Seller (ACTIVEÏù¥ÎÇò ÌÅ¨Î°§ÎßÅ ÏóÜÏùå)*\\n${inactiveText}`\n          }\n        },\n        {\n          type: 'context',\n          elements: [\n            {\n              type: 'mrkdwn',\n              text: `‚è∞ Î¶¨Ìè¨Ìä∏ ÏÉùÏÑ±: ${new Date().toISOString()}`\n            }\n          ]\n        }\n      ]\n    }\n  ]\n};\n\nreturn { slackMessage };"
      },
      "id": "code-slack-format",
      "name": "Format Slack Report",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1980, 0]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $vars.SLACK_WEBHOOK_URL }}",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json.slackMessage }}",
        "options": {}
      },
      "id": "http-slack",
      "name": "Send Slack Report",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [2200, 0]
    }
  ],
  "connections": {
    "Every Day 09:00 KST": {
      "main": [
        [
          {
            "node": "Check Token",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Token": {
      "main": [
        [
          {
            "node": "Needs Token Refresh?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Needs Token Refresh?": {
      "main": [
        [
          {
            "node": "Login to AuthHub",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Merge Token",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Login to AuthHub": {
      "main": [
        [
          {
            "node": "Save New Token",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Save New Token": {
      "main": [
        [
          {
            "node": "Merge Token",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge Token": {
      "main": [
        [
          {
            "node": "Calculate Yesterday Range",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Calculate Yesterday Range": {
      "main": [
        [
          {
            "node": "Get All Sellers",
            "type": "main",
            "index": 0
          },
          {
            "node": "Get All Executions",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get All Sellers": {
      "main": [
        [
          {
            "node": "Generate Report",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get All Executions": {
      "main": [
        [
          {
            "node": "Generate Report",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate Report": {
      "main": [
        [
          {
            "node": "Format Slack Report",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Slack Report": {
      "main": [
        [
          {
            "node": "Send Slack Report",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "timezone": "Asia/Seoul"
  },
  "staticData": {
    "global": {
      "token": null,
      "refreshToken": null,
      "tokenExpiry": 0
    }
  },
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "crawlinghub-daily-report"
  },
  "pinData": {},
  "versionId": "1.2.0",
  "tags": [
    {
      "name": "reporting"
    },
    {
      "name": "crawlinghub"
    },
    {
      "name": "daily"
    }
  ]
}
