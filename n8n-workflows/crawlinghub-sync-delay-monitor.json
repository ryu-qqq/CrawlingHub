{
  "name": "CrawlingHub - Sync Delay Monitor",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "minutes",
              "minutesInterval": 10
            }
          ]
        }
      },
      "id": "trigger-cron",
      "name": "Every 10 Minutes",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [0, 0]
    },
    {
      "parameters": {
        "jsCode": "const staticData = $getWorkflowStaticData('global');\nconst token = staticData.token || null;\nconst tokenExpiry = staticData.tokenExpiry || 0;\nconst now = Date.now();\n\n// ÌÜ†ÌÅ∞Ïù¥ ÏóÜÍ±∞ÎÇò 5Î∂Ñ ÎÇ¥ ÎßåÎ£å ÏòàÏ†ïÏù¥Î©¥ Í∞±Ïã† ÌïÑÏöî\nconst needsRefresh = !token || (tokenExpiry - now) < 5 * 60 * 1000;\n\nreturn {\n  accessToken: token,\n  needsRefresh,\n  tokenExpiry: new Date(tokenExpiry).toISOString()\n};"
      },
      "id": "code-check-token",
      "name": "Check Token",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [200, 0]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "needs-refresh",
              "leftValue": "={{ $json.needsRefresh }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "if-needs-refresh",
      "name": "Needs Token Refresh?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [400, 0]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.set-of.com/api/v1/auth/login",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"identifier\": \"{{ $vars.AUTHHUB_IDENTIFIER }}\",\n  \"password\": \"{{ $vars.AUTHHUB_PASSWORD }}\"\n}",
        "options": {
          "timeout": 30000
        }
      },
      "id": "http-login",
      "name": "Login to AuthHub",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [600, -100]
    },
    {
      "parameters": {
        "jsCode": "const response = $input.first().json;\nconst staticData = $getWorkflowStaticData('global');\n\nif (response.data && response.data.accessToken) {\n  staticData.token = response.data.accessToken;\n  staticData.refreshToken = response.data.refreshToken;\n  // ÌÜ†ÌÅ∞ ÎßåÎ£å ÏãúÍ∞Ñ ÏÑ§Ï†ï (Í∏∞Î≥∏ 55Î∂Ñ)\n  staticData.tokenExpiry = Date.now() + 55 * 60 * 1000;\n  \n  return {\n    accessToken: response.data.accessToken,\n    success: true\n  };\n} else {\n  throw new Error('Failed to get access token from AuthHub');\n}"
      },
      "id": "code-save-token",
      "name": "Save New Token",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [800, -100]
    },
    {
      "parameters": {
        "mode": "combine",
        "mergeByFields": {
          "values": []
        },
        "combinationMode": "multiplex",
        "options": {}
      },
      "id": "merge-token",
      "name": "Merge Token",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [1000, 0]
    },
    {
      "parameters": {
        "method": "GET",
        "url": "http://crawlinghub-web-api-prod.connectly.local:8080/api/v1/crawling/product-outbox/sync?status=PENDING&size=500",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $json.accessToken }}"
            }
          ]
        },
        "options": {
          "timeout": 30000
        }
      },
      "id": "http-get-sync-pending",
      "name": "Get Pending Sync Outbox",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1220, -150]
    },
    {
      "parameters": {
        "method": "GET",
        "url": "http://crawlinghub-web-api-prod.connectly.local:8080/api/v1/crawling/product-outbox/sync?status=FAILED&size=500",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $json.accessToken }}"
            }
          ]
        },
        "options": {
          "timeout": 30000
        }
      },
      "id": "http-get-sync-failed",
      "name": "Get Failed Sync Outbox",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1220, 0]
    },
    {
      "parameters": {
        "method": "GET",
        "url": "http://crawlinghub-web-api-prod.connectly.local:8080/api/v1/crawling/product-outbox/image?status=PENDING&size=500",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $json.accessToken }}"
            }
          ]
        },
        "options": {
          "timeout": 30000
        }
      },
      "id": "http-get-image-pending",
      "name": "Get Pending Image Outbox",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1220, 150]
    },
    {
      "parameters": {
        "method": "GET",
        "url": "http://crawlinghub-web-api-prod.connectly.local:8080/api/v1/crawling/product-outbox/image?status=FAILED&size=500",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $json.accessToken }}"
            }
          ]
        },
        "options": {
          "timeout": 30000
        }
      },
      "id": "http-get-image-failed",
      "name": "Get Failed Image Outbox",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1220, 300]
    },
    {
      "parameters": {
        "mode": "combine",
        "mergeByFields": {
          "values": []
        },
        "combinationMode": "multiplex",
        "options": {}
      },
      "id": "merge-results",
      "name": "Merge All Results",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [1500, 75]
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\nconst syncPendingRes = items[0]?.json;\nconst syncFailedRes = items[1]?.json;\nconst imagePendingRes = items[2]?.json;\nconst imageFailedRes = items[3]?.json;\n\nconst syncPending = syncPendingRes?.data?.content || [];\nconst syncFailed = syncFailedRes?.data?.content || [];\nconst imagePending = imagePendingRes?.data?.content || [];\nconst imageFailed = imageFailedRes?.data?.content || [];\n\nconst now = new Date();\nconst STALE_THRESHOLD_MINUTES = 60; // 1ÏãúÍ∞Ñ Ïù¥ÏÉÅ ÎåÄÍ∏∞ Ïãú Í≤ΩÍ≥†\n\n// Ïò§ÎûòÎêú PENDING Ìï≠Î™© ÌïÑÌÑ∞ÎßÅ\nfunction getStaleItems(items) {\n  return items.filter(item => {\n    const createdAt = new Date(item.createdAt);\n    const diffMinutes = (now - createdAt) / (1000 * 60);\n    return diffMinutes >= STALE_THRESHOLD_MINUTES;\n  });\n}\n\nconst staleSyncPending = getStaleItems(syncPending);\nconst staleImagePending = getStaleItems(imagePending);\n\n// ÏïåÎ¶º Ï°∞Í±¥\nconst alerts = [];\n\n// ÎèôÍ∏∞Ìôî ÏßÄÏó∞ ÏïåÎ¶º\nif (syncPending.length >= 100) {\n  alerts.push({\n    type: 'CRITICAL',\n    category: 'sync',\n    metric: 'sync_pending_count',\n    value: syncPending.length,\n    message: `üö® ÎèôÍ∏∞Ìôî ÎåÄÍ∏∞ ÏÉÅÌíà ${syncPending.length}Í∞ú! ÎßàÏºìÌîåÎ†àÏù¥Ïä§ API Ïû•Ïï† ÏùòÏã¨`\n  });\n} else if (syncPending.length >= 50) {\n  alerts.push({\n    type: 'WARNING',\n    category: 'sync',\n    metric: 'sync_pending_count',\n    value: syncPending.length,\n    message: `‚ö†Ô∏è ÎèôÍ∏∞Ìôî ÎåÄÍ∏∞ ÏÉÅÌíà ${syncPending.length}Í∞ú Ï†ÅÏ≤¥ Ï§ë`\n  });\n}\n\nif (staleSyncPending.length >= 20) {\n  alerts.push({\n    type: 'CRITICAL',\n    category: 'sync',\n    metric: 'stale_sync_pending',\n    value: staleSyncPending.length,\n    message: `üö® ${staleSyncPending.length}Í∞ú ÏÉÅÌíàÏù¥ ${STALE_THRESHOLD_MINUTES}Î∂Ñ Ïù¥ÏÉÅ ÎèôÍ∏∞Ìôî ÎåÄÍ∏∞ Ï§ë!`\n  });\n}\n\nif (syncFailed.length >= 20) {\n  alerts.push({\n    type: 'CRITICAL',\n    category: 'sync',\n    metric: 'sync_failed_count',\n    value: syncFailed.length,\n    message: `üö® ÎèôÍ∏∞Ìôî Ïã§Ìå® ÏÉÅÌíà ${syncFailed.length}Í∞ú! Ï¶âÏãú ÌôïÏù∏ ÌïÑÏöî`\n  });\n} else if (syncFailed.length >= 5) {\n  alerts.push({\n    type: 'WARNING',\n    category: 'sync',\n    metric: 'sync_failed_count',\n    value: syncFailed.length,\n    message: `‚ö†Ô∏è ÎèôÍ∏∞Ìôî Ïã§Ìå® ÏÉÅÌíà ${syncFailed.length}Í∞ú`\n  });\n}\n\n// Ïù¥ÎØ∏ÏßÄ ÏóÖÎ°úÎìú ÏßÄÏó∞ ÏïåÎ¶º\nif (imagePending.length >= 200) {\n  alerts.push({\n    type: 'CRITICAL',\n    category: 'image',\n    metric: 'image_pending_count',\n    value: imagePending.length,\n    message: `üö® Ïù¥ÎØ∏ÏßÄ ÏóÖÎ°úÎìú ÎåÄÍ∏∞ ${imagePending.length}Í∞ú! Fileflow Ïû•Ïï† ÏùòÏã¨`\n  });\n} else if (imagePending.length >= 100) {\n  alerts.push({\n    type: 'WARNING',\n    category: 'image',\n    metric: 'image_pending_count',\n    value: imagePending.length,\n    message: `‚ö†Ô∏è Ïù¥ÎØ∏ÏßÄ ÏóÖÎ°úÎìú ÎåÄÍ∏∞ ${imagePending.length}Í∞ú Ï†ÅÏ≤¥ Ï§ë`\n  });\n}\n\nif (staleImagePending.length >= 50) {\n  alerts.push({\n    type: 'CRITICAL',\n    category: 'image',\n    metric: 'stale_image_pending',\n    value: staleImagePending.length,\n    message: `üö® ${staleImagePending.length}Í∞ú Ïù¥ÎØ∏ÏßÄÍ∞Ä ${STALE_THRESHOLD_MINUTES}Î∂Ñ Ïù¥ÏÉÅ ÏóÖÎ°úÎìú ÎåÄÍ∏∞ Ï§ë!`\n  });\n}\n\nif (imageFailed.length >= 30) {\n  alerts.push({\n    type: 'CRITICAL',\n    category: 'image',\n    metric: 'image_failed_count',\n    value: imageFailed.length,\n    message: `üö® Ïù¥ÎØ∏ÏßÄ ÏóÖÎ°úÎìú Ïã§Ìå® ${imageFailed.length}Í∞ú! S3/Fileflow ÌôïÏù∏ ÌïÑÏöî`\n  });\n} else if (imageFailed.length >= 10) {\n  alerts.push({\n    type: 'WARNING',\n    category: 'image',\n    metric: 'image_failed_count',\n    value: imageFailed.length,\n    message: `‚ö†Ô∏è Ïù¥ÎØ∏ÏßÄ ÏóÖÎ°úÎìú Ïã§Ìå® ${imageFailed.length}Í∞ú`\n  });\n}\n\nreturn {\n  timestamp: now.toISOString(),\n  summary: {\n    sync: {\n      pending: syncPending.length,\n      stalePending: staleSyncPending.length,\n      failed: syncFailed.length\n    },\n    image: {\n      pending: imagePending.length,\n      stalePending: staleImagePending.length,\n      failed: imageFailed.length\n    },\n    staleThresholdMinutes: STALE_THRESHOLD_MINUTES\n  },\n  alerts,\n  hasAlerts: alerts.length > 0,\n  hasCritical: alerts.some(a => a.type === 'CRITICAL'),\n  hasSyncIssue: alerts.some(a => a.category === 'sync'),\n  hasImageIssue: alerts.some(a => a.category === 'image')\n};"
      },
      "id": "code-analyze",
      "name": "Analyze Sync Status",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1720, 75]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "has-alerts",
              "leftValue": "={{ $json.hasAlerts }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "if-has-alerts",
      "name": "Has Alerts?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1940, 75]
    },
    {
      "parameters": {
        "jsCode": "const data = $input.first().json;\nconst alerts = data.alerts;\nconst summary = data.summary;\n\nconst hasCritical = data.hasCritical;\nconst emoji = hasCritical ? 'üö®' : '‚ö†Ô∏è';\nconst color = hasCritical ? '#ff0000' : '#ffcc00';\n\n// Ïπ¥ÌÖåÍ≥†Î¶¨Î≥Ñ ÏïåÎ¶º Î∂ÑÎ•ò\nconst syncAlerts = alerts.filter(a => a.category === 'sync').map(a => a.message).join('\\n');\nconst imageAlerts = alerts.filter(a => a.category === 'image').map(a => a.message).join('\\n');\n\nlet alertSections = [];\n\nif (syncAlerts) {\n  alertSections.push(`*üì¶ ÏÉÅÌíà ÎèôÍ∏∞Ìôî*\\n${syncAlerts}`);\n}\n\nif (imageAlerts) {\n  alertSections.push(`*üñºÔ∏è Ïù¥ÎØ∏ÏßÄ ÏóÖÎ°úÎìú*\\n${imageAlerts}`);\n}\n\nconst alertText = alertSections.join('\\n\\n');\n\nconst slackMessage = {\n  text: `${emoji} CrawlingHub Sync Delay Alert`,\n  attachments: [\n    {\n      color: color,\n      blocks: [\n        {\n          type: 'header',\n          text: {\n            type: 'plain_text',\n            text: `${emoji} CrawlingHub ÎèôÍ∏∞Ìôî ÏßÄÏó∞ ÏïåÎ¶º`,\n            emoji: true\n          }\n        },\n        {\n          type: 'section',\n          text: {\n            type: 'mrkdwn',\n            text: alertText\n          }\n        },\n        {\n          type: 'divider'\n        },\n        {\n          type: 'section',\n          text: {\n            type: 'mrkdwn',\n            text: '*üì¶ ÏÉÅÌíà ÎèôÍ∏∞Ìôî ÌòÑÌô©*'\n          }\n        },\n        {\n          type: 'section',\n          fields: [\n            {\n              type: 'mrkdwn',\n              text: `*ÎåÄÍ∏∞ Ï§ë*\\n${summary.sync.pending}Í∞ú`\n            },\n            {\n              type: 'mrkdwn',\n              text: `*Ïû•Í∏∞ ÎåÄÍ∏∞ (>${summary.staleThresholdMinutes}Î∂Ñ)*\\n${summary.sync.stalePending}Í∞ú`\n            },\n            {\n              type: 'mrkdwn',\n              text: `*Ïã§Ìå®*\\n${summary.sync.failed}Í∞ú`\n            }\n          ]\n        },\n        {\n          type: 'section',\n          text: {\n            type: 'mrkdwn',\n            text: '*üñºÔ∏è Ïù¥ÎØ∏ÏßÄ ÏóÖÎ°úÎìú ÌòÑÌô©*'\n          }\n        },\n        {\n          type: 'section',\n          fields: [\n            {\n              type: 'mrkdwn',\n              text: `*ÎåÄÍ∏∞ Ï§ë*\\n${summary.image.pending}Í∞ú`\n            },\n            {\n              type: 'mrkdwn',\n              text: `*Ïû•Í∏∞ ÎåÄÍ∏∞ (>${summary.staleThresholdMinutes}Î∂Ñ)*\\n${summary.image.stalePending}Í∞ú`\n            },\n            {\n              type: 'mrkdwn',\n              text: `*Ïã§Ìå®*\\n${summary.image.failed}Í∞ú`\n            }\n          ]\n        },\n        {\n          type: 'context',\n          elements: [\n            {\n              type: 'mrkdwn',\n              text: `‚è∞ ${data.timestamp}`\n            }\n          ]\n        }\n      ]\n    }\n  ]\n};\n\nreturn { slackMessage, hasCritical, hasSyncIssue: data.hasSyncIssue, hasImageIssue: data.hasImageIssue };"
      },
      "id": "code-slack-format",
      "name": "Format Slack Message",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2160, -25]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $vars.SLACK_WEBHOOK_URL }}",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json.slackMessage }}",
        "options": {}
      },
      "id": "http-slack",
      "name": "Send Slack Alert",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [2380, -25]
    },
    {
      "parameters": {},
      "id": "noop-no-alert",
      "name": "No Alerts",
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [2160, 175]
    }
  ],
  "connections": {
    "Every 10 Minutes": {
      "main": [
        [
          {
            "node": "Check Token",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Token": {
      "main": [
        [
          {
            "node": "Needs Token Refresh?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Needs Token Refresh?": {
      "main": [
        [
          {
            "node": "Login to AuthHub",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Merge Token",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Login to AuthHub": {
      "main": [
        [
          {
            "node": "Save New Token",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Save New Token": {
      "main": [
        [
          {
            "node": "Merge Token",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge Token": {
      "main": [
        [
          {
            "node": "Get Pending Sync Outbox",
            "type": "main",
            "index": 0
          },
          {
            "node": "Get Failed Sync Outbox",
            "type": "main",
            "index": 0
          },
          {
            "node": "Get Pending Image Outbox",
            "type": "main",
            "index": 0
          },
          {
            "node": "Get Failed Image Outbox",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Pending Sync Outbox": {
      "main": [
        [
          {
            "node": "Merge All Results",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Failed Sync Outbox": {
      "main": [
        [
          {
            "node": "Merge All Results",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Get Pending Image Outbox": {
      "main": [
        [
          {
            "node": "Merge All Results",
            "type": "main",
            "index": 2
          }
        ]
      ]
    },
    "Get Failed Image Outbox": {
      "main": [
        [
          {
            "node": "Merge All Results",
            "type": "main",
            "index": 3
          }
        ]
      ]
    },
    "Merge All Results": {
      "main": [
        [
          {
            "node": "Analyze Sync Status",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Analyze Sync Status": {
      "main": [
        [
          {
            "node": "Has Alerts?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Has Alerts?": {
      "main": [
        [
          {
            "node": "Format Slack Message",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "No Alerts",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Slack Message": {
      "main": [
        [
          {
            "node": "Send Slack Alert",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": {
    "global": {
      "token": null,
      "refreshToken": null,
      "tokenExpiry": 0
    }
  },
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "crawlinghub-sync-delay-monitor"
  },
  "pinData": {},
  "versionId": "1.1.0",
  "tags": [
    {
      "name": "monitoring"
    },
    {
      "name": "crawlinghub"
    },
    {
      "name": "sync"
    },
    {
      "name": "image"
    }
  ]
}
