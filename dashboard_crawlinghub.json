{
  "uid": "crawlinghub-core-metrics",
  "title": "CrawlingHub - Core Metrics",
  "timezone": "browser",
  "schemaVersion": 38,
  "version": 1,
  "refresh": "10s",
  "tags": ["crawlinghub", "prod", "core"],
  "templating": {
    "list": [
      {
        "name": "datasource",
        "type": "datasource",
        "query": "prometheus",
        "current": { "text": "AMP-prod", "value": "AMP-prod" }
      },
      {
        "name": "job",
        "type": "query",
        "datasource": "$datasource",
        "query": "label_values(up, job)",
        "current": { "text": "crawlinghub-metrics", "value": "crawlinghub-metrics" }
      },
      {
        "name": "application",
        "type": "query",
        "datasource": "$datasource",
        "query": "label_values(jvm_memory_used_bytes, application)",
        "regex": "/crawlinghub.*/",
        "includeAll": true,
        "multi": true,
        "current": { "text": "All", "value": "$__all" }
      },
      {
        "name": "task_id",
        "label": "ECS Task ID",
        "type": "query",
        "datasource": "$datasource",
        "query": "label_values(up{job=\"$job\"}, aws_ecs_task_id)",
        "regex": "/.+/",
        "includeAll": true,
        "multi": true,
        "refresh": 2
      }
    ]
  },
  "panels": [
    {
      "id": 100,
      "type": "row",
      "title": "üìä Overview",
      "gridPos": { "x": 0, "y": 0, "w": 24, "h": 1 },
      "collapsed": false
    },
    {
      "id": 1,
      "type": "stat",
      "title": "Instances UP",
      "gridPos": { "x": 0, "y": 1, "w": 4, "h": 4 },
      "datasource": "$datasource",
      "targets": [
        {
          "expr": "sum(up{job=\"$job\"})",
          "legendFormat": "UP"
        }
      ],
      "options": {
        "reduceOptions": { "calcs": ["last"] },
        "colorMode": "background"
      },
      "fieldConfig": {
        "defaults": {
          "thresholds": {
            "mode": "absolute",
            "steps": [
              { "color": "red", "value": null },
              { "color": "yellow", "value": 1 },
              { "color": "green", "value": 2 }
            ]
          }
        }
      }
    },
    {
      "id": 2,
      "type": "stat",
      "title": "Total RPS",
      "gridPos": { "x": 4, "y": 1, "w": 4, "h": 4 },
      "datasource": "$datasource",
      "targets": [
        {
          "expr": "sum(rate(http_server_requests_seconds_count{job=\"$job\"}[1m]))",
          "legendFormat": "RPS"
        }
      ],
      "options": {
        "reduceOptions": { "calcs": ["last"] }
      },
      "fieldConfig": {
        "defaults": { "unit": "reqps", "decimals": 1 }
      }
    },
    {
      "id": 3,
      "type": "stat",
      "title": "Avg Latency",
      "gridPos": { "x": 8, "y": 1, "w": 4, "h": 4 },
      "datasource": "$datasource",
      "targets": [
        {
          "expr": "sum(rate(http_server_requests_seconds_sum{job=\"$job\"}[1m])) / sum(rate(http_server_requests_seconds_count{job=\"$job\"}[1m]))",
          "legendFormat": "Avg"
        }
      ],
      "options": {
        "reduceOptions": { "calcs": ["last"] }
      },
      "fieldConfig": {
        "defaults": {
          "unit": "s",
          "decimals": 3,
          "thresholds": {
            "mode": "absolute",
            "steps": [
              { "color": "green", "value": null },
              { "color": "yellow", "value": 0.5 },
              { "color": "red", "value": 1 }
            ]
          }
        }
      }
    },
    {
      "id": 4,
      "type": "stat",
      "title": "Error Rate %",
      "gridPos": { "x": 12, "y": 1, "w": 4, "h": 4 },
      "datasource": "$datasource",
      "targets": [
        {
          "expr": "sum(rate(http_server_requests_seconds_count{job=\"$job\",status=~\"5..\"}[1m])) / sum(rate(http_server_requests_seconds_count{job=\"$job\"}[1m])) * 100 or vector(0)",
          "legendFormat": "Error %"
        }
      ],
      "options": {
        "reduceOptions": { "calcs": ["last"] }
      },
      "fieldConfig": {
        "defaults": {
          "unit": "percent",
          "decimals": 2,
          "thresholds": {
            "mode": "absolute",
            "steps": [
              { "color": "green", "value": null },
              { "color": "yellow", "value": 1 },
              { "color": "red", "value": 5 }
            ]
          }
        }
      }
    },
    {
      "id": 5,
      "type": "stat",
      "title": "UserAgent Available",
      "gridPos": { "x": 16, "y": 1, "w": 4, "h": 4 },
      "datasource": "$datasource",
      "targets": [
        {
          "expr": "avg(useragent_pool_available_rate{job=\"$job\"})",
          "legendFormat": "Available %"
        }
      ],
      "options": {
        "reduceOptions": { "calcs": ["last"] },
        "colorMode": "background"
      },
      "fieldConfig": {
        "defaults": {
          "unit": "percent",
          "decimals": 1,
          "thresholds": {
            "mode": "absolute",
            "steps": [
              { "color": "red", "value": null },
              { "color": "yellow", "value": 30 },
              { "color": "green", "value": 50 }
            ]
          }
        }
      }
    },
    {
      "id": 6,
      "type": "stat",
      "title": "Heap Usage %",
      "gridPos": { "x": 20, "y": 1, "w": 4, "h": 4 },
      "datasource": "$datasource",
      "targets": [
        {
          "expr": "avg(jvm_memory_used_bytes{job=\"$job\",area=\"heap\"} / jvm_memory_max_bytes{job=\"$job\",area=\"heap\"}) * 100",
          "legendFormat": "Heap %"
        }
      ],
      "options": {
        "reduceOptions": { "calcs": ["last"] }
      },
      "fieldConfig": {
        "defaults": {
          "unit": "percent",
          "decimals": 1,
          "thresholds": {
            "mode": "absolute",
            "steps": [
              { "color": "green", "value": null },
              { "color": "yellow", "value": 70 },
              { "color": "red", "value": 85 }
            ]
          }
        }
      }
    },

    {
      "id": 200,
      "type": "row",
      "title": "üï∑Ô∏è Crawl Task Metrics",
      "gridPos": { "x": 0, "y": 5, "w": 24, "h": 1 },
      "collapsed": false
    },
    {
      "id": 10,
      "type": "stat",
      "title": "Task Success Rate",
      "gridPos": { "x": 0, "y": 6, "w": 6, "h": 4 },
      "datasource": "$datasource",
      "targets": [
        {
          "expr": "sum(rate(crawl_task_completed_total{job=\"$job\"}[5m])) / sum(rate(crawl_task_received_total{job=\"$job\"}[5m])) * 100 or vector(100)",
          "legendFormat": "Success %"
        }
      ],
      "options": {
        "reduceOptions": { "calcs": ["last"] },
        "colorMode": "background"
      },
      "fieldConfig": {
        "defaults": {
          "unit": "percent",
          "decimals": 1,
          "thresholds": {
            "mode": "absolute",
            "steps": [
              { "color": "red", "value": null },
              { "color": "yellow", "value": 90 },
              { "color": "green", "value": 95 }
            ]
          }
        }
      }
    },
    {
      "id": 11,
      "type": "stat",
      "title": "Tasks Received (5m)",
      "gridPos": { "x": 6, "y": 6, "w": 6, "h": 4 },
      "datasource": "$datasource",
      "targets": [
        {
          "expr": "sum(increase(crawl_task_received_total{job=\"$job\"}[5m]))",
          "legendFormat": "Received"
        }
      ],
      "options": {
        "reduceOptions": { "calcs": ["last"] }
      },
      "fieldConfig": {
        "defaults": { "unit": "short", "decimals": 0 }
      }
    },
    {
      "id": 12,
      "type": "stat",
      "title": "Tasks Failed (5m)",
      "gridPos": { "x": 12, "y": 6, "w": 6, "h": 4 },
      "datasource": "$datasource",
      "targets": [
        {
          "expr": "sum(increase(crawl_task_failed_total{job=\"$job\"}[5m]))",
          "legendFormat": "Failed"
        }
      ],
      "options": {
        "reduceOptions": { "calcs": ["last"] },
        "colorMode": "background"
      },
      "fieldConfig": {
        "defaults": {
          "unit": "short",
          "decimals": 0,
          "thresholds": {
            "mode": "absolute",
            "steps": [
              { "color": "green", "value": null },
              { "color": "yellow", "value": 5 },
              { "color": "red", "value": 20 }
            ]
          }
        }
      }
    },
    {
      "id": 13,
      "type": "stat",
      "title": "Avg Task Duration",
      "gridPos": { "x": 18, "y": 6, "w": 6, "h": 4 },
      "datasource": "$datasource",
      "targets": [
        {
          "expr": "histogram_quantile(0.50, sum by (le) (rate(crawl_task_duration_seconds_bucket{job=\"$job\"}[5m])))",
          "legendFormat": "P50"
        }
      ],
      "options": {
        "reduceOptions": { "calcs": ["last"] }
      },
      "fieldConfig": {
        "defaults": {
          "unit": "s",
          "decimals": 2,
          "thresholds": {
            "mode": "absolute",
            "steps": [
              { "color": "green", "value": null },
              { "color": "yellow", "value": 5 },
              { "color": "red", "value": 10 }
            ]
          }
        }
      }
    },
    {
      "id": 14,
      "type": "timeseries",
      "title": "Task Rate by Site",
      "gridPos": { "x": 0, "y": 10, "w": 12, "h": 8 },
      "datasource": "$datasource",
      "targets": [
        {
          "expr": "sum by (site) (rate(crawl_task_received_total{job=\"$job\"}[1m]))",
          "legendFormat": "{{site}}"
        }
      ],
      "fieldConfig": {
        "defaults": { "unit": "reqps" }
      },
      "options": {
        "legend": { "displayMode": "table", "placement": "right" }
      }
    },
    {
      "id": 15,
      "type": "timeseries",
      "title": "Task Duration (P50 / P95 / P99)",
      "gridPos": { "x": 12, "y": 10, "w": 12, "h": 8 },
      "datasource": "$datasource",
      "targets": [
        {
          "expr": "histogram_quantile(0.50, sum by (le) (rate(crawl_task_duration_seconds_bucket{job=\"$job\"}[5m])))",
          "legendFormat": "P50"
        },
        {
          "expr": "histogram_quantile(0.95, sum by (le) (rate(crawl_task_duration_seconds_bucket{job=\"$job\"}[5m])))",
          "legendFormat": "P95"
        },
        {
          "expr": "histogram_quantile(0.99, sum by (le) (rate(crawl_task_duration_seconds_bucket{job=\"$job\"}[5m])))",
          "legendFormat": "P99"
        }
      ],
      "fieldConfig": {
        "defaults": { "unit": "s" }
      }
    },
    {
      "id": 16,
      "type": "timeseries",
      "title": "Task Success / Failure Rate",
      "gridPos": { "x": 0, "y": 18, "w": 12, "h": 8 },
      "datasource": "$datasource",
      "targets": [
        {
          "expr": "sum(rate(crawl_task_completed_total{job=\"$job\"}[1m]))",
          "legendFormat": "Completed"
        },
        {
          "expr": "sum(rate(crawl_task_failed_total{job=\"$job\"}[1m]))",
          "legendFormat": "Failed"
        }
      ],
      "fieldConfig": {
        "defaults": { "unit": "reqps" },
        "overrides": [
          { "matcher": { "id": "byName", "options": "Completed" }, "properties": [{ "id": "color", "value": { "fixedColor": "green", "mode": "fixed" } }] },
          { "matcher": { "id": "byName", "options": "Failed" }, "properties": [{ "id": "color", "value": { "fixedColor": "red", "mode": "fixed" } }] }
        ]
      }
    },
    {
      "id": 17,
      "type": "timeseries",
      "title": "Task Failure by Error Type",
      "gridPos": { "x": 12, "y": 18, "w": 12, "h": 8 },
      "datasource": "$datasource",
      "targets": [
        {
          "expr": "sum by (error_type) (rate(crawl_task_failed_total{job=\"$job\"}[5m]))",
          "legendFormat": "{{error_type}}"
        }
      ],
      "fieldConfig": {
        "defaults": { "unit": "reqps" }
      },
      "options": {
        "legend": { "displayMode": "table", "placement": "right" }
      }
    },

    {
      "id": 300,
      "type": "row",
      "title": "ü§ñ UserAgent Pool",
      "gridPos": { "x": 0, "y": 26, "w": 24, "h": 1 },
      "collapsed": false
    },
    {
      "id": 20,
      "type": "gauge",
      "title": "Pool Available Rate",
      "gridPos": { "x": 0, "y": 27, "w": 6, "h": 6 },
      "datasource": "$datasource",
      "targets": [
        {
          "expr": "avg(useragent_pool_available_rate{job=\"$job\"})",
          "legendFormat": "Available %"
        }
      ],
      "options": {
        "reduceOptions": { "calcs": ["last"] }
      },
      "fieldConfig": {
        "defaults": {
          "unit": "percent",
          "min": 0,
          "max": 100,
          "thresholds": {
            "mode": "absolute",
            "steps": [
              { "color": "red", "value": null },
              { "color": "yellow", "value": 30 },
              { "color": "green", "value": 50 }
            ]
          }
        }
      }
    },
    {
      "id": 21,
      "type": "stat",
      "title": "Available / Total",
      "gridPos": { "x": 6, "y": 27, "w": 6, "h": 6 },
      "datasource": "$datasource",
      "targets": [
        {
          "expr": "sum(useragent_pool_available{job=\"$job\"})",
          "legendFormat": "Available"
        },
        {
          "expr": "sum(useragent_pool_total{job=\"$job\"})",
          "legendFormat": "Total"
        }
      ],
      "options": {
        "reduceOptions": { "calcs": ["last"] }
      },
      "fieldConfig": {
        "defaults": { "unit": "short" }
      }
    },
    {
      "id": 22,
      "type": "stat",
      "title": "429 Rate Limited (5m)",
      "gridPos": { "x": 12, "y": 27, "w": 6, "h": 6 },
      "datasource": "$datasource",
      "targets": [
        {
          "expr": "sum(increase(useragent_rate_limited_total{job=\"$job\"}[5m])) or vector(0)",
          "legendFormat": "429 Count"
        }
      ],
      "options": {
        "reduceOptions": { "calcs": ["last"] },
        "colorMode": "background"
      },
      "fieldConfig": {
        "defaults": {
          "unit": "short",
          "decimals": 0,
          "thresholds": {
            "mode": "absolute",
            "steps": [
              { "color": "green", "value": null },
              { "color": "yellow", "value": 5 },
              { "color": "red", "value": 20 }
            ]
          }
        }
      }
    },
    {
      "id": 23,
      "type": "stat",
      "title": "Circuit Breaker Triggers (5m)",
      "gridPos": { "x": 18, "y": 27, "w": 6, "h": 6 },
      "datasource": "$datasource",
      "targets": [
        {
          "expr": "sum(increase(useragent_circuit_breaker_total{job=\"$job\"}[5m])) or vector(0)",
          "legendFormat": "CB Triggers"
        }
      ],
      "options": {
        "reduceOptions": { "calcs": ["last"] },
        "colorMode": "background"
      },
      "fieldConfig": {
        "defaults": {
          "unit": "short",
          "decimals": 0,
          "thresholds": {
            "mode": "absolute",
            "steps": [
              { "color": "green", "value": null },
              { "color": "yellow", "value": 1 },
              { "color": "red", "value": 5 }
            ]
          }
        }
      }
    },
    {
      "id": 24,
      "type": "timeseries",
      "title": "UserAgent Consume Rate & Latency",
      "gridPos": { "x": 0, "y": 33, "w": 12, "h": 8 },
      "datasource": "$datasource",
      "targets": [
        {
          "expr": "sum(rate(useragent_consume_total{job=\"$job\"}[1m]))",
          "legendFormat": "Consume Rate"
        },
        {
          "expr": "histogram_quantile(0.95, sum by (le) (rate(useragent_consume_latency_seconds_bucket{job=\"$job\"}[5m])))",
          "legendFormat": "Latency P95"
        }
      ],
      "fieldConfig": {
        "defaults": { "unit": "short" }
      }
    },
    {
      "id": 25,
      "type": "timeseries",
      "title": "UserAgent Success / Failure / 429",
      "gridPos": { "x": 12, "y": 33, "w": 12, "h": 8 },
      "datasource": "$datasource",
      "targets": [
        {
          "expr": "sum(rate(useragent_success_total{job=\"$job\"}[1m]))",
          "legendFormat": "Success"
        },
        {
          "expr": "sum(rate(useragent_failure_total{job=\"$job\"}[1m]))",
          "legendFormat": "Failure"
        },
        {
          "expr": "sum(rate(useragent_rate_limited_total{job=\"$job\"}[1m]))",
          "legendFormat": "429 Rate Limited"
        }
      ],
      "fieldConfig": {
        "defaults": { "unit": "reqps" },
        "overrides": [
          { "matcher": { "id": "byName", "options": "Success" }, "properties": [{ "id": "color", "value": { "fixedColor": "green", "mode": "fixed" } }] },
          { "matcher": { "id": "byName", "options": "Failure" }, "properties": [{ "id": "color", "value": { "fixedColor": "red", "mode": "fixed" } }] },
          { "matcher": { "id": "byName", "options": "429 Rate Limited" }, "properties": [{ "id": "color", "value": { "fixedColor": "orange", "mode": "fixed" } }] }
        ]
      }
    },
    {
      "id": 26,
      "type": "timeseries",
      "title": "Suspended / Recovered",
      "gridPos": { "x": 0, "y": 41, "w": 12, "h": 6 },
      "datasource": "$datasource",
      "targets": [
        {
          "expr": "sum by (reason) (rate(useragent_suspended_total{job=\"$job\"}[5m]))",
          "legendFormat": "Suspended ({{reason}})"
        },
        {
          "expr": "sum(rate(useragent_recovered_total{job=\"$job\"}[5m]))",
          "legendFormat": "Recovered"
        }
      ],
      "fieldConfig": {
        "defaults": { "unit": "reqps" },
        "overrides": [
          { "matcher": { "id": "byName", "options": "Recovered" }, "properties": [{ "id": "color", "value": { "fixedColor": "green", "mode": "fixed" } }] }
        ]
      }
    },
    {
      "id": 27,
      "type": "timeseries",
      "title": "Session Issuance",
      "gridPos": { "x": 12, "y": 41, "w": 12, "h": 6 },
      "datasource": "$datasource",
      "targets": [
        {
          "expr": "sum by (status) (rate(useragent_session_issued_total{job=\"$job\"}[5m]))",
          "legendFormat": "{{status}}"
        },
        {
          "expr": "histogram_quantile(0.95, sum by (le) (rate(useragent_session_issue_latency_seconds_bucket{job=\"$job\"}[5m])))",
          "legendFormat": "Latency P95"
        }
      ],
      "fieldConfig": {
        "defaults": { "unit": "short" }
      }
    },

    {
      "id": 400,
      "type": "row",
      "title": "üåê HTTP Crawling",
      "gridPos": { "x": 0, "y": 47, "w": 24, "h": 1 },
      "collapsed": false
    },
    {
      "id": 30,
      "type": "timeseries",
      "title": "Crawl HTTP Latency by Site",
      "gridPos": { "x": 0, "y": 48, "w": 12, "h": 8 },
      "datasource": "$datasource",
      "targets": [
        {
          "expr": "histogram_quantile(0.95, sum by (le, site) (rate(downstream_crawl_http_latency_seconds_bucket{job=\"$job\"}[5m])))",
          "legendFormat": "{{site}} P95"
        }
      ],
      "fieldConfig": {
        "defaults": { "unit": "s" }
      },
      "options": {
        "legend": { "displayMode": "table", "placement": "right" }
      }
    },
    {
      "id": 31,
      "type": "timeseries",
      "title": "Crawl HTTP Latency by Crawler Type",
      "gridPos": { "x": 12, "y": 48, "w": 12, "h": 8 },
      "datasource": "$datasource",
      "targets": [
        {
          "expr": "histogram_quantile(0.95, sum by (le, crawler_type) (rate(downstream_crawl_http_latency_seconds_bucket{job=\"$job\"}[5m])))",
          "legendFormat": "{{crawler_type}} P95"
        }
      ],
      "fieldConfig": {
        "defaults": { "unit": "s" }
      },
      "options": {
        "legend": { "displayMode": "table", "placement": "right" }
      }
    },
    {
      "id": 32,
      "type": "timeseries",
      "title": "HTTP Status Code Distribution",
      "gridPos": { "x": 0, "y": 56, "w": 12, "h": 8 },
      "datasource": "$datasource",
      "targets": [
        {
          "expr": "sum by (status_group) (rate(crawl_http_status_total{job=\"$job\"}[1m]))",
          "legendFormat": "{{status_group}}"
        }
      ],
      "fieldConfig": {
        "defaults": { "unit": "reqps" },
        "overrides": [
          { "matcher": { "id": "byName", "options": "2xx" }, "properties": [{ "id": "color", "value": { "fixedColor": "green", "mode": "fixed" } }] },
          { "matcher": { "id": "byName", "options": "4xx" }, "properties": [{ "id": "color", "value": { "fixedColor": "yellow", "mode": "fixed" } }] },
          { "matcher": { "id": "byName", "options": "5xx" }, "properties": [{ "id": "color", "value": { "fixedColor": "red", "mode": "fixed" } }] }
        ]
      }
    },
    {
      "id": 33,
      "type": "piechart",
      "title": "HTTP Status Distribution (5m)",
      "gridPos": { "x": 12, "y": 56, "w": 12, "h": 8 },
      "datasource": "$datasource",
      "targets": [
        {
          "expr": "sum by (status_group) (increase(crawl_http_status_total{job=\"$job\"}[5m]))",
          "legendFormat": "{{status_group}}"
        }
      ],
      "options": {
        "legend": { "displayMode": "table", "placement": "right" }
      },
      "fieldConfig": {
        "overrides": [
          { "matcher": { "id": "byName", "options": "2xx" }, "properties": [{ "id": "color", "value": { "fixedColor": "green", "mode": "fixed" } }] },
          { "matcher": { "id": "byName", "options": "4xx" }, "properties": [{ "id": "color", "value": { "fixedColor": "yellow", "mode": "fixed" } }] },
          { "matcher": { "id": "byName", "options": "5xx" }, "properties": [{ "id": "color", "value": { "fixedColor": "red", "mode": "fixed" } }] }
        ]
      }
    },

    {
      "id": 500,
      "type": "row",
      "title": "üî¥ Redis",
      "gridPos": { "x": 0, "y": 64, "w": 24, "h": 1 },
      "collapsed": false
    },
    {
      "id": 40,
      "type": "stat",
      "title": "Redis Hit Rate",
      "gridPos": { "x": 0, "y": 65, "w": 6, "h": 4 },
      "datasource": "$datasource",
      "targets": [
        {
          "expr": "sum(rate(spring_data_redis_cache_gets_total{job=\"$job\",result=\"hit\"}[5m])) / sum(rate(spring_data_redis_cache_gets_total{job=\"$job\"}[5m])) * 100 or vector(100)",
          "legendFormat": "Hit Rate %"
        }
      ],
      "options": {
        "reduceOptions": { "calcs": ["last"] },
        "colorMode": "background"
      },
      "fieldConfig": {
        "defaults": {
          "unit": "percent",
          "decimals": 1,
          "thresholds": {
            "mode": "absolute",
            "steps": [
              { "color": "red", "value": null },
              { "color": "yellow", "value": 80 },
              { "color": "green", "value": 95 }
            ]
          }
        }
      }
    },
    {
      "id": 41,
      "type": "stat",
      "title": "Redis Ops/sec",
      "gridPos": { "x": 6, "y": 65, "w": 6, "h": 4 },
      "datasource": "$datasource",
      "targets": [
        {
          "expr": "sum(rate(spring_data_redis_cache_gets_total{job=\"$job\"}[1m])) + sum(rate(spring_data_redis_cache_puts_total{job=\"$job\"}[1m]))",
          "legendFormat": "Ops/sec"
        }
      ],
      "options": {
        "reduceOptions": { "calcs": ["last"] }
      },
      "fieldConfig": {
        "defaults": { "unit": "ops", "decimals": 1 }
      }
    },
    {
      "id": 42,
      "type": "stat",
      "title": "Redis Latency P95",
      "gridPos": { "x": 12, "y": 65, "w": 6, "h": 4 },
      "datasource": "$datasource",
      "targets": [
        {
          "expr": "histogram_quantile(0.95, sum by (le) (rate(downstream_redis_latency_seconds_bucket{job=\"$job\"}[5m])))",
          "legendFormat": "P95"
        }
      ],
      "options": {
        "reduceOptions": { "calcs": ["last"] }
      },
      "fieldConfig": {
        "defaults": {
          "unit": "s",
          "decimals": 3,
          "thresholds": {
            "mode": "absolute",
            "steps": [
              { "color": "green", "value": null },
              { "color": "yellow", "value": 0.01 },
              { "color": "red", "value": 0.05 }
            ]
          }
        }
      }
    },
    {
      "id": 43,
      "type": "stat",
      "title": "Lettuce Pool Active",
      "gridPos": { "x": 18, "y": 65, "w": 6, "h": 4 },
      "datasource": "$datasource",
      "targets": [
        {
          "expr": "avg(lettuce_connection_pool_active{job=\"$job\"})",
          "legendFormat": "Active"
        }
      ],
      "options": {
        "reduceOptions": { "calcs": ["last"] }
      },
      "fieldConfig": {
        "defaults": { "unit": "short" }
      }
    },
    {
      "id": 44,
      "type": "timeseries",
      "title": "Redis Operation Rate",
      "gridPos": { "x": 0, "y": 69, "w": 12, "h": 8 },
      "datasource": "$datasource",
      "targets": [
        {
          "expr": "sum(rate(spring_data_redis_cache_gets_total{job=\"$job\",result=\"hit\"}[1m]))",
          "legendFormat": "Cache Hit"
        },
        {
          "expr": "sum(rate(spring_data_redis_cache_gets_total{job=\"$job\",result=\"miss\"}[1m]))",
          "legendFormat": "Cache Miss"
        },
        {
          "expr": "sum(rate(spring_data_redis_cache_puts_total{job=\"$job\"}[1m]))",
          "legendFormat": "Cache Put"
        }
      ],
      "fieldConfig": {
        "defaults": { "unit": "ops" },
        "overrides": [
          { "matcher": { "id": "byName", "options": "Cache Hit" }, "properties": [{ "id": "color", "value": { "fixedColor": "green", "mode": "fixed" } }] },
          { "matcher": { "id": "byName", "options": "Cache Miss" }, "properties": [{ "id": "color", "value": { "fixedColor": "yellow", "mode": "fixed" } }] }
        ]
      }
    },
    {
      "id": 45,
      "type": "timeseries",
      "title": "Redis Latency by Operation",
      "gridPos": { "x": 12, "y": 69, "w": 12, "h": 8 },
      "datasource": "$datasource",
      "targets": [
        {
          "expr": "histogram_quantile(0.95, sum by (le, operation) (rate(downstream_redis_latency_seconds_bucket{job=\"$job\"}[5m])))",
          "legendFormat": "{{operation}} P95"
        }
      ],
      "fieldConfig": {
        "defaults": { "unit": "s" }
      },
      "options": {
        "legend": { "displayMode": "table", "placement": "right" }
      }
    },

    {
      "id": 600,
      "type": "row",
      "title": "üì® SQS & External APIs",
      "gridPos": { "x": 0, "y": 77, "w": 24, "h": 1 },
      "collapsed": false
    },
    {
      "id": 50,
      "type": "stat",
      "title": "SQS Publish Rate",
      "gridPos": { "x": 0, "y": 78, "w": 6, "h": 4 },
      "datasource": "$datasource",
      "targets": [
        {
          "expr": "sum(rate(downstream_sqs_publish_total{job=\"$job\"}[1m]))",
          "legendFormat": "Publish/sec"
        }
      ],
      "options": {
        "reduceOptions": { "calcs": ["last"] }
      },
      "fieldConfig": {
        "defaults": { "unit": "reqps" }
      }
    },
    {
      "id": 51,
      "type": "stat",
      "title": "SQS Publish Latency P95",
      "gridPos": { "x": 6, "y": 78, "w": 6, "h": 4 },
      "datasource": "$datasource",
      "targets": [
        {
          "expr": "histogram_quantile(0.95, sum by (le) (rate(downstream_sqs_publish_latency_seconds_bucket{job=\"$job\"}[5m])))",
          "legendFormat": "P95"
        }
      ],
      "options": {
        "reduceOptions": { "calcs": ["last"] }
      },
      "fieldConfig": {
        "defaults": {
          "unit": "s",
          "decimals": 3,
          "thresholds": {
            "mode": "absolute",
            "steps": [
              { "color": "green", "value": null },
              { "color": "yellow", "value": 0.1 },
              { "color": "red", "value": 0.5 }
            ]
          }
        }
      }
    },
    {
      "id": 52,
      "type": "stat",
      "title": "External API Rate",
      "gridPos": { "x": 12, "y": 78, "w": 6, "h": 4 },
      "datasource": "$datasource",
      "targets": [
        {
          "expr": "sum(rate(downstream_external_api_total{job=\"$job\"}[1m]))",
          "legendFormat": "API/sec"
        }
      ],
      "options": {
        "reduceOptions": { "calcs": ["last"] }
      },
      "fieldConfig": {
        "defaults": { "unit": "reqps" }
      }
    },
    {
      "id": 53,
      "type": "stat",
      "title": "External API Latency P95",
      "gridPos": { "x": 18, "y": 78, "w": 6, "h": 4 },
      "datasource": "$datasource",
      "targets": [
        {
          "expr": "histogram_quantile(0.95, sum by (le) (rate(downstream_external_api_latency_seconds_bucket{job=\"$job\"}[5m])))",
          "legendFormat": "P95"
        }
      ],
      "options": {
        "reduceOptions": { "calcs": ["last"] }
      },
      "fieldConfig": {
        "defaults": {
          "unit": "s",
          "decimals": 2,
          "thresholds": {
            "mode": "absolute",
            "steps": [
              { "color": "green", "value": null },
              { "color": "yellow", "value": 1 },
              { "color": "red", "value": 3 }
            ]
          }
        }
      }
    },
    {
      "id": 54,
      "type": "timeseries",
      "title": "SQS Publish/Consume Latency",
      "gridPos": { "x": 0, "y": 82, "w": 12, "h": 8 },
      "datasource": "$datasource",
      "targets": [
        {
          "expr": "histogram_quantile(0.95, sum by (le, operation) (rate(downstream_sqs_publish_latency_seconds_bucket{job=\"$job\"}[5m])))",
          "legendFormat": "Publish {{operation}} P95"
        },
        {
          "expr": "histogram_quantile(0.95, sum by (le, operation) (rate(downstream_sqs_consume_latency_seconds_bucket{job=\"$job\"}[5m])))",
          "legendFormat": "Consume {{operation}} P95"
        }
      ],
      "fieldConfig": {
        "defaults": { "unit": "s" }
      }
    },
    {
      "id": 55,
      "type": "timeseries",
      "title": "External API Latency by Operation",
      "gridPos": { "x": 12, "y": 82, "w": 12, "h": 8 },
      "datasource": "$datasource",
      "targets": [
        {
          "expr": "histogram_quantile(0.95, sum by (le, operation) (rate(downstream_external_api_latency_seconds_bucket{job=\"$job\"}[5m])))",
          "legendFormat": "{{operation}} P95"
        }
      ],
      "fieldConfig": {
        "defaults": { "unit": "s" }
      },
      "options": {
        "legend": { "displayMode": "table", "placement": "right" }
      }
    },

    {
      "id": 700,
      "type": "row",
      "title": "üóÑÔ∏è Database (HikariCP)",
      "gridPos": { "x": 0, "y": 90, "w": 24, "h": 1 },
      "collapsed": false
    },
    {
      "id": 60,
      "type": "timeseries",
      "title": "Connection Pool Usage",
      "gridPos": { "x": 0, "y": 91, "w": 8, "h": 6 },
      "datasource": "$datasource",
      "targets": [
        {
          "expr": "hikaricp_connections_active{job=\"$job\"}",
          "legendFormat": "Active"
        },
        {
          "expr": "hikaricp_connections_idle{job=\"$job\"}",
          "legendFormat": "Idle"
        },
        {
          "expr": "hikaricp_connections_pending{job=\"$job\"}",
          "legendFormat": "Pending"
        }
      ],
      "fieldConfig": {
        "defaults": { "unit": "short" }
      }
    },
    {
      "id": 61,
      "type": "gauge",
      "title": "Pool Utilization %",
      "gridPos": { "x": 8, "y": 91, "w": 8, "h": 6 },
      "datasource": "$datasource",
      "targets": [
        {
          "expr": "avg(hikaricp_connections_active{job=\"$job\"} / hikaricp_connections_max{job=\"$job\"}) * 100",
          "legendFormat": "Usage %"
        }
      ],
      "options": {
        "reduceOptions": { "calcs": ["last"] }
      },
      "fieldConfig": {
        "defaults": {
          "unit": "percent",
          "min": 0,
          "max": 100,
          "thresholds": {
            "mode": "absolute",
            "steps": [
              { "color": "green", "value": null },
              { "color": "yellow", "value": 60 },
              { "color": "red", "value": 80 }
            ]
          }
        }
      }
    },
    {
      "id": 62,
      "type": "timeseries",
      "title": "Connection Acquire Time",
      "gridPos": { "x": 16, "y": 91, "w": 8, "h": 6 },
      "datasource": "$datasource",
      "targets": [
        {
          "expr": "rate(hikaricp_connections_acquire_seconds_sum{job=\"$job\"}[1m]) / rate(hikaricp_connections_acquire_seconds_count{job=\"$job\"}[1m])",
          "legendFormat": "Avg Acquire Time"
        }
      ],
      "fieldConfig": {
        "defaults": { "unit": "s" }
      }
    },

    {
      "id": 800,
      "type": "row",
      "title": "‚òï JVM Metrics",
      "gridPos": { "x": 0, "y": 97, "w": 24, "h": 1 },
      "collapsed": false
    },
    {
      "id": 70,
      "type": "timeseries",
      "title": "Heap Memory Used",
      "gridPos": { "x": 0, "y": 98, "w": 6, "h": 6 },
      "datasource": "$datasource",
      "targets": [
        {
          "expr": "sum by (aws_ecs_task_id) (jvm_memory_used_bytes{job=\"$job\",area=\"heap\",aws_ecs_task_id=~\"$task_id\"})",
          "legendFormat": "{{aws_ecs_task_id}}"
        }
      ],
      "fieldConfig": {
        "defaults": { "unit": "bytes", "color": { "mode": "palette-classic" } }
      }
    },
    {
      "id": 71,
      "type": "timeseries",
      "title": "Heap Usage %",
      "gridPos": { "x": 6, "y": 98, "w": 6, "h": 6 },
      "datasource": "$datasource",
      "targets": [
        {
          "expr": "sum by (aws_ecs_task_id) (jvm_memory_used_bytes{job=\"$job\",area=\"heap\",aws_ecs_task_id=~\"$task_id\"}) / sum by (aws_ecs_task_id) (jvm_memory_max_bytes{job=\"$job\",area=\"heap\",aws_ecs_task_id=~\"$task_id\"}) * 100",
          "legendFormat": "{{aws_ecs_task_id}}"
        }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "percent",
          "thresholds": {
            "mode": "absolute",
            "steps": [
              { "color": "green", "value": null },
              { "color": "yellow", "value": 70 },
              { "color": "red", "value": 85 }
            ]
          }
        }
      }
    },
    {
      "id": 72,
      "type": "timeseries",
      "title": "Live Threads",
      "gridPos": { "x": 12, "y": 98, "w": 6, "h": 6 },
      "datasource": "$datasource",
      "targets": [
        {
          "expr": "jvm_threads_live_threads{job=\"$job\",aws_ecs_task_id=~\"$task_id\"}",
          "legendFormat": "{{aws_ecs_task_id}}"
        }
      ],
      "fieldConfig": {
        "defaults": { "unit": "short", "color": { "mode": "palette-classic" } }
      }
    },
    {
      "id": 73,
      "type": "timeseries",
      "title": "GC Pause Time",
      "gridPos": { "x": 18, "y": 98, "w": 6, "h": 6 },
      "datasource": "$datasource",
      "targets": [
        {
          "expr": "sum by (aws_ecs_task_id) (rate(jvm_gc_pause_seconds_sum{job=\"$job\",aws_ecs_task_id=~\"$task_id\"}[5m]))",
          "legendFormat": "{{aws_ecs_task_id}}"
        }
      ],
      "fieldConfig": {
        "defaults": { "unit": "s", "color": { "mode": "palette-classic" } }
      }
    }
  ]
}
